<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #005f00; text-decoration-color: #005f00}
.r2 {font-weight: bold}
.r3 {color: #000080; text-decoration-color: #000080; font-weight: bold}
.r4 {color: #87af00; text-decoration-color: #87af00; font-weight: bold}
.r5 {color: #005f00; text-decoration-color: #005f00; font-weight: bold}
.r6 {color: #7f7f7f; text-decoration-color: #7f7f7f; font-weight: bold}
.r7 {color: #000080; text-decoration-color: #000080; font-weight: bold; font-style: italic}
.r8 {color: #87af00; text-decoration-color: #87af00; font-weight: bold; font-style: italic}
.r9 {color: #005f00; text-decoration-color: #005f00; font-weight: bold; font-style: italic}
.r10 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r11 {color: #000080; text-decoration-color: #000080}
.r12 {color: #87af00; text-decoration-color: #87af00}
.r13 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r14 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r15 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r16 {background-color: #f8f8f8}
.r17 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r18 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r19 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r20 {color: #800000; text-decoration-color: #800000; font-weight: bold}
.r21 {font-style: italic}
.r22 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8}
.r23 {color: #3d7b7b; text-decoration-color: #3d7b7b; background-color: #f8f8f8; font-style: italic}
.r24 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8}
.r25 {color: #a45a77; text-decoration-color: #a45a77; background-color: #f8f8f8; font-weight: bold}
.r26 {color: #cb3f38; text-decoration-color: #cb3f38; background-color: #f8f8f8; font-weight: bold}
.r27 {color: #bbbbbb; text-decoration-color: #bbbbbb; background-color: #f8f8f8}
.r28 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8; font-style: italic}
.r29 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r30 {color: #19177c; text-decoration-color: #19177c; background-color: #f8f8f8}
.r31 {color: #000080; text-decoration-color: #000080; text-decoration: underline}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<body>
    <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><code style="font-family:inherit">                           Memory usage: <span class="r1">▅▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁</span> (max: 2.224 GB, growth rate:   0%)                            
                   /home/nmiklaucic/cdv/scripts/profile.py: % of time = 100.00% (7m:49.131s) out of 7m:49.131s.                    
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/scripts/profile.py            </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.train_e_form</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig, run_using</span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> cfgparsing</span><span class="r16">                   </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(</span><span class="r18">&#x27;configs/mace.toml&#x27;</span><span class="r14">, </span><span class="r18">&#x27;r&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> cfg:</span><span class="r16">       </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    conf </span><span class="r19">=</span><span class="r14"> cfgparsing</span><span class="r19">.</span><span class="r14">load(MainConfig, cfg)</span><span class="r16">       </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    7 </span>│<span class="r20">   16%</span><span class="r11"> </span>│<span class="r20">   70%</span><span class="r11"> </span>│<span class="r11">  13% </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">run_using_dashboard(conf)</span><span class="r16">                         </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
<span class="r21">                       /home/nmiklaucic/cdv/cdv/config.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                        </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/config.py                 </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> cached_property</span><span class="r16">             </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">logging</span><span class="r16">                                    </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">enum</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Enum</span><span class="r16">                             </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pathlib</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Path</span><span class="r16">                          </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Any, Callable, Literal, Mapping</span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  99%  </span>│<span class="r1">   80M </span>│<span class="r1">▁▁▁▁▁▁▁▁       </span>│<span class="r12">     2 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">e3nn_jax</span><span class="r16">                                   </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">optax</span><span class="r16">                                      </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                                   </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> linen </span><span class="r13">as</span><span class="r14"> nn</span><span class="r16">                      </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax.struct</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> dataclass</span><span class="r16">                 </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pyrallis.fields</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> field</span><span class="r16">                 </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1"> 100%  </span>│<span class="r1">  130M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁   2% </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">eins.elementwise</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> ElementwiseOp</span><span class="r16">        </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">eins</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> ElementwiseOps </span><span class="r13">as</span><span class="r14"> E</span><span class="r16">              </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> layers</span><span class="r16">                            </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.diffusion</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> DiffusionBackbone, Diffu</span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.diled</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Category, DiLED, EFormCatego</span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.encoder</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Downsample, ReduceSpeciesE</span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.gnn</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> (</span><span class="r16">                             </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    GN,</span><span class="r16">                                           </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    OldBessel1DBasis,</span><span class="r16">                             </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    Bessel2DBasis,</span><span class="r16">                                </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    DimeNetPP,</span><span class="r16">                                    </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    DimeNetPPOutput,</span><span class="r16">                              </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    Fishnet,</span><span class="r16">                                      </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    GaussBasis,</span><span class="r16">                                   </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    InputEncoder,</span><span class="r16">                                 </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    LearnedSpecEmb,</span><span class="r16">                               </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    MLPMessagePassing,</span><span class="r16">                            </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    NodeAggReadout,</span><span class="r16">                               </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    SegmentReduction,</span><span class="r16">                             </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    TripletAngleEmbedding,</span><span class="r16">                        </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">)</span><span class="r16">                                                 </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.layers</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Identity, LazyInMLP, MLPMix</span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.mace</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MaceModel</span><span class="r16">                    </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.mlp_mixer</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MLPMixerRegressor, O3Ima</span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> ELEM_VALS</span><span class="r16">                   </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.vae</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> VAE, Decoder, Encoder, LatentS</span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">pyrallis</span><span class="r19">.</span><span class="r14">set_config_type(</span><span class="r18">&#x27;toml&#x27;</span><span class="r14">)</span><span class="r16">                  </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">LogConfig</span><span class="r14">:</span><span class="r16">                                  </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    log_dir: Path </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;logs/&#x27;</span><span class="r14">)</span><span class="r16">                 </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    exp_name: Optional[</span><span class="r17">str</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># How many times to make a log each epoch.</span><span class="r16">    </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># 208 = 2^4 * 13 steps per epoch with batch of</span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    logs_per_epoch: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">8</span><span class="r16">                       </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Checkpoint every n epochs:</span><span class="r16">                  </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    epochs_per_ckpt: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                      </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">DataConfig</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># The name of the dataset to use.</span><span class="r16">             </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dataset_name: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;jarvis_dft3d_cleaned&#x27;</span><span class="r16">    </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Folder of raw data files.</span><span class="r16">                   </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    raw_data_folder: Path </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;data/&#x27;</span><span class="r14">)</span><span class="r16">         </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Folder of processed data files.</span><span class="r16">             </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data_folder: Path </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;precomputed/&#x27;</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Seed for dataset shuffling. Controls the ord</span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    shuffle_seed: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1618</span><span class="r16">                      </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Train split.</span><span class="r16">                                </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    train_split: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">22</span><span class="r16">                         </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Test split.</span><span class="r16">                                 </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    test_split: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                           </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Valid split.</span><span class="r16">                                </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    valid_split: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                          </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of nodes in each batch to pad to.</span><span class="r16">    </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    batch_n_nodes: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">512</span><span class="r16">                      </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of edges in each batch to pad to.</span><span class="r16">    </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    batch_n_edges: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">9872</span><span class="r16">                     </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of graphs in each batch to pad to.</span><span class="r16">   </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    batch_n_graphs: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">64</span><span class="r16">                      </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">graph_shape</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">tuple</span><span class="r14">[</span><span class="r17">int</span><span class="r14">, </span><span class="r17">int</span><span class="r14">, </span><span class="r17">int</span><span class="r14">]:</span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> (</span><span class="r17">self</span><span class="r19">.</span><span class="r14">batch_n_nodes, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">batch_n_e</span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">metadata</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Mapping[</span><span class="r17">str</span><span class="r14">, Any]:</span><span class="r16">      </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">import</span><span class="r14"> </span><span class="r15">json</span><span class="r16">                               </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">dataset_folder </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;metadata.</span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            metadata </span><span class="r19">=</span><span class="r14"> json</span><span class="r19">.</span><span class="r14">load(metadata)</span><span class="r16">        </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> metadata</span><span class="r16">                           </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__post_init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                      </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_splits </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">train_split </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_</span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_batches </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metadata[</span><span class="r18">&#x27;data_size&#x27;</span><span class="r14">] </span><span class="r19">/</span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> num_batches </span><span class="r19">%</span><span class="r14"> num_splits </span><span class="r19">!=</span><span class="r14"> </span><span class="r19">0</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            msg </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;Data is split </span><span class="r25">{</span><span class="r14">num_splits</span><span class="r25">}</span><span class="r18"> way</span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(msg)</span><span class="r16">                 </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">dataset_folder</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Path:</span><span class="r16">             </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Folder where dataset-specific files are</span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data_folder </span><span class="r19">/</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dataset_nam</span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">num_species</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">                 </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Number of unique elements.&quot;&quot;&quot;</span><span class="r16">          </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">metadata[</span><span class="r18">&#x27;elements&#x27;</span><span class="r14">])</span><span class="r16">     </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">LoggingLevel</span><span class="r14">(Enum):</span><span class="r16">                         </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;The logging level.&quot;&quot;&quot;</span><span class="r16">                      </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    debug </span><span class="r19">=</span><span class="r14"> logging</span><span class="r19">.</span><span class="r14">DEBUG</span><span class="r16">                         </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    info </span><span class="r19">=</span><span class="r14"> logging</span><span class="r19">.</span><span class="r14">INFO</span><span class="r16">                           </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    warning </span><span class="r19">=</span><span class="r14"> logging</span><span class="r19">.</span><span class="r14">WARNING</span><span class="r16">                     </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    error </span><span class="r19">=</span><span class="r14"> logging</span><span class="r19">.</span><span class="r14">ERROR</span><span class="r16">                         </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    critical </span><span class="r19">=</span><span class="r14"> logging</span><span class="r19">.</span><span class="r14">CRITICAL</span><span class="r16">                   </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">CLIConfig</span><span class="r14">:</span><span class="r16">                                  </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Verbosity of output.</span><span class="r16">                        </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    verbosity: LoggingLevel </span><span class="r19">=</span><span class="r14"> LoggingLevel</span><span class="r19">.</span><span class="r14">info</span><span class="r16">   </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Whether to show progress bars.</span><span class="r16">              </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    show_progress: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                    </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">set_up_logging</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                     </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">from</span><span class="r14"> </span><span class="r15">rich.logging</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> RichHandler</span><span class="r16">      </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">from</span><span class="r14"> </span><span class="r15">rich.pretty</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> install </span><span class="r13">as</span><span class="r14"> pretty_</span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">from</span><span class="r14"> </span><span class="r15">rich.traceback</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> install </span><span class="r13">as</span><span class="r14"> trac</span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pretty_install(crop</span><span class="r19">=</span><span class="r13">True</span><span class="r14">, max_string</span><span class="r19">=100</span><span class="r14">, </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        traceback_install(show_locals</span><span class="r19">=</span><span class="r13">False</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">import</span><span class="r14"> </span><span class="r15">flax.traceback_util</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">ftu</span><span class="r16">         </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ftu</span><span class="r19">.</span><span class="r14">hide_flax_in_tracebacks()</span><span class="r16">             </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        logging</span><span class="r19">.</span><span class="r14">basicConfig(</span><span class="r16">                      </span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            level</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">verbosity</span><span class="r19">.</span><span class="r14">value,</span><span class="r16">           </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">format</span><span class="r19">=</span><span class="r18">&#x27;</span><span class="r25">%(message)s</span><span class="r18">&#x27;</span><span class="r14">,</span><span class="r16">                 </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            datefmt</span><span class="r19">=</span><span class="r18">&#x27;[</span><span class="r25">%X</span><span class="r18">]&#x27;</span><span class="r14">,</span><span class="r16">                       </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            handlers</span><span class="r19">=</span><span class="r14">[</span><span class="r16">                            </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                RichHandler(</span><span class="r16">                      </span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    rich_tracebacks</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">        </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    show_time</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">              </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    show_level</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">             </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    show_path</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">              </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ],</span><span class="r16">                                    </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">DeviceConfig</span><span class="r14">:</span><span class="r16">                               </span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Either &#x27;cpu&#x27;, &#x27;gpu&#x27;, or &#x27;tpu&#x27;</span><span class="r16">               </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    device: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;gpu&#x27;</span><span class="r16">                           </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Limits the number of GPUs used. 0 means no l</span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_gpus: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                             </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># IDs of GPUs to use.</span><span class="r16">                         </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    gpu_ids: </span><span class="r17">list</span><span class="r14">[</span><span class="r17">int</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r17">lis</span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">devices</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                            </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        devs </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">devices(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">device)</span><span class="r16">           </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">device </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;gpu&#x27;</span><span class="r14"> </span><span class="r29">and</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_gpus </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            idx </span><span class="r19">=</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(</span><span class="r17">range</span><span class="r14">(</span><span class="r17">len</span><span class="r14">(devs)))</span><span class="r16">          </span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            order </span><span class="r19">=</span><span class="r14"> [x </span><span class="r13">for</span><span class="r14"> x </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">gpu_ids </span><span class="r13">if</span><span class="r14"> x </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x </span><span class="r13">for</span><span class="r14"> x </span><span class="r29">in</span><span class="r14"> idx </span><span class="r13">if</span><span class="r14"> x </span><span class="r29">not</span><span class="r14"> </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">gp</span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ]</span><span class="r16">                                     </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            devs </span><span class="r19">=</span><span class="r14"> [devs[i] </span><span class="r13">for</span><span class="r14"> i </span><span class="r29">in</span><span class="r14"> order[: </span><span class="r17">self</span><span class="r19">.</span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> devs</span><span class="r16">                               </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">jax_device</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                         </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        devs </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">devices()</span><span class="r16">                     </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(devs) </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r19">1</span><span class="r14">:</span><span class="r16">                         </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">from</span><span class="r14"> </span><span class="r15">jax.experimental</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> mesh_util</span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">from</span><span class="r14"> </span><span class="r15">jax.sharding</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Mesh, Partiti</span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            jax</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">update(</span><span class="r18">&#x27;jax_threefry_partit</span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            d </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(devs)</span><span class="r16">                         </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            mesh </span><span class="r19">=</span><span class="r14"> Mesh(mesh_utils</span><span class="r19">.</span><span class="r14">create_device_m</span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sharding </span><span class="r19">=</span><span class="r14"> NamedSharding(mesh, P(</span><span class="r18">&#x27;batc</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># replicated_sharding = NamedSharding(</span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> sharding</span><span class="r16">                       </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> devs[</span><span class="r19">0</span><span class="r14">]</span><span class="r16">                        </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__post_init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                      </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">import</span><span class="r14"> </span><span class="r15">os</span><span class="r16">                                 </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        os</span><span class="r19">.</span><span class="r14">environ[</span><span class="r18">&#x27;XLA_FLAGS&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;--xla_force_hos</span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># if self.max_gpus == 1:</span><span class="r16">                  </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     jax.config.update(&#x27;jax_default_devic</span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Layer</span><span class="r14">:</span><span class="r16">                                      </span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Serializable layer representation. Works fo</span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># The name of the layer.</span><span class="r16">                      </span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    name: </span><span class="r17">str</span><span class="r16">                                     </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Callable:</span><span class="r16">                  </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Makes a new layer with the given values</span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">name </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;Identity&#x27;</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> Identity()</span><span class="r16">                     </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> module </span><span class="r29">in</span><span class="r14"> (nn, layers):</span><span class="r16">               </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">hasattr</span><span class="r14">(module, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">name):</span><span class="r16">        </span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                layer </span><span class="r19">=</span><span class="r14"> </span><span class="r17">getattr</span><span class="r14">(module, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">name)</span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(layer, nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">  </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">return</span><span class="r14"> </span><span class="r17">getattr</span><span class="r14">(module, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">na</span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r23"># something like relu</span><span class="r16">         </span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">return</span><span class="r14"> layer</span><span class="r16">                  </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        msg </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;Could not find </span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">name</span><span class="r25">}</span><span class="r18"> in flax</span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(msg)</span><span class="r16">                     </span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MLPConfig</span><span class="r14">:</span><span class="r16">                                  </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Settings for MLP configuration.&quot;&quot;&quot;</span><span class="r16">         </span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Inner dimensions for the MLP.</span><span class="r16">               </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    inner_dims: </span><span class="r17">list</span><span class="r14">[</span><span class="r17">int</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Inner activation.</span><span class="r16">                           </span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    activation: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;swish&#x27;</span><span class="r16">                     </span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Final activation.</span><span class="r16">                           </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    final_activation: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;Identity&#x27;</span><span class="r16">            </span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Output dimension. None means the same size a</span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out_dim: Optional[</span><span class="r17">int</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                 </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Dropout.</span><span class="r16">                                    </span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dropout: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.0</span><span class="r16">                          </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Whether to add residual.</span><span class="r16">                    </span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    residual: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                        </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of heads, for equivariant layer.</span><span class="r16">     </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_heads: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                            </span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> LazyInMLP:</span><span class="r16">                 </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Builds the head from the config.&quot;&quot;&quot;</span><span class="r16">    </span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> LazyInMLP(</span><span class="r16">                         </span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            inner_dims</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">inner_dims,</span><span class="r16">           </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            out_dim</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">out_dim,</span><span class="r16">                 </span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            inner_act</span><span class="r19">=</span><span class="r14">Layer(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation)</span><span class="r19">.</span><span class="r14">build</span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            final_act</span><span class="r19">=</span><span class="r14">Layer(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">final_activation)</span>  
 <span class="r10">  269 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            dropout_rate</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">dropout,</span><span class="r16">            </span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            residual</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">residual,</span><span class="r16">               </span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">GaussBasisConfig</span><span class="r14">:</span><span class="r16">                           </span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    lo: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                                 </span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hi: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">8</span><span class="r16">                                 </span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    sd: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                                 </span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    emb: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">32</span><span class="r16">                                 </span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> GaussBasis:</span><span class="r16">                </span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> GaussBasis(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">lo, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">hi, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">s</span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">SegmentReductionConfig</span><span class="r14">:</span><span class="r16">                     </span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    reduction: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mean&#x27;</span><span class="r16">                       </span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    kind: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;simple&#x27;</span><span class="r16">                          </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fishnet_mod: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fishnet_inner: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">32</span><span class="r16">                       </span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> SegmentReduction:</span><span class="r16">          </span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">kind </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;fishnet&#x27;</span><span class="r14">:</span><span class="r16">                </span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> Fishnet(</span><span class="r16">                       </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">reduction, net_templ</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">fis</span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">kind </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;simple&#x27;</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> SegmentReduction(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">reduction</span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(</span><span class="r18">&#x27;Unknown kind&#x27;</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">CoGNConfig</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Edge initial embeddings.</span><span class="r16">                    </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dist_enc: GaussBasisConfig </span><span class="r19">=</span><span class="r14"> field(default_fac</span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Node embedding dimension.</span><span class="r16">                   </span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_dim: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">128</span><span class="r16">                           </span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Edge embedding dimension:</span><span class="r16">                   </span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    edge_dim: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">128</span><span class="r16">                           </span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># MLP for message passing.</span><span class="r16">                    </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    msg_layer: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r13">l</span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># MLP for node update.</span><span class="r16">                        </span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_layer: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of processing blocks.</span><span class="r16">                </span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_blocks: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">5</span><span class="r16">                           </span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Reduction for node update.</span><span class="r16">                  </span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_update_reduction: SegmentReductionConfig </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Node reduction for readout.</span><span class="r16">                 </span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_agg_reduction: SegmentReductionConfig </span><span class="r19">=</span><span class="r14"> f</span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Readout head</span><span class="r16">                                </span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_head: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factor</span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, num_species: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> GN:</span><span class="r16">      </span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        input_enc </span><span class="r19">=</span><span class="r14"> InputEncoder(</span><span class="r16">                 </span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dist_enc</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16">                </span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            nn</span><span class="r19">.</span><span class="r14">Dense(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">edge_dim),</span><span class="r16">              </span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            LearnedSpecEmb(num_species, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_</span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        block_templ </span><span class="r19">=</span><span class="r14"> MLPMessagePassing(</span><span class="r16">          </span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_reduction</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_update_reduct</span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_emb</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_dim,</span><span class="r16">               </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            msg_dim</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_dim,</span><span class="r16">                </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            msg_templ</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">msg_layer</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16">     </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_templ</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_layer</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16">   </span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        readout </span><span class="r19">=</span><span class="r14"> NodeAggReadout(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">readout_head</span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> GN(input_enc, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_blocks, bloc</span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">SpeciesEmbedConfig</span><span class="r14">:</span><span class="r16">                         </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Remember that this network will be applied f</span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># data that downsamplers or any downstream enc</span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># flop-intensive parameters.</span><span class="r16">                  </span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Embedding dimension of the species.</span><span class="r16">         </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    species_embed_dim: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">32</span><span class="r16">                   </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># MLP that embeds species embed + density to a</span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    spec_embed: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Whether to use the above MLP config or a sim</span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    use_simple_weighting: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">            </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, data: DataConfig) </span><span class="r19">-&gt;</span><span class="r14"> ReduceSpe</span>  
 <span class="r10">  355 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> ReduceSpeciesEmbed(</span><span class="r16">                </span>  
 <span class="r10">  356 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            SpeciesEmbed(</span><span class="r16">                         </span>  
 <span class="r10">  357 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">len</span><span class="r14">(data</span><span class="r19">.</span><span class="r14">metadata[</span><span class="r18">&#x27;elements&#x27;</span><span class="r14">]),</span><span class="r16">   </span>  
 <span class="r10">  358 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">species_embed_dim,</span><span class="r16">           </span>  
 <span class="r10">  359 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">spec_embed</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16">          </span>  
 <span class="r10">  360 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">use_simple_weighting,</span><span class="r16">        </span>  
 <span class="r10">  361 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ),</span><span class="r16">                                    </span>  
 <span class="r10">  362 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            name</span><span class="r19">=</span><span class="r18">&#x27;species_embed&#x27;</span><span class="r14">,</span><span class="r16">                 </span>  
 <span class="r10">  363 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  364 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  365 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  366 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  367 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">DimeNetPPConfig</span><span class="r14">:</span><span class="r16">                            </span>  
 <span class="r10">  368 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_radial: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">8</span><span class="r16">                           </span>  
 <span class="r10">  369 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_spherical: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">7</span><span class="r16">                        </span>  
 <span class="r10">  370 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    envelope_exp: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">6</span><span class="r16">                         </span>  
 <span class="r10">  371 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    cutoff: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">7</span><span class="r16">                             </span>  
 <span class="r10">  372 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    freq_trainable: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                   </span>  
 <span class="r10">  373 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    species_emb: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">64</span><span class="r16">                         </span>  
 <span class="r10">  374 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_interaction_blocks: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">4</span><span class="r16">               </span>  
 <span class="r10">  375 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    act: Layer </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r13">lambda</span><span class="r14">: Lay</span>  
 <span class="r10">  376 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    initial_embed: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_facto</span>  
 <span class="r10">  377 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_dist_enc: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factor</span>  
 <span class="r10">  378 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_ang_enc: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span>  
 <span class="r10">  379 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_down_proj: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_facto</span>  
 <span class="r10">  380 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_up_proj: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span>  
 <span class="r10">  381 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_pre_skip: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factor</span>  
 <span class="r10">  382 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    int_post_skip: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_facto</span>  
 <span class="r10">  383 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    edge2node: SegmentReductionConfig </span><span class="r19">=</span><span class="r14"> field(defa</span>  
 <span class="r10">  384 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node2graph: SegmentReductionConfig </span><span class="r19">=</span><span class="r14"> field(def</span>  
 <span class="r10">  385 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    head: MLPConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r13">lambda</span>  
 <span class="r10">  386 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  387 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, num_species: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> DimeNetPP</span>  
 <span class="r10">  388 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        distance_enc </span><span class="r19">=</span><span class="r14"> OldBessel1DBasis(</span><span class="r16">          </span>  
 <span class="r10">  389 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_basis</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_radial,</span><span class="r16">            </span>  
 <span class="r10">  390 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cutoff</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">cutoff,</span><span class="r16">                   </span>  
 <span class="r10">  391 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            envelope_exp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">envelope_exp,</span><span class="r16">       </span>  
 <span class="r10">  392 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            freq_trainable</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">freq_trainable,</span><span class="r16">   </span>  
 <span class="r10">  393 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  394 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  395 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> DimeNetPP(</span><span class="r16">                         </span>  
 <span class="r10">  396 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            input_enc</span><span class="r19">=</span><span class="r14">InputEncoder(</span><span class="r16">               </span>  
 <span class="r10">  397 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                distance_enc</span><span class="r19">=</span><span class="r14">distance_enc</span><span class="r19">.</span><span class="r14">copy(),</span><span class="r16"> </span>  
 <span class="r10">  398 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                distance_projector</span><span class="r19">=</span><span class="r14">Identity(),</span><span class="r16">    </span>  
 <span class="r10">  399 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                species_emb</span><span class="r19">=</span><span class="r14">LearnedSpecEmb(num_spe</span>  
 <span class="r10">  400 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ),</span><span class="r16">                                    </span>  
 <span class="r10">  401 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sbf</span><span class="r19">=</span><span class="r14">TripletAngleEmbedding(</span><span class="r16">            </span>  
 <span class="r10">  402 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                Bessel2DBasis(</span><span class="r16">                    </span>  
 <span class="r10">  403 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    num_radial</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_radial,</span><span class="r16">   </span>  
 <span class="r10">  404 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    num_spherical</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_spheric</span>  
 <span class="r10">  405 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    cutoff</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">cutoff,</span><span class="r16">           </span>  
 <span class="r10">  406 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    envelope_exp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">envelope_exp</span>  
 <span class="r10">  407 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  408 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ),</span><span class="r16">                                    </span>  
 <span class="r10">  409 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            initial_embed_mlp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">initial_embed</span><span class="r19">.</span><span class="r14">b</span>  
 <span class="r10">  410 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            output</span><span class="r19">=</span><span class="r14">DimeNetPPOutput(</span><span class="r16">               </span>  
 <span class="r10">  411 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                head</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">head</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16">           </span>  
 <span class="r10">  412 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                edge2node</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">edge2node</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16"> </span>  
 <span class="r10">  413 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                node2graph</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node2graph</span><span class="r19">.</span><span class="r14">build()</span>  
 <span class="r10">  414 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ),</span><span class="r16">                                    </span>  
 <span class="r10">  415 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_dist_enc</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_dist_enc</span><span class="r19">.</span><span class="r14">build()</span>  
 <span class="r10">  416 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_ang_enc</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_ang_enc</span><span class="r19">.</span><span class="r14">build(),</span><span class="r16"> </span>  
 <span class="r10">  417 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_down_proj_mlp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_down_proj</span><span class="r19">.</span><span class="r14">b</span>  
 <span class="r10">  418 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_up_proj_mlp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_up_proj</span><span class="r19">.</span><span class="r14">build</span>  
 <span class="r10">  419 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_pre_skip_mlp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_pre_skip</span><span class="r19">.</span><span class="r14">bui</span>  
 <span class="r10">  420 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            int_post_skip_mlp</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">int_post_skip</span><span class="r19">.</span><span class="r14">b</span>  
 <span class="r10">  421 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_interaction_blocks</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_intera</span>  
 <span class="r10">  422 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  423 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  424 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  425 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  426 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MACEConfig</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  427 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">3</span><span class="r16">                              </span>  
 <span class="r10">  428 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_interactions: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                     </span>  
 <span class="r10">  429 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;256x0e + 256x1o&#x27;</span><span class="r16">        </span>  
 <span class="r10">  430 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># hidden_irreps = &#x27;16x0e + 16x1o&#x27;</span><span class="r16">             </span>  
 <span class="r10">  431 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">3</span><span class="r14">  </span><span class="r23"># 4 is better but 5x slo</span>  
 <span class="r10">  432 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_mlp_irreps: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;16x0e&#x27;</span><span class="r16">             </span>  
 <span class="r10">  433 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    interaction_reduction: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mean&#x27;</span><span class="r16">           </span>  
 <span class="r10">  434 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_reduction: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mean&#x27;</span><span class="r16">                  </span>  
 <span class="r10">  435 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  436 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build</span><span class="r14">(</span><span class="r16">                                    </span>  
 <span class="r10">  437 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">, num_species: </span><span class="r17">int</span><span class="r14">, output_graph_irrep</span>  
 <span class="r10">  438 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> MaceModel:</span><span class="r16">                               </span>  
 <span class="r10">  439 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> MaceModel(</span><span class="r16">                         </span>  
 <span class="r10">  440 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            max_ell</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_ell,</span><span class="r16">                 </span>  
 <span class="r10">  441 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_interactions</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_interactions</span>  
 <span class="r10">  442 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            hidden_irreps</span><span class="r19">=</span><span class="r17">str</span><span class="r14">(e3nn_jax</span><span class="r19">.</span><span class="r14">Irreps(</span><span class="r17">self</span>  
 <span class="r10">  443 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            readout_mlp_irreps</span><span class="r19">=</span><span class="r17">str</span><span class="r14">(e3nn_jax</span><span class="r19">.</span><span class="r14">Irreps</span>  
 <span class="r10">  444 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            output_graph_irreps</span><span class="r19">=</span><span class="r17">str</span><span class="r14">(e3nn_jax</span><span class="r19">.</span><span class="r14">Irrep</span>  
 <span class="r10">  445 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            output_node_irreps</span><span class="r19">=</span><span class="r17">str</span><span class="r14">(e3nn_jax</span><span class="r19">.</span><span class="r14">Irreps</span>  
 <span class="r10">  446 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> output_node_irreps</span><span class="r16">                 </span>  
 <span class="r10">  447 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,</span><span class="r16">                            </span>  
 <span class="r10">  448 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_species</span><span class="r19">=</span><span class="r14">num_species,</span><span class="r16">              </span>  
 <span class="r10">  449 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            correlation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation,</span><span class="r16">         </span>  
 <span class="r10">  450 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            interaction_reduction</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction</span>  
 <span class="r10">  451 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_reduction</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction,</span><span class="r16">   </span>  
 <span class="r10">  452 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  453 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  454 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  455 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  456 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">RegressionLossConfig</span><span class="r14">:</span><span class="r16">                       </span>  
 <span class="r10">  457 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Config defining the loss function.&quot;&quot;&quot;</span><span class="r16">      </span>  
 <span class="r10">  458 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  459 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># delta for smoother_l1_loss: the switch point</span>  
 <span class="r10">  460 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    loss_delta: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">64</span><span class="r16">                    </span>  
 <span class="r10">  461 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  462 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Whether to use RMSE loss instead.</span><span class="r16">           </span>  
 <span class="r10">  463 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    use_rmse: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                        </span>  
 <span class="r10">  464 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  465 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">smoother_l1_loss</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, preds, targets):</span><span class="r16">   </span>  
 <span class="r10">  466 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        a </span><span class="r19">=</span><span class="r14"> </span><span class="r19">-5</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">2</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">8</span><span class="r16">                            </span>  
 <span class="r10">  467 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        b </span><span class="r19">=</span><span class="r14"> </span><span class="r19">63</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">8</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">6</span><span class="r16">                            </span>  
 <span class="r10">  468 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        c </span><span class="r19">=</span><span class="r14"> </span><span class="r19">-35</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">4</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">4</span><span class="r16">                           </span>  
 <span class="r10">  469 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        d </span><span class="r19">=</span><span class="r14"> </span><span class="r19">35</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">8</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                            </span>  
 <span class="r10">  470 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        x </span><span class="r19">=</span><span class="r14"> (preds </span><span class="r19">-</span><span class="r14"> targets) </span><span class="r19">/</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">loss_delta</span><span class="r16">   </span>  
 <span class="r10">  471 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        x2 </span><span class="r19">=</span><span class="r14"> x </span><span class="r19">*</span><span class="r14"> x</span><span class="r16">                                </span>  
 <span class="r10">  472 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        x_abs </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">abs(x)</span><span class="r16">                        </span>  
 <span class="r10">  473 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        y </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">where(x_abs </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r19">1</span><span class="r14">, x2 </span><span class="r19">*</span><span class="r14"> d </span><span class="r19">+</span><span class="r14"> (x2 </span><span class="r19">*</span><span class="r14"> c </span>  
 <span class="r10">  474 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> y </span><span class="r19">*</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">loss_delta</span><span class="r16">                </span>  
 <span class="r10">  475 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  476 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">regression_loss</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, preds, targets, mask</span>  
 <span class="r10">  477 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> preds</span><span class="r19">.</span><span class="r14">shape </span><span class="r19">!=</span><span class="r14"> targets</span><span class="r19">.</span><span class="r14">shape:</span><span class="r16">          </span>  
 <span class="r10">  478 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            msg </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;Incorrect input shapes: </span><span class="r25">{</span><span class="r14">preds</span>  
 <span class="r10">  479 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(msg)</span><span class="r16">                 </span>  
 <span class="r10">  480 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> preds</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r14">:</span><span class="r16">                       </span>  
 <span class="r10">  481 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            mask </span><span class="r19">=</span><span class="r14"> mask[:, </span><span class="r13">None</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">  482 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">use_rmse:</span><span class="r16">                         </span>  
 <span class="r10">  483 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">sqrt(optax</span><span class="r19">.</span><span class="r14">losses</span><span class="r19">.</span><span class="r14">squared_e</span>  
 <span class="r10">  484 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  485 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">smoother_l1_loss(preds, ta</span>  
 <span class="r10">  486 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  487 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  488 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  489 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">LossConfig</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  490 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Config defining the loss function.&quot;&quot;&quot;</span><span class="r16">      </span>  
 <span class="r10">  491 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  492 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    reg_loss: RegressionLossConfig </span><span class="r19">=</span><span class="r14"> field(default</span>  
 <span class="r10">  493 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  494 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">regression_loss</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, preds, targets, mask</span>  
 <span class="r10">  495 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">reg_loss</span><span class="r19">.</span><span class="r14">regression_loss(preds</span>  
 <span class="r10">  496 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  497 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  498 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  499 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">TrainingConfig</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  500 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Training/optimizer parameters.&quot;&quot;&quot;</span><span class="r16">          </span>  
 <span class="r10">  501 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  502 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Loss function.</span><span class="r16">                              </span>  
 <span class="r10">  503 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    loss: LossConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">LossC</span>  
 <span class="r10">  504 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  505 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Learning rate schedule: &#x27;cosine&#x27; for warmup+</span>  
 <span class="r10">  506 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    lr_schedule_kind: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;cosine&#x27;</span><span class="r16">              </span>  
 <span class="r10">  507 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  508 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Initial learning rate, as a fraction of the </span>  
 <span class="r10">  509 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    start_lr_frac: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.1</span><span class="r16">                    </span>  
 <span class="r10">  510 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  511 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Base learning rate.</span><span class="r16">                         </span>  
 <span class="r10">  512 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    base_lr: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">4e-3</span><span class="r16">                         </span>  
 <span class="r10">  513 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  514 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Final learning rate, as a fraction of the ba</span>  
 <span class="r10">  515 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    end_lr_frac: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.04</span><span class="r16">                     </span>  
 <span class="r10">  516 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  517 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Weight decay. AdamW interpretation, so multi</span>  
 <span class="r10">  518 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    weight_decay: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.03</span><span class="r16">                    </span>  
 <span class="r10">  519 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  520 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Beta 1 for Adam.</span><span class="r16">                            </span>  
 <span class="r10">  521 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    beta_1: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.9</span><span class="r16">                           </span>  
 <span class="r10">  522 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  523 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Beta 2 for Adam.</span><span class="r16">                            </span>  
 <span class="r10">  524 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    beta_2: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0.999</span><span class="r16">                         </span>  
 <span class="r10">  525 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  526 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Nestorov momentum.</span><span class="r16">                          </span>  
 <span class="r10">  527 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    nestorov: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                         </span>  
 <span class="r10">  528 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  529 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Gradient norm clipping.</span><span class="r16">                     </span>  
 <span class="r10">  530 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_grad_norm: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1.0</span><span class="r16">                    </span>  
 <span class="r10">  531 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  532 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Schedule-free.</span><span class="r16">                              </span>  
 <span class="r10">  533 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    schedule_free: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                   </span>  
 <span class="r10">  534 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  535 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Prodigy.</span><span class="r16">                                    </span>  
 <span class="r10">  536 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    prodigy: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                         </span>  
 <span class="r10">  537 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  538 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">lr_schedule</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, num_epochs: </span><span class="r17">int</span><span class="r14">, steps_i</span>  
 <span class="r10">  539 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">lr_schedule_kind </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;cosine&#x27;</span><span class="r14">:</span><span class="r16">     </span>  
 <span class="r10">  540 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            base_lr </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">base_lr</span><span class="r16">                </span>  
 <span class="r10">  541 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">prodigy:</span><span class="r16">                      </span>  
 <span class="r10">  542 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                base_lr </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                       </span>  
 <span class="r10">  543 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            warmup_steps </span><span class="r19">=</span><span class="r14"> steps_in_epoch </span><span class="r19">*</span><span class="r14"> </span><span class="r17">min</span><span class="r14">(</span><span class="r19">5</span><span class="r14">,</span>  
 <span class="r10">  544 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">warmup_cosine_decay_sched</span>  
 <span class="r10">  545 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                init_value</span><span class="r19">=</span><span class="r14">base_lr </span><span class="r19">*</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">start_lr</span>  
 <span class="r10">  546 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                peak_value</span><span class="r19">=</span><span class="r14">base_lr,</span><span class="r16">               </span>  
 <span class="r10">  547 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                warmup_steps</span><span class="r19">=</span><span class="r14">warmup_steps,</span><span class="r16">        </span>  
 <span class="r10">  548 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                decay_steps</span><span class="r19">=</span><span class="r14">num_epochs </span><span class="r19">*</span><span class="r14"> steps_in_</span>  
 <span class="r10">  549 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                end_value</span><span class="r19">=</span><span class="r14">base_lr </span><span class="r19">*</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">end_lr_fr</span>  
 <span class="r10">  550 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  551 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  552 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(</span><span class="r18">&#x27;Other learning rate </span>  
 <span class="r10">  553 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  554 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">optimizer</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, learning_rate):</span><span class="r16">           </span>  
 <span class="r10">  555 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">prodigy:</span><span class="r16">                          </span>  
 <span class="r10">  556 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            tx </span><span class="r19">=</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">contrib</span><span class="r19">.</span><span class="r14">prodigy(</span><span class="r16">           </span>  
 <span class="r10">  557 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                learning_rate,</span><span class="r16">                    </span>  
 <span class="r10">  558 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                betas</span><span class="r19">=</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">beta_1, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">beta_2),</span><span class="r16"> </span>  
 <span class="r10">  559 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                weight_decay</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">weight_decay,</span><span class="r16">   </span>  
 <span class="r10">  560 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                estim_lr_coef</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">base_lr </span><span class="r19">/</span><span class="r14"> </span><span class="r19">4e-3</span><span class="r14">,</span>  
 <span class="r10">  561 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  562 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  563 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            tx </span><span class="r19">=</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">adamw(</span><span class="r16">                     </span>  
 <span class="r10">  564 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                learning_rate,</span><span class="r16">                    </span>  
 <span class="r10">  565 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                b1</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">beta_1,</span><span class="r16">                   </span>  
 <span class="r10">  566 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                b2</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">beta_2,</span><span class="r16">                   </span>  
 <span class="r10">  567 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                weight_decay</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">weight_decay,</span><span class="r16">   </span>  
 <span class="r10">  568 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                nesterov</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">nestorov,</span><span class="r16">           </span>  
 <span class="r10">  569 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  570 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">chain(tx, optax</span><span class="r19">.</span><span class="r14">clip_by_globa</span>  
 <span class="r10">  571 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  572 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  573 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@dataclass</span><span class="r16">                                        </span>  
 <span class="r10">  574 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MainConfig</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  575 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># The batch size. Should be a multiple of data</span>  
 <span class="r10">  576 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    batch_size: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">63</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                      </span>  
 <span class="r10">  577 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  578 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of stacked batches to process at once</span>  
 <span class="r10">  579 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># for mocking multi-GPU training batches with </span>  
 <span class="r10">  580 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    stack_size: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                           </span>  
 <span class="r10">  581 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  582 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Use profiling.</span><span class="r16">                              </span>  
 <span class="r10">  583 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    do_profile: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                      </span>  
 <span class="r10">  584 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  585 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of epochs.</span><span class="r16">                           </span>  
 <span class="r10">  586 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_epochs: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">20</span><span class="r16">                          </span>  
 <span class="r10">  587 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  588 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Folder to initialize all parameters from, if</span>  
 <span class="r10">  589 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    restart_from: Optional[Path] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">           </span>  
 <span class="r10">  590 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  591 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Folder to initialize the encoders and downsa</span>  
 <span class="r10">  592 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    encoder_start_from: Optional[Path] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">     </span>  
 <span class="r10">  593 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  594 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data: DataConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">DataC</span>  
 <span class="r10">  595 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    cli: CLIConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">CLIConf</span>  
 <span class="r10">  596 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    device: DeviceConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">D</span>  
 <span class="r10">  597 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    log: LogConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">LogConf</span>  
 <span class="r10">  598 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    train: TrainingConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span>  
 <span class="r10">  599 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    cogn: CoGNConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">CoGNC</span>  
 <span class="r10">  600 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dimenet: DimeNetPPConfig </span><span class="r19">=</span><span class="r14"> field(default_facto</span>  
 <span class="r10">  601 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    mace: MACEConfig </span><span class="r19">=</span><span class="r14"> field(default_factory</span><span class="r19">=</span><span class="r14">MACEC</span>  
 <span class="r10">  602 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  603 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    regressor: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;dimenet&#x27;</span><span class="r16">                    </span>  
 <span class="r10">  604 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  605 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    task: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;e_form&#x27;</span><span class="r16">                          </span>  
 <span class="r10">  606 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  607 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__post_init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                      </span>  
 <span class="r10">  608 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">batch_size </span><span class="r19">%</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">metadata[</span><span class="r18">&#x27;b</span>  
 <span class="r10">  609 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(</span><span class="r16">                     </span>  
 <span class="r10">  610 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r18">&#x27;Training batch size should be mul</span>  
 <span class="r10">  611 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">self</span><span class="r19">.</span><span class="r14">batch_size, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">met</span>  
 <span class="r10">  612 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  613 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  614 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  615 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">cli</span><span class="r19">.</span><span class="r14">set_up_logging()</span><span class="r16">                 </span>  
 <span class="r10">  616 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">import</span><span class="r14"> </span><span class="r15">warnings</span><span class="r16">                           </span>  
 <span class="r10">  617 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  618 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        warnings</span><span class="r19">.</span><span class="r14">filterwarnings(message</span><span class="r19">=</span><span class="r18">&#x27;Explicitl</span>  
 <span class="r10">  619 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">log</span><span class="r19">.</span><span class="r14">log_dir</span><span class="r19">.</span><span class="r14">exists():</span><span class="r16">         </span>  
 <span class="r10">  620 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(</span><span class="r18">f&#x27;Log directory </span><span class="r25">{</span><span class="r17">self</span>  
 <span class="r10">  621 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  622 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">from</span><span class="r14"> </span><span class="r15">jax.experimental.compilation_cache.co</span>  
 <span class="r10">  623 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  624 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        set_cache_dir(</span><span class="r18">&#x27;/tmp/jax_comp_cache&#x27;</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">  625 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  626 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  627 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">train_batch_multiple</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">        </span>  
 <span class="r10">  628 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;How many files should be loaded per tra</span>  
 <span class="r10">  629 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">batch_size </span><span class="r19">//</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">metada</span>  
 <span class="r10">  630 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  631 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># def build_diffusion(self) -&gt; DiffusionModel:</span>  
 <span class="r10">  632 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     diffuser = MLPMixerDiffuser(</span><span class="r16">            </span>  
 <span class="r10">  633 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#         embed_dims=self.diffusion.embed_dim,</span>  
 <span class="r10">  634 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#         embed_max_freq=self.diffusion.unet.e</span>  
 <span class="r10">  635 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#         embed_min_freq=self.diffusion.unet.e</span>  
 <span class="r10">  636 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#         mixer=self.build_mlp().mixer,</span><span class="r16">       </span>  
 <span class="r10">  637 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     )</span><span class="r16">                                       </span>  
 <span class="r10">  638 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     return self.diffusion.diffusion.build(di</span>  
 <span class="r10">  639 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  640 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build_vae</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                          </span>  
 <span class="r10">  641 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># output irreps gets changed</span><span class="r16">              </span>  
 <span class="r10">  642 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> VAE(</span><span class="r16">                               </span>  
 <span class="r10">  643 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            Encoder(</span><span class="r16">                              </span>  
 <span class="r10">  644 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mace</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">num_spec</span>  
 <span class="r10">  645 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                latent_dim</span><span class="r19">=256</span><span class="r14">,</span><span class="r16">                   </span>  
 <span class="r10">  646 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                latent_space</span><span class="r19">=</span><span class="r14">LatticeVAE(),</span><span class="r16">        </span>  
 <span class="r10">  647 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ),</span><span class="r16">                                    </span>  
 <span class="r10">  648 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            PropertyPredictor(LazyInMLP([</span><span class="r19">256</span><span class="r14">], dro</span>  
 <span class="r10">  649 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            Decoder(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">mace</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">num_</span>  
 <span class="r10">  650 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            prop_reg_loss</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">loss</span><span class="r19">.</span><span class="r14">regressi</span>  
 <span class="r10">  651 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  652 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  653 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build_regressor</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                    </span>  
 <span class="r10">  654 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">regressor </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;cogn&#x27;</span><span class="r14">:</span><span class="r16">              </span>  
 <span class="r10">  655 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">cogn</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">num_s</span>  
 <span class="r10">  656 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">regressor </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;dimenet&#x27;</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">  657 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dimenet</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">nu</span>  
 <span class="r10">  658 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">regressor </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;mace&#x27;</span><span class="r14">:</span><span class="r16">            </span>  
 <span class="r10">  659 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mace</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">num_s</span>  
 <span class="r10">  660 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  661 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r16">                      </span>  
 <span class="r10">  662 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  663 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">build_diled</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                        </span>  
 <span class="r10">  664 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">diled</span><span class="r19">.</span><span class="r14">build(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data)</span><span class="r16">        </span>  
 <span class="r10">  665 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  666 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  667 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">if</span><span class="r14"> </span><span class="r30">__name__</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;__main__&#x27;</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  668 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">pathlib</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Path</span><span class="r16">                      </span>  
 <span class="r10">  669 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  670 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">rich.prompt</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Confirm</span><span class="r16">               </span>  
 <span class="r10">  671 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  672 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> Confirm</span><span class="r19">.</span><span class="r14">ask(</span><span class="r18">&#x27;Generate configs/defaults.toml</span>  
 <span class="r10">  673 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        default_path </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;configs&#x27;</span><span class="r14">) </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;defaults</span>  
 <span class="r10">  674 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        minimal_path </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;configs&#x27;</span><span class="r14">) </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;minimal.</span>  
 <span class="r10">  675 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  676 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        default </span><span class="r19">=</span><span class="r14"> MainConfig()</span><span class="r16">                    </span>  
 <span class="r10">  677 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  678 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(default_path, </span><span class="r18">&#x27;w&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> outfile:</span><span class="r16">  </span>  
 <span class="r10">  679 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            pyrallis</span><span class="r19">.</span><span class="r14">cfgparsing</span><span class="r19">.</span><span class="r14">dump(default, outf</span>  
 <span class="r10">  680 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  681 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(minimal_path, </span><span class="r18">&#x27;w&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> outfile:</span><span class="r16">  </span>  
 <span class="r10">  682 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            pyrallis</span><span class="r19">.</span><span class="r14">cfgparsing</span><span class="r19">.</span><span class="r14">dump(default, outf</span>  
 <span class="r10">  683 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  684 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> default_path</span><span class="r19">.</span><span class="r14">open(</span><span class="r18">&#x27;r&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> conf:</span><span class="r16">      </span>  
 <span class="r10">  685 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            pyrallis</span><span class="r19">.</span><span class="r14">cfgparsing</span><span class="r19">.</span><span class="r14">load(MainConfig, c</span>  
 <span class="r10">  686 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    16:   130 MB</span>                                                                                                                 
<span class="r1">(2)     7:    80 MB</span>                                                                                                                 
<span class="r21">                      /home/nmiklaucic/cdv/cdv/dashboard.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                      </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/dashboard.py              </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;Training dashboard.&quot;&quot;&quot;</span><span class="r16">                         </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">time</span><span class="r16">                                       </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">itertools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> cycle</span><span class="r16">                       </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Any</span><span class="r16">                            </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                                </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                               </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                                   </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  99%  </span>│<span class="r1">   40M </span>│<span class="r1">▁▁▁▁           </span>│<span class="r12">     1 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">rho_plus</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">rp</span><span class="r16">                             </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.app</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> App, ComposeResult</span><span class="r16">        </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.containers</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Center, Grid</span><span class="r16">       </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.reactive</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> reactive</span><span class="r16">             </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.widget</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Widget</span><span class="r16">                 </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.widgets</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> DataTable, Footer, Hea</span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual.worker</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> get_current_worker</span><span class="r16">     </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  98%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">textual_plotext</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> PlotextPlot</span><span class="r16">           </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig</span><span class="r16">                 </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.training_state</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> TrainingRun</span><span class="r16">        </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> format_scalar</span><span class="r16">               </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Losses</span><span class="r14">(PlotextPlot):</span><span class="r16">                        </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;A widget for plotting losses during trainin</span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        title: </span><span class="r17">str</span><span class="r14">,</span><span class="r16">                               </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">*</span><span class="r14">,</span><span class="r16">                                        </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        colors</span><span class="r19">=</span><span class="r14">rp</span><span class="r19">.</span><span class="r14">matplotlib</span><span class="r19">.</span><span class="r14">DARK_COLORS,</span><span class="r16">         </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        name: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r13">None</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,</span><span class="r16">                  </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">id</span><span class="r14">: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r13">None</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,  </span><span class="r23"># pylint:disable=r</span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        classes: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r13">None</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,</span><span class="r16">               </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        disabled: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r14">,</span><span class="r16">                   </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                                    </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Initialise the weather widget.</span><span class="r16">         </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        Args:</span><span class="r16">                                     </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            name: The name of the weather widget.</span><span class="r16"> </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            id: The ID of the weather widget in th</span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            classes: The CSS classes of the weathe</span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            disabled: Whether the weather widget i</span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        &quot;&quot;&quot;</span><span class="r16">                                       </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r24">__init__</span><span class="r14">(name</span><span class="r19">=</span><span class="r14">name, </span><span class="r17">id</span><span class="r19">=</span><span class="r17">id</span><span class="r14">, classes</span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_title </span><span class="r19">=</span><span class="r14"> title</span><span class="r16">                       </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_unit </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;L2 Loss&#x27;</span><span class="r16">                    </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data </span><span class="r19">=</span><span class="r14"> {}</span><span class="r16">                           </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_colors </span><span class="r19">=</span><span class="r14"> colors</span><span class="r16">                     </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">on_mount</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                   </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Plot the data using Plotext.&quot;&quot;&quot;</span><span class="r16">        </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">title(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_title)</span><span class="r16">               </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">xlabel(</span><span class="r18">&#x27;Time&#x27;</span><span class="r14">)</span><span class="r16">                   </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">replot</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                     </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Redraw the plot.&quot;&quot;&quot;</span><span class="r16">                    </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data </span><span class="r29">and</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">next</span><span class="r14">(</span><span class="r17">iter</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">clear_data()</span><span class="r16">                 </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            nvals </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">((</span><span class="r17">list</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data</span><span class="r19">.</span><span class="r14">values())</span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">ylabel(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_unit)</span><span class="r16">           </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># step = np.arange(len(next(iter(self.</span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            max_data </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                          </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r18">&#x27;epoch&#x27;</span><span class="r14"> </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data:</span><span class="r16">             </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                xx </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data[</span><span class="r18">&#x27;epoch&#x27;</span><span class="r14">]</span><span class="r16">          </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                xx </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">arange(nvals)</span><span class="r16">             </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            x_end </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(xx, default</span><span class="r19">=1</span><span class="r14">)</span><span class="r16">            </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">xlim(</span><span class="r19">0</span><span class="r14">, x_end </span><span class="r19">*</span><span class="r14"> </span><span class="r19">1.01</span><span class="r14">)</span><span class="r16">        </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># cut off everything before a certain </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># when computing y-axis</span><span class="r16">               </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cutoff </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(</span><span class="r19">0</span><span class="r14">, np</span><span class="r19">.</span><span class="r14">sqrt(x_end) </span><span class="r19">-</span><span class="r14"> </span><span class="r19">2</span><span class="r14">)</span><span class="r16">   </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> name, color </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data, cyc</span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> name </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;epoch&#x27;</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">continue</span><span class="r16">                      </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                yvals </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data[name]</span><span class="r16">          </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r17">min</span><span class="r14">(yvals) </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r19">0</span><span class="r14"> </span><span class="r29">or</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(yvals) </span><span class="r19">&gt;</span><span class="r14"> </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">continue</span><span class="r16">                      </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                max_data </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(</span><span class="r16">                   </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    max_data, </span><span class="r17">max</span><span class="r14">([y </span><span class="r13">for</span><span class="r14"> x, y </span><span class="r29">in</span><span class="r14"> </span><span class="r17">z</span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">plot(xx, yvals, color</span><span class="r19">=</span><span class="r14">col</span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">plt</span><span class="r19">.</span><span class="r14">ylim(</span><span class="r19">0</span><span class="r14">, max_data </span><span class="r19">*</span><span class="r14"> </span><span class="r19">1.1</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">refresh()</span><span class="r16">                            </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">update_data</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, data: </span><span class="r17">dict</span><span class="r14">[</span><span class="r17">str</span><span class="r14">, Any]) </span><span class="r19">-&gt;</span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Update the data for the weather plot.</span><span class="r16">  </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        Args:</span><span class="r16">                                     </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            data: The data from the weather API.</span><span class="r16">  </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">            values: The name of the values to plot</span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        &quot;&quot;&quot;</span><span class="r16">                                       </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_data </span><span class="r19">=</span><span class="r14"> data</span><span class="r16">                         </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">replot()</span><span class="r16">                             </span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">update_colors</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, colors):</span><span class="r16">              </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_colors </span><span class="r19">=</span><span class="r14"> colors</span><span class="r16">                     </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">replot()</span><span class="r16">                             </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">TestRunner</span><span class="r14">(TrainingRun):</span><span class="r16">                    </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, delay</span><span class="r19">=0.1</span><span class="r14">, time</span><span class="r19">=5</span><span class="r14">):</span><span class="r16">        </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">delay </span><span class="r19">=</span><span class="r14"> delay</span><span class="r16">                        </span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps </span><span class="r19">=</span><span class="r14"> </span><span class="r17">round</span><span class="r14">(time </span><span class="r19">/</span><span class="r14"> delay)</span><span class="r16">      </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                        </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps </span><span class="r19">=</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps)</span><span class="r16">        </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># self.metrics_history = {&#x27;train_loss&#x27;: li</span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history </span><span class="r19">=</span><span class="r14"> {</span><span class="r18">&#x27;train_loss&#x27;</span><span class="r14">: [], </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">next_step</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                          </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        time</span><span class="r19">.</span><span class="r14">sleep(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">delay)</span><span class="r16">                    </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">+=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                       </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">&gt;=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps:</span><span class="r16">      </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                           </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> i, k </span><span class="r29">in</span><span class="r14"> </span><span class="r17">enumerate</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_his</span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[k]</span><span class="r19">.</span><span class="r14">append(</span><span class="r16">   </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r19">0.2</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> (np</span><span class="r19">.</span><span class="r14">exp(i) </span><span class="r19">/</span><span class="r14"> (</span><span class="r19">1</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">exp</span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r16">                           </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">step_until_done</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                    </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> _step </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps:</span><span class="r16">                  </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">next_step()</span><span class="r16">                </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Info</span><span class="r14">(Widget):</span><span class="r16">                               </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, dataa</span><span class="r19">=</span><span class="r14">{}):</span><span class="r16">                 </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r24">__init__</span><span class="r14">()</span><span class="r16">                        </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">update_data</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, dataa):</span><span class="r16">                 </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tab </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">widget</span><span class="r16">                         </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tab</span><span class="r19">.</span><span class="r14">clear(columns</span><span class="r19">=</span><span class="r13">True</span><span class="r14">)</span><span class="r16">                   </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        df </span><span class="r19">=</span><span class="r14"> pd</span><span class="r19">.</span><span class="r14">DataFrame(dataa)</span><span class="r16">                  </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tab</span><span class="r19">.</span><span class="r14">add_columns(</span><span class="r19">*</span><span class="r14">df</span><span class="r19">.</span><span class="r14">columns)</span><span class="r16">              </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tab</span><span class="r19">.</span><span class="r14">add_rows(df</span><span class="r19">.</span><span class="r14">map(format_scalar)</span><span class="r19">.</span><span class="r14">values[</span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">compose</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                            </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">widget </span><span class="r19">=</span><span class="r14"> DataTable(show_cursor</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">widget</span><span class="r16">                         </span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Dashboard</span><span class="r14">(App):</span><span class="r16">                             </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;An application for showing recent Textualiz</span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    CSS </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&quot;&quot;&quot;</span><span class="r16">                                     </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    Grid {</span><span class="r16">                                        </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        grid-size: 1 3;</span><span class="r16">                           </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        grid-rows: 12fr 7fr 1fr;</span><span class="r16">                  </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    }</span><span class="r16">                                             </span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    Losses {</span><span class="r16">                                      </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        padding: 1 2;</span><span class="r16">                             </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    }</span><span class="r16">                                             </span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    Info {</span><span class="r16">                                        </span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        text-style: bold;</span><span class="r16">                         </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    }</span><span class="r16">                                             </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    #bar {</span><span class="r16">                                        </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        width: 90%;</span><span class="r16">                               </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    }</span><span class="r16">                                             </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    &quot;&quot;&quot;</span><span class="r16">                                           </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    TITLE </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;Training&#x27;</span><span class="r16">                            </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    BINDINGS </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">                                  </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        (</span><span class="r18">&#x27;d&#x27;</span><span class="r14">, </span><span class="r18">&#x27;app.toggle_dark&#x27;</span><span class="r14">, </span><span class="r18">&#x27;Toggle light/dar</span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        (</span><span class="r18">&#x27;q&#x27;</span><span class="r14">, </span><span class="r18">&#x27;app.quit&#x27;</span><span class="r14">, </span><span class="r18">&#x27;Quit training&#x27;</span><span class="r14">),</span><span class="r16">       </span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ]</span><span class="r16">                                             </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data </span><span class="r19">=</span><span class="r14"> reactive({})</span><span class="r16">                           </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    colors </span><span class="r19">=</span><span class="r14"> reactive(</span><span class="r13">lambda</span><span class="r14">: rp</span><span class="r19">.</span><span class="r14">matplotlib</span><span class="r19">.</span><span class="r14">DARK_C</span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">, run: TrainingRun, config: MainConfig</span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                                    </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Initialise the application.&quot;&quot;&quot;</span><span class="r16">         </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r24">__init__</span><span class="r14">()</span><span class="r16">                        </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_run: TrainingRun </span><span class="r19">=</span><span class="r14"> run</span><span class="r16">              </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_plot_cols </span><span class="r19">=</span><span class="r14"> plot_cols</span><span class="r16">               </span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_config </span><span class="r19">=</span><span class="r14"> config</span><span class="r16">                     </span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">info </span><span class="r19">=</span><span class="r14"> Info()</span><span class="r16">                        </span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">progress </span><span class="r19">=</span><span class="r14"> ProgressBar(total</span><span class="r19">=</span><span class="r14">(run</span><span class="r19">.</span><span class="r14">num</span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">on_mount</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                           </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">log(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">_run)</span><span class="r16">                       </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">run_worker(</span><span class="r13">lambda</span><span class="r14">: </span><span class="r17">self</span><span class="r19">.</span><span class="r14">stream_data(</span><span class="r17">s</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">compose</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> ComposeResult:</span><span class="r16">           </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Compose the display of the example app.</span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> Header()</span><span class="r16">                            </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> Grid():</span><span class="r16">                              </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> Losses(</span><span class="r18">&#x27;Losses&#x27;</span><span class="r14">)</span><span class="r16">                </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">info</span><span class="r16">                       </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> Center(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">progress)</span><span class="r16">           </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> Footer()</span><span class="r16">                            </span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">update_data</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, data):</span><span class="r16">                  </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data </span><span class="r19">=</span><span class="r14"> data</span><span class="r16">                          </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">watch_data()</span><span class="r16">                         </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">watch_data</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                 </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        filtered_data </span><span class="r19">=</span><span class="r14"> {</span><span class="r16">                         </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            k: v</span><span class="r16">                                  </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">items()</span><span class="r16">         </span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">any</span><span class="r14">(k</span><span class="r19">.</span><span class="r14">startswith(pref) </span><span class="r13">for</span><span class="r14"> pref </span><span class="r29">in</span><span class="r14"> </span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        }</span><span class="r16">                                         </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> plot </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">query(Losses)</span><span class="r19">.</span><span class="r14">results(Los</span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            plot</span><span class="r19">.</span><span class="r14">update_data(filtered_data)</span><span class="r16">       </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">info</span><span class="r19">.</span><span class="r14">update_data(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data)</span><span class="r16">          </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        steps </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">data[</span><span class="r18">&#x27;step&#x27;</span><span class="r14">]) </span><span class="r13">if</span><span class="r14"> </span><span class="r18">&#x27;step&#x27;</span><span class="r14"> </span><span class="r29">i</span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> steps </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">_run</span><span class="r19">.</span><span class="r14">steps_in_epoch:</span><span class="r16">      </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">progress</span><span class="r19">.</span><span class="r14">update(progress</span><span class="r19">=</span><span class="r14">steps </span><span class="r19">-</span><span class="r14"> </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">refresh(layout</span><span class="r19">=</span><span class="r13">True</span><span class="r14">)</span><span class="r16">                 </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">watch_colors</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> plot </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">query(Losses)</span><span class="r19">.</span><span class="r14">results(Los</span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            plot</span><span class="r19">.</span><span class="r14">update_colors(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">colors)</span><span class="r16">       </span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">stream_data</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, run_state: TrainingRun):</span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        worker </span><span class="r19">=</span><span class="r14"> get_current_worker()</span><span class="r16">             </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        update_every_step </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                     </span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> state </span><span class="r29">in</span><span class="r14"> run_state</span><span class="r19">.</span><span class="r14">step_until_done():</span><span class="r16"> </span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> worker</span><span class="r19">.</span><span class="r14">is_cancelled </span><span class="r29">and</span><span class="r14"> state </span><span class="r29">i</span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">%</span><span class="r14"> update_every_</span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">self</span><span class="r19">.</span><span class="r14">call_from_thread(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">upd</span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">break</span><span class="r16">                             </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">call_from_thread(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">update_data, st</span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">call_from_thread(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">finish, state)</span><span class="r16"> </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">watch_dark</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, dark: </span><span class="r17">bool</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">     </span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">colors </span><span class="r19">=</span><span class="r14"> rp</span><span class="r19">.</span><span class="r14">matplotlib</span><span class="r19">.</span><span class="r14">DARK_COLORS </span><span class="r13">if</span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r14">watch_dark(dark)</span><span class="r16">           </span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">finish</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, state: TrainingRun):</span><span class="r16">         </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        folder </span><span class="r19">=</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">finish()</span><span class="r16">                   </span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">title </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;Finished in </span><span class="r25">{:.1f}</span><span class="r18"> minutes, </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">max</span><span class="r14">(state</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;rel_mins&#x27;</span><span class="r14">])</span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">progress</span><span class="r19">.</span><span class="r14">update(progress</span><span class="r19">=</span><span class="r14">state</span><span class="r19">.</span><span class="r14">num_ep</span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">if</span><span class="r14"> </span><span class="r30">__name__</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;__main__&#x27;</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config </span><span class="r19">=</span><span class="r14"> pyrallis</span><span class="r19">.</span><span class="r14">argparsing</span><span class="r19">.</span><span class="r14">parse(MainConfig)</span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># with jax.profiler.trace(&#x27;/tmp/jax-trace&#x27;, cr</span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">do_profile:</span><span class="r16">                         </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        jax</span><span class="r19">.</span><span class="r14">profiler</span><span class="r19">.</span><span class="r14">start_trace(</span><span class="r18">&#x27;/tmp/jax-trace&#x27;</span><span class="r14">,</span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    run </span><span class="r19">=</span><span class="r14"> TrainingRun(config)</span><span class="r16">                     </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    app </span><span class="r19">=</span><span class="r14"> Dashboard(run)</span><span class="r16">                          </span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    app</span><span class="r19">.</span><span class="r14">run()</span><span class="r16">                                     </span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">do_profile:</span><span class="r16">                         </span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        jax</span><span class="r19">.</span><span class="r14">profiler</span><span class="r19">.</span><span class="r14">stop_trace()</span><span class="r16">                 </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    11:    40 MB</span>                                                                                                                 
<span class="r1">(2)    18:    10 MB</span>                                                                                                                 
<span class="r21">                      /home/nmiklaucic/cdv/cdv/databatch.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                      </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/databatch.py              </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Sequence</span><span class="r16">                       </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> struct</span><span class="r16">                           </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">collections</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> defaultdict</span><span class="r16">               </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">jaxtyping</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Float, Array, Int, Bool</span><span class="r16">     </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> debug_structure</span><span class="r16">             </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">e3nn_jax</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">e3nn</span><span class="r16">                           </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">DIMENSIONALITIES </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">                              </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;3D-bulk&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;intercalated ion&#x27;</span><span class="r14">,</span><span class="r16">                           </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;2D-bulk&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;0D-bulk&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;1D-bulk&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;na&#x27;</span><span class="r14">,</span><span class="r16">                                         </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;intercalated molecule&#x27;</span><span class="r14">,</span><span class="r16">                      </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">]</span><span class="r16">                                                 </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">CRYSTAL_SYSTEMS </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">                               </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;triclinic&#x27;</span><span class="r14">,</span><span class="r16">                                  </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;monoclinic&#x27;</span><span class="r14">,</span><span class="r16">                                 </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;orthorhombic&#x27;</span><span class="r14">,</span><span class="r16">                               </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;tetragonal&#x27;</span><span class="r14">,</span><span class="r16">                                 </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;trigonal&#x27;</span><span class="r14">,</span><span class="r16">                                   </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;hexagonal&#x27;</span><span class="r14">,</span><span class="r16">                                  </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;cubic&#x27;</span><span class="r14">,</span><span class="r16">                                      </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">]</span><span class="r16">                                                 </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r23"># first space group of a given crystal system</span><span class="r16">     </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">   2%  </span>│<span class="r1">  828M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁   9% </span>│<span class="r12">     3 </span>│<span class="r14">CRYSTAL_SYSTEM_THRESHOLDS </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">array([</span><span class="r19">3</span><span class="r14">, </span><span class="r19">16</span><span class="r14">, </span><span class="r19">75</span><span class="r14">, </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">NodeData</span><span class="r14">(struct</span><span class="r19">.</span><span class="r14">PyTreeNode):</span><span class="r16">                </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    species: Int[Array, </span><span class="r18">&#x27;nodes&#x27;</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    frac: Float[Array, </span><span class="r18">&#x27;nodes 3&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    cart: Float[Array, </span><span class="r18">&#x27;nodes 3&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    incoming: Int[Array, </span><span class="r18">&#x27;nodes max_in&#x27;</span><span class="r14">]</span><span class="r16">          </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    incoming_pad: Bool[Array, </span><span class="r18">&#x27;nodes max_in&#x27;</span><span class="r14">]</span><span class="r16">     </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    outgoing: Int[Array, </span><span class="r18">&#x27;nodes max_out&#x27;</span><span class="r14">]</span><span class="r16">         </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    outgoing_pad: Bool[Array, </span><span class="r18">&#x27;nodes max_out&#x27;</span><span class="r14">]</span><span class="r16">    </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    graph_i: Int[Array, </span><span class="r18">&#x27;nodes&#x27;</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@classmethod</span><span class="r16">                                  </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">new_empty</span><span class="r14">(</span><span class="r17">cls</span><span class="r14">, nodes: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r18">&#x27;NodeData&#x27;</span><span class="r14">:</span><span class="r16"> </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">cls</span><span class="r14">(</span><span class="r16">                               </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(nodes, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">int</span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            frac</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">3</span><span class="r14">)),</span><span class="r16">           </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cart</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">3</span><span class="r14">)),</span><span class="r16">           </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            incoming</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">32</span><span class="r14">), dtype</span><span class="r19">=</span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            outgoing</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">20</span><span class="r14">), dtype</span><span class="r19">=</span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  56%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r14">            incoming_pad</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">32</span><span class="r14">), dt</span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            outgoing_pad</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((nodes, </span><span class="r19">20</span><span class="r14">), dt</span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_i</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(nodes, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">int</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">EdgeData</span><span class="r14">(struct</span><span class="r19">.</span><span class="r14">PyTreeNode):</span><span class="r16">                </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    to_jimage: Int[Array, </span><span class="r18">&#x27;edges 3&#x27;</span><span class="r14">]</span><span class="r16">              </span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    graph_i: Int[Array, </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    sender: Int[Array, </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">]</span><span class="r16">                   </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    receiver: Int[Array, </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@classmethod</span><span class="r16">                                  </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">new_empty</span><span class="r14">(</span><span class="r17">cls</span><span class="r14">, edges: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r18">&#x27;EdgeData&#x27;</span><span class="r14">:</span><span class="r16"> </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">cls</span><span class="r14">(</span><span class="r16">                               </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            to_jimage</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((edges, </span><span class="r19">3</span><span class="r14">), dtype</span><span class="r19">=</span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sender</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(edges, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">int3</span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            receiver</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(edges, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">in</span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_i</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(edges, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">int</span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">CrystalData</span><span class="r14">(struct</span><span class="r19">.</span><span class="r14">PyTreeNode):</span><span class="r16">             </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dataset_i: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">               </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    abc: Float[Array, </span><span class="r18">&#x27;graphs 3&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    angles_rad: Float[Array, </span><span class="r18">&#x27;graphs 3&#x27;</span><span class="r14">]</span><span class="r16">          </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    lat: Float[Array, </span><span class="r18">&#x27;graphs 3 3&#x27;</span><span class="r14">]</span><span class="r16">               </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    e_form: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    bandgap: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">               </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    e_total: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">               </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ehull: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dimensionality: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">          </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    density: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">               </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    space_group: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">             </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    magmom: Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_spec: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@classmethod</span><span class="r16">                                  </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">new_empty</span><span class="r14">(</span><span class="r17">cls</span><span class="r14">, graphs: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r18">&#x27;CrystalDat</span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">cls</span><span class="r14">(</span><span class="r16">                               </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            abc</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((graphs, </span><span class="r19">3</span><span class="r14">)),</span><span class="r16">           </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            angles_rad</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((graphs, </span><span class="r19">3</span><span class="r14">)),</span><span class="r16">    </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            lat</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty((graphs, </span><span class="r19">3</span><span class="r14">, </span><span class="r19">3</span><span class="r14">)),</span><span class="r16">        </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            e_form</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">             </span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            bandgap</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">            </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            e_total</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">            </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ehull</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">              </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            dimensionality</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">     </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            density</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">            </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            space_group</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">        </span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            magmom</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">             </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_spec</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs),</span><span class="r16">           </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            dataset_i</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">empty(graphs, dtype</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">CrystalGraphs</span><span class="r14">(struct</span><span class="r19">.</span><span class="r14">PyTreeNode):</span><span class="r16">           </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Batched/padded graphs. Should be able to su</span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    nodes: NodeData</span><span class="r16">                               </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    edges: EdgeData</span><span class="r16">                               </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    n_node: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    n_edge: Int[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">                  </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    padding_mask: Bool[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    graph_data: CrystalData</span><span class="r16">                       </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">senders</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Int[Array, </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">]:</span><span class="r16">     </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">sender</span><span class="r16">                  </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">receivers</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Int[Array, </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">]:</span><span class="r16">   </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">receiver</span><span class="r16">                </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">globals</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                            </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r16">                    </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">n_total_nodes</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">graph_i)</span><span class="r16">            </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">n_total_edges</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">graph_i)</span><span class="r16">            </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">n_total_graphs</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">              </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_node)</span><span class="r16">                   </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">e_form</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Float[Array, </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">]:</span><span class="r16">   </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">e_form</span><span class="r16">             </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">metric_tensor</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Float[Array, </span><span class="r18">&#x27;n_gra</span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;bij,bkj-&gt;bik&#x27;</span><span class="r14">, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">gra</span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">metric_tensor_irreps</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">IrrepsA</span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        basis </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">reduced_tensor_product_basis(</span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># metric tensor always symmetric, but this</span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># now we filter</span><span class="r16">                           </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">IrrepsArray(</span><span class="r16">                  </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            [</span><span class="r18">&#x27;0e&#x27;</span><span class="r14">, </span><span class="r18">&#x27;1e&#x27;</span><span class="r14">, </span><span class="r18">&#x27;2e&#x27;</span><span class="r14">],</span><span class="r16">                   </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;ai, bi -&gt; ba&#x27;</span><span class="r14">, basis</span><span class="r19">.</span><span class="r14">resha</span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r19">.</span><span class="r14">filter(drop</span><span class="r19">=</span><span class="r18">&#x27;1e&#x27;</span><span class="r14">)</span><span class="r16">                       </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">crystal_system_code</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> Int[Array, </span><span class="r18">&#x27; </span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Assigns to one of the 7 crystal systems</span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        sgs </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">space_group[:, </span><span class="r13">None</span><span class="r14">]</span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> (sgs </span><span class="r19">&lt;</span><span class="r14"> CRYSTAL_SYSTEM_THRESHOLDS)</span><span class="r19">.</span><span class="r14">s</span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__add__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, other: </span><span class="r18">&#x27;CrystalGraphs&#x27;</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r18">&#x27;</span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Collates both objects together, taking </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        other_nodes </span><span class="r19">=</span><span class="r14"> other</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">replace(</span><span class="r16">        </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_i</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">graph_i </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_t</span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            incoming</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">incoming </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            outgoing</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">outgoing </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        other_edges </span><span class="r19">=</span><span class="r14"> other</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">replace(</span><span class="r16">        </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_i</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">graph_i </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_t</span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sender</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">sender </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_tot</span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            receiver</span><span class="r19">=</span><span class="r14">other</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">receiver </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        other </span><span class="r19">=</span><span class="r14"> other</span><span class="r19">.</span><span class="r14">replace(nodes</span><span class="r19">=</span><span class="r14">other_nodes, e</span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  35%  </span>│<span class="r1">   20M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁      </span>│<span class="r12">     1 </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">tree</span><span class="r19">.</span><span class="r14">map(</span><span class="r13">lambda</span><span class="r14"> x, y: jnp</span><span class="r19">.</span><span class="r14">conca</span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">padded</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, n_node: </span><span class="r17">int</span><span class="r14">, n_edge: </span><span class="r17">int</span><span class="r14">, n_g</span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Pad the graph to the given shape. Adds </span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        with the required extra nodes and edges, t</span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad_n_node </span><span class="r19">=</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(n_node </span><span class="r19">-</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_total_nod</span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad_n_edge </span><span class="r19">=</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(n_edge </span><span class="r19">-</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_total_edg</span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad_n_graph </span><span class="r19">=</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(n_graph </span><span class="r19">-</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_total_g</span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># https://github.com/google-deepmind/jraph</span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> pad_n_node </span><span class="r19">&lt;=</span><span class="r14"> </span><span class="r19">0</span><span class="r14"> </span><span class="r29">or</span><span class="r14"> pad_n_edge </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r19">0</span><span class="r14"> </span><span class="r29">or</span><span class="r14"> pa</span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">RuntimeError</span><span class="r14">(</span><span class="r16">                   </span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r18">&#x27;Given graph is too large for the </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r18">f&#x27;Current shape: </span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">n_total_nod</span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r18">f&#x27;Desired shape: </span><span class="r25">{</span><span class="r14">n_node</span><span class="r25">}</span><span class="r18"> nodes, </span><span class="r25">{</span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> CrystalGraphs</span><span class="r19">.</span><span class="r14">new_empty(pad_</span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@classmethod</span><span class="r16">                                  </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">new_empty</span><span class="r14">(</span><span class="r17">cls</span><span class="r14">, nodes: </span><span class="r17">int</span><span class="r14">, edges: </span><span class="r17">int</span><span class="r14">, gra</span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">cls</span><span class="r14">(</span><span class="r16">                               </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            nodes</span><span class="r19">=</span><span class="r14">NodeData</span><span class="r19">.</span><span class="r14">new_empty(nodes),</span><span class="r16">      </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            edges</span><span class="r19">=</span><span class="r14">EdgeData</span><span class="r19">.</span><span class="r14">new_empty(edges),</span><span class="r16">      </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_data</span><span class="r19">=</span><span class="r14">CrystalData</span><span class="r19">.</span><span class="r14">new_empty(graph</span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            n_node</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">concat((jnp</span><span class="r19">.</span><span class="r14">array([nodes]),</span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            n_edge</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">concat((jnp</span><span class="r19">.</span><span class="r14">array([edges]),</span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            padding_mask</span><span class="r19">=</span><span class="r14">jnp</span><span class="r19">.</span><span class="r14">zeros(graphs, dtype</span><span class="r19">=</span><span class="r14">j</span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">rotate</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, seed: </span><span class="r17">int</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">tuple</span><span class="r14">[</span><span class="r18">&#x27;CrystalG</span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Rotate the coordinates using random rot</span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        the matrices.&quot;&quot;&quot;</span><span class="r16">                          </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        rots </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">rand_matrix(jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">key(see</span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        lat_rot_m </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;bij,bjk-&gt;bik&#x27;</span><span class="r14">, </span><span class="r17">sel</span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        new_carts </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;bik,bi-&gt;bk&#x27;</span><span class="r14">, lat_r</span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        new_nodes </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">replace(cart</span><span class="r19">=</span><span class="r14">new_ca</span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        new_graph_data </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">replace(l</span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        new_batch </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">replace(nodes</span><span class="r19">=</span><span class="r14">new_nodes, </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> new_batch, rots</span><span class="r16">                    </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__rich_repr__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                      </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> </span><span class="r18">&#x27;nodes&#x27;</span><span class="r14">, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">cart</span><span class="r19">.</span><span class="r14">shape</span><span class="r16">      </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> </span><span class="r18">&#x27;edges&#x27;</span><span class="r14">, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">edges</span><span class="r19">.</span><span class="r14">sender</span><span class="r19">.</span><span class="r14">shape</span><span class="r16">    </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> </span><span class="r18">&#x27;graphs&#x27;</span><span class="r14">, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">globals</span><span class="r19">.</span><span class="r14">e_form</span><span class="r19">.</span><span class="r14">shape</span><span class="r16"> </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">collate</span><span class="r14">(graphs: Sequence[CrystalGraphs]) </span><span class="r19">-&gt;</span><span class="r14"> Cr</span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Collates the batches into a new Graphs obje</span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r17">sum</span><span class="r14">(graphs[</span><span class="r19">1</span><span class="r14">:], start</span><span class="r19">=</span><span class="r14">graphs[</span><span class="r19">0</span><span class="r14">])</span><span class="r16">       </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    31:   828 MB</span>                                                                                                                 
<span class="r1">(2)   180:    20 MB</span>                                                                                                                 
<span class="r1">(3)    52:    10 MB</span>                                                                                                                 
<span class="r21">                       /home/nmiklaucic/cdv/cdv/dataset.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                       </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/dataset.py                </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;Code to load the processed data.&quot;&quot;&quot;</span><span class="r16">            </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">collections.abc</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Sequence</span><span class="r16">              </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">functools</span><span class="r16">                                  </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> partial</span><span class="r16">                     </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">itertools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> batched</span><span class="r16">                     </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">os</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> PathLike</span><span class="r16">                           </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pathlib</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Path</span><span class="r16">                          </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Literal</span><span class="r16">                        </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">warnings</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> filterwarnings</span><span class="r16">               </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax.serialization</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> from_state_dict, ms</span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                                </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                                   </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">beartype.roar</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> BeartypeDecorHintPep585D</span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">einops</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> rearrange</span><span class="r16">                      </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">eins</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> EinsOp</span><span class="r16">                           </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.databatch</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> CrystalGraphs, collate</span><span class="r16">  </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.metadata</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Metadata</span><span class="r16">                 </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> debug_stat, debug_structure,</span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">filterwarnings(</span><span class="r18">&#x27;ignore&#x27;</span><span class="r14">, category</span><span class="r19">=</span><span class="r14">BeartypeDecorHin</span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">load_raw</span><span class="r14">(config: </span><span class="r18">&#x27;MainConfig&#x27;</span><span class="r14">, file_num</span><span class="r19">=0</span><span class="r14">):</span><span class="r16">   </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Loads a file. Lacks the complex data loader</span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">    If pad, pads the batch to the expected size.&quot;&quot;</span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data_folder </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">dataset_folder</span><span class="r16">      </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fn </span><span class="r19">=</span><span class="r14"> data_folder </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;batches&#x27;</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> </span><span class="r18">f&#x27;batch</span><span class="r25">{</span><span class="r14">file_nu</span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(fn, </span><span class="r18">&#x27;rb&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> file:</span><span class="r16">                  </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  93%  </span>│<span class="r1">   70M </span>│<span class="r1">▁▁▁▁▁▁▁        </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> msgpack_restore(file</span><span class="r19">.</span><span class="r14">read())</span><span class="r16">       </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">process_raw</span><span class="r14">(raw_data, pad</span><span class="r19">=</span><span class="r13">None</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> CrystalGrap</span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data: CrystalGraphs </span><span class="r19">=</span><span class="r14"> from_state_dict(CrystalG</span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  49%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r14">    data </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">tree</span><span class="r19">.</span><span class="r14">map(jnp</span><span class="r19">.</span><span class="r14">array, data)</span><span class="r16">          </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_structure(data)</span><span class="r16">                       </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> pad </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                           </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># debug_structure(d=data, dp=data.padded(*</span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        data </span><span class="r19">=</span><span class="r14"> data</span><span class="r19">.</span><span class="r14">padded(</span><span class="r19">*</span><span class="r14">pad)</span><span class="r16">                  </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> data</span><span class="r16">                                   </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">load_file</span><span class="r14">(config: </span><span class="r18">&#x27;MainConfig&#x27;</span><span class="r14">, file_num</span><span class="r19">=0</span><span class="r14">, pa</span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Loads a file. Lacks the complex data loader</span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">    If pad, pads the batch to the expected size.&quot;&quot;</span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> pad:</span><span class="r16">                                       </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">graph_shape</span><span class="r16">             </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                                </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> process_raw(load_raw(config, file_num),</span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">stack_trees</span><span class="r14">(cgs: Sequence[CrystalGraphs]) </span><span class="r19">-&gt;</span><span class="r14"> C</span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">tree_map(</span><span class="r13">lambda</span><span class="r14"> </span><span class="r19">*</span><span class="r14">args: jnp</span><span class="r19">.</span><span class="r14">stack(ar</span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">dataloader_base</span><span class="r14">(</span><span class="r16">                              </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config: </span><span class="r18">&#x27;MainConfig&#x27;</span><span class="r14">, split: Literal[</span><span class="r18">&#x27;train&#x27;</span><span class="r14">, </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">):</span><span class="r16">                                                </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Returns a generator that produces batches t</span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data_folder </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">dataset_folder</span><span class="r16">      </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    files </span><span class="r19">=</span><span class="r14"> </span><span class="r17">sorted</span><span class="r14">(</span><span class="r17">list</span><span class="r14">(data_folder</span><span class="r19">.</span><span class="r14">glob(</span><span class="r18">&#x27;batches/</span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    splits </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">cumsum([config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">train_split, c</span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    total </span><span class="r19">=</span><span class="r14"> splits[</span><span class="r19">-1</span><span class="r14">]</span><span class="r16">                            </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_inds </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">zeros(total)</span><span class="r16">                  </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_inds[: splits[</span><span class="r19">0</span><span class="r14">]] </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                   </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_inds[splits[</span><span class="r19">0</span><span class="r14">] : splits[</span><span class="r19">1</span><span class="r14">]] </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">         </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_inds[splits[</span><span class="r19">1</span><span class="r14">] :] </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                   </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_i </span><span class="r19">=</span><span class="r14"> [</span><span class="r18">&#x27;train&#x27;</span><span class="r14">, </span><span class="r18">&#x27;valid&#x27;</span><span class="r14">, </span><span class="r18">&#x27;test&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">index(spl</span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_idx </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">arange(</span><span class="r17">len</span><span class="r14">(files))</span><span class="r16">             </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_idx </span><span class="r19">=</span><span class="r14"> split_idx[split_inds[split_idx </span><span class="r19">%</span><span class="r14"> t</span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">yield</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(split_idx) </span><span class="r19">//</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">train_batch_mul</span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    split_files </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">array([</span><span class="r13">None</span><span class="r14"> </span><span class="r13">for</span><span class="r14"> _ </span><span class="r29">in</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">le</span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    shuffle_rng </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">default_rng(config</span><span class="r19">.</span><span class="r14">dat</span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    device </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">device</span><span class="r19">.</span><span class="r14">jax_device()</span><span class="r16">           </span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(device, jax</span><span class="r19">.</span><span class="r14">sharding</span><span class="r19">.</span><span class="r14">Sharding):</span><span class="r16"> </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_devices </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(device</span><span class="r19">.</span><span class="r14">addressable_devic</span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_devices </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">stack_size</span><span class="r16">           </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    batch_inds </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">split(</span><span class="r16">                        </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        shuffle_rng</span><span class="r19">.</span><span class="r14">permutation(split_idx),</span><span class="r16">       </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">len</span><span class="r14">(split_idx) </span><span class="r19">//</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">train_batch_multi</span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    )</span><span class="r16">                                             </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">assert</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(batch_inds) </span><span class="r19">%</span><span class="r14"> num_devices </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r14">, </span><span class="r18">f&#x27;</span><span class="r25">{</span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    file_data </span><span class="r19">=</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(</span><span class="r17">map</span><span class="r14">(functools</span><span class="r19">.</span><span class="r14">partial(load_ra</span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    byte_data </span><span class="r19">=</span><span class="r14"> </span><span class="r17">dict</span><span class="r14">(</span><span class="r17">zip</span><span class="r14">(split_idx, file_data))</span><span class="r16">   </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> batches </span><span class="r29">in</span><span class="r14"> batched(batch_inds, num_devices</span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> batch </span><span class="r29">in</span><span class="r14"> batches:</span><span class="r16">                     </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            data_files </span><span class="r19">=</span><span class="r14"> [process_raw(byte_data[i]</span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            split_files[batch] </span><span class="r19">=</span><span class="r14"> data_files</span><span class="r16">       </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        collated </span><span class="r19">=</span><span class="r14"> [collate(split_files[batch]) </span><span class="r13">fo</span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        stacked </span><span class="r19">=</span><span class="r14"> stack_trees(collated)</span><span class="r16">           </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">yield</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">device_put(stacked, device)</span><span class="r16">     </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">while</span><span class="r14"> infinite:</span><span class="r16">                               </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        batch_inds </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">split(</span><span class="r16">                    </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            shuffle_rng</span><span class="r19">.</span><span class="r14">permutation(split_idx),</span><span class="r16">   </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">len</span><span class="r14">(split_idx) </span><span class="r19">//</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">train_batch_m</span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> batches </span><span class="r29">in</span><span class="r14"> batched(batch_inds, num_dev</span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            collated </span><span class="r19">=</span><span class="r14"> [collate(split_files[batch]</span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            stacked </span><span class="r19">=</span><span class="r14"> stack_trees(collated)</span><span class="r16">       </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">device_put(stacked, device)</span><span class="r16"> </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">dataloader</span><span class="r14">(</span><span class="r16">                                   </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config: </span><span class="r18">&#x27;MainConfig&#x27;</span><span class="r14">, split: Literal[</span><span class="r18">&#x27;train&#x27;</span><span class="r14">, </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">):</span><span class="r16">                                                </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dl </span><span class="r19">=</span><span class="r14"> dataloader_base(config, split, infinite)</span><span class="r16"> </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    steps_per_epoch </span><span class="r19">=</span><span class="r14"> </span><span class="r17">next</span><span class="r14">(dl)</span><span class="r16">                    </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> (steps_per_epoch, dl)</span><span class="r16">                  </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">num_elements_class</span><span class="r14">(batch):</span><span class="r16">                    </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># 2, 3, 4, 5 are values</span><span class="r16">                       </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># map to 0, 1, 2, 3</span><span class="r16">                           </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> (</span><span class="r16">                                      </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        jax</span><span class="r19">.</span><span class="r14">nn</span><span class="r19">.</span><span class="r14">one_hot(batch[</span><span class="r18">&#x27;species&#x27;</span><span class="r14">], jnp</span><span class="r19">.</span><span class="r14">max(b</span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">.</span><span class="r14">max(axis</span><span class="r19">=1</span><span class="r14">)</span><span class="r16">                              </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">.</span><span class="r14">sum(axis</span><span class="r19">=1</span><span class="r14">)</span><span class="r16">                              </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                                         </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">if</span><span class="r14"> </span><span class="r30">__name__</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;__main__&#x27;</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig</span><span class="r16">             </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                            </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config </span><span class="r19">=</span><span class="r14"> pyrallis</span><span class="r19">.</span><span class="r14">parse(config_class</span><span class="r19">=</span><span class="r14">MainConfi</span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config</span><span class="r19">.</span><span class="r14">cli</span><span class="r19">.</span><span class="r14">set_up_logging()</span><span class="r16">                   </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    f1 </span><span class="r19">=</span><span class="r14"> load_file(config, </span><span class="r19">300</span><span class="r14">)</span><span class="r16">                   </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    debug_stat(conf</span><span class="r19">=</span><span class="r14">f1)</span><span class="r16">                           </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">tqdm</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> tqdm</span><span class="r16">                         </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    steps_per_epoch, dl </span><span class="r19">=</span><span class="r14"> dataloader(config, split</span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    dens </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                                     </span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    e_forms </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                                  </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    n_nodes </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                                  </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> _i </span><span class="r29">in</span><span class="r14"> tqdm(np</span><span class="r19">.</span><span class="r14">arange(steps_per_epoch </span><span class="r19">*</span><span class="r14"> </span><span class="r19">2</span><span class="r14">))</span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        batch </span><span class="r19">=</span><span class="r14"> </span><span class="r17">next</span><span class="r14">(dl)</span><span class="r16">                          </span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        dens</span><span class="r19">.</span><span class="r14">append(batch</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">density</span><span class="r19">.</span><span class="r14">mean(</span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        e_forms</span><span class="r19">.</span><span class="r14">append(batch</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">e_form</span><span class="r19">.</span><span class="r14">mea</span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        n_nodes</span><span class="r19">.</span><span class="r14">extend(batch</span><span class="r19">.</span><span class="r14">n_node</span><span class="r19">.</span><span class="r14">tolist())</span><span class="r16">     </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(batch</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">density</span><span class="r19">.</span><span class="r14">devices())</span><span class="r16">     </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    debug_structure(conf</span><span class="r19">=</span><span class="r17">next</span><span class="r14">(dl))</span><span class="r16">                </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(jnp</span><span class="r19">.</span><span class="r14">mean(jnp</span><span class="r19">.</span><span class="r14">array(dens)))</span><span class="r16">              </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(jnp</span><span class="r19">.</span><span class="r14">array(e_forms)</span><span class="r19">.</span><span class="r14">mean())</span><span class="r16">              </span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(np</span><span class="r19">.</span><span class="r14">unique(n_nodes, return_counts</span><span class="r19">=</span><span class="r13">True</span><span class="r14">))</span><span class="r16"> </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    36:    70 MB</span>                                                                                                                 
<span class="r1">(2)    41:    10 MB</span>                                                                                                                 
<span class="r21">                        /home/nmiklaucic/cdv/cdv/mace.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                         </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/mace.py                   </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;</span><span class="r16">                                               </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">MACE network code. Adapted from https://github.com</span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;</span><span class="r16">                                               </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">functools</span><span class="r16">                                  </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">math</span><span class="r16">                                       </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Callable, Optional</span><span class="r16">             </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Set, Union</span><span class="r16">                     </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> linen </span><span class="r13">as</span><span class="r14"> nn</span><span class="r16">                      </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> struct</span><span class="r16">                           </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">e3nn_jax</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">e3nn</span><span class="r16">                           </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">jaxtyping</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Float, Array, Int</span><span class="r16">           </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">eins</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> EinsOp</span><span class="r16">                           </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                                </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.databatch</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> CrystalGraphs</span><span class="r16">           </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.gnn</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> SegmentReduction, SegmentReduc</span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.layers</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Context, E3NormNorm, Identi</span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> debug_stat, debug_structure,</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">Linear</span><span class="r14">(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">                      </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># return nn.WeightNorm(e3nn.flax.Linear(*args,</span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">flax</span><span class="r19">.</span><span class="r14">Linear(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs)</span><span class="r16">      </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">LinearNodeEmbedding</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">             </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    irreps_out: E3Irreps</span><span class="r16">                          </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">setup</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                              </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">skipatom_init</span><span class="r14">(key, shape, dtype):</span><span class="r16">     </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">import</span><span class="r14"> </span><span class="r15">pickle</span><span class="r16">                         </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                   </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(</span><span class="r18">&#x27;data/mp_2020_10_09.dim250.k</span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                data </span><span class="r19">=</span><span class="r14"> pickle</span><span class="r19">.</span><span class="r14">load(fin)</span><span class="r16">           </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            atoms </span><span class="r19">=</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(</span><span class="r16">                         </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                pd</span><span class="r19">.</span><span class="r14">read_csv(</span><span class="r16">                      </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r18">&#x27;https://raw.githubusercontent</span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    header</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                  </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r19">.</span><span class="r14">values</span><span class="r19">.</span><span class="r14">reshape(</span><span class="r19">-1</span><span class="r14">)</span><span class="r16">              </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            embed_i </span><span class="r19">=</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(</span><span class="r17">map</span><span class="r14">(atoms</span><span class="r19">.</span><span class="r14">index, ELEM_V</span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            embeds </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">array(data[embed_i], dtyp</span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            curr_dim </span><span class="r19">=</span><span class="r14"> embeds</span><span class="r19">.</span><span class="r14">shape[</span><span class="r19">-1</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r19">*</span><span class="r14">batch, out_dim </span><span class="r19">=</span><span class="r14"> shape</span><span class="r16">               </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            pad_shape </span><span class="r19">=</span><span class="r14"> (</span><span class="r19">*</span><span class="r14">batch, out_dim </span><span class="r19">-</span><span class="r14"> curr_di</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">concat((embeds, jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">irreps_out_calc </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">irrep</span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">out_dim </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">irreps_out_ca</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">embed </span><span class="r19">=</span><span class="r14"> nn</span><span class="r19">.</span><span class="r14">Embed(</span><span class="r16">                    </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16">                     </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">out_dim,</span><span class="r16">                         </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># embedding_init=skipatom_init</span><span class="r16">        </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, node_species: Int[Array, </span><span class="r18">&#x27; </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  21%  </span>│<span class="r1">   14M </span>│<span class="r1">▁▁▁▁▁          </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> E3IrrepsArray(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">irreps_out_calc,</span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">LinearReadoutBlock</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">              </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, x: E3IrrepsArray) </span><span class="r19">-&gt;</span><span class="r14"> E3Irre</span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;batch irreps -&gt; batch irreps_out&quot;&quot;&quot;</span><span class="r16">    </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># x = [n_nodes, irreps]</span><span class="r16">                   </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Linear(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irreps)(x)</span><span class="r16">      </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">NonLinearReadoutBlock</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">           </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    activation: Optional[Callable] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">         </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    gate: Optional[Callable] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">               </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, x: E3IrrepsArray) </span><span class="r19">-&gt;</span><span class="r14"> E3Irre</span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;batch irreps -&gt; batch irreps_out&quot;&quot;&quot;</span><span class="r16">    </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># x = [n_nodes, irreps]</span><span class="r16">                   </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        hidden_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irrep</span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        output_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irrep</span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_vectors </span><span class="r19">=</span><span class="r14"> hidden_irreps</span><span class="r19">.</span><span class="r14">filter(</span><span class="r16">       </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            drop</span><span class="r19">=</span><span class="r14">[</span><span class="r18">&#x27;0e&#x27;</span><span class="r14">, </span><span class="r18">&#x27;0o&#x27;</span><span class="r14">]</span><span class="r16">                     </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r19">.</span><span class="r14">num_irreps  </span><span class="r23"># Multiplicity of (l &gt; 0) ir</span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(x.irreps)</span><span class="r16">                         </span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        x </span><span class="r19">=</span><span class="r14"> Linear(</span><span class="r16">                               </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            (hidden_irreps </span><span class="r19">+</span><span class="r14"> E3Irreps(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">num_vecto</span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )(x)</span><span class="r16">                                      </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print((hidden_irreps + E3Irreps(f&#x27;{num_v</span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(x.irreps)</span><span class="r16">                         </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     7 </span>│<span class="r14">        x </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">gate(x, even_act</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Linear(output_irreps)(x)</span><span class="r16">           </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># [n_nodes, output_irreps]</span><span class="r16">                    </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">RadialEmbeddingBlock</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">            </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    r_max: </span><span class="r17">float</span><span class="r16">                                  </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    basis_functions: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    envelope_function: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_r_min: Optional[</span><span class="r17">float</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">             </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, edge_lengths: jnp</span><span class="r19">.</span><span class="r14">ndarray) </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;batch -&gt; batch num_basis&quot;&quot;&quot;</span><span class="r16">            </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">func</span><span class="r14">(lengths):</span><span class="r16">                        </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            basis </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">basis_functions(lengths, </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cutoff </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">envelope_function(length</span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> basis </span><span class="r19">*</span><span class="r14"> cutoff[:, </span><span class="r13">None</span><span class="r14">]  </span><span class="r23"># [n_e</span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">ensure_compile_time_eval():</span><span class="r16">      </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_r_min </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">            </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                factor </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1.0</span><span class="r16">                      </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                samples </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">linspace(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_r_</span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">                factor </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">mean(func(samples) </span><span class="r19">**</span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        embedding </span><span class="r19">=</span><span class="r14"> factor </span><span class="r19">*</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">where(</span><span class="r16">           </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            (edge_lengths </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0.0</span><span class="r14">)[:, </span><span class="r13">None</span><span class="r14">], </span><span class="r19">0.0</span><span class="r14">, f</span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )  </span><span class="r23"># [n_edges, num_basis]</span><span class="r16">                 </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> E3IrrepsArray(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">embedding</span><span class="r19">.</span><span class="r14">shape[</span><span class="r19">-1</span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">A025582 </span><span class="r19">=</span><span class="r14"> [</span><span class="r19">0</span><span class="r14">, </span><span class="r19">1</span><span class="r14">, </span><span class="r19">3</span><span class="r14">, </span><span class="r19">7</span><span class="r14">, </span><span class="r19">12</span><span class="r14">, </span><span class="r19">20</span><span class="r14">, </span><span class="r19">30</span><span class="r14">, </span><span class="r19">44</span><span class="r14">, </span><span class="r19">65</span><span class="r14">, </span><span class="r19">80</span><span class="r14">, </span><span class="r19">96</span><span class="r14">,</span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">ft</span><span class="r16">                            </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">reduced_symmetric_tensor_product_basis </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">redu</span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">reduced_tensor_product_basis </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">reduced_tensor</span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r23"># e3nn.reduced_symmetric_tensor_product_basis</span><span class="r16">     </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">SymmetricContraction</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">            </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    keep_irrep_out: Union[Set[e3nn</span><span class="r19">.</span><span class="r14">Irrep], </span><span class="r17">str</span><span class="r14">]</span><span class="r16">   </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    gradient_normalization: Union[</span><span class="r17">str</span><span class="r14">, </span><span class="r17">float</span><span class="r14">, </span><span class="r13">None</span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">   </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    off_diagonal: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                    </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">input</span><span class="r14">: E3IrrepsArray,  </span><span class="r23"># n_nodes, feats, i</span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        index: jnp</span><span class="r19">.</span><span class="r14">ndarray,</span><span class="r16">                       </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        species_embed: Float[Array, </span><span class="r18">&#x27;num_species e</span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> E3IrrepsArray:</span><span class="r16">                           </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        gradient_normalization </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">gradient_nor</span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> gradient_normalization </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">        </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            gradient_normalization </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">config(</span><span class="r18">&#x27;</span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(gradient_normalization, </span><span class="r17">str</span><span class="r14">)</span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            gradient_normalization </span><span class="r19">=</span><span class="r14"> {</span><span class="r18">&#x27;element&#x27;</span><span class="r14">: </span><span class="r19">0</span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">keep_irrep_out, </span><span class="r17">str</span><span class="r14">):</span><span class="r16">  </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            keep_irrep_out </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">keep_ir</span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">assert</span><span class="r14"> </span><span class="r17">all</span><span class="r14">(mul </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r14"> </span><span class="r13">for</span><span class="r14"> mul, _ </span><span class="r29">in</span><span class="r14"> keep</span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            keep_irrep_out </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">keep_irrep_out</span><span class="r16">  </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        keep_irrep_out_set </span><span class="r19">=</span><span class="r14"> {e3nn</span><span class="r19">.</span><span class="r14">Irrep(ir) </span><span class="r13">for</span><span class="r14"> i</span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        W </span><span class="r19">=</span><span class="r14"> {}</span><span class="r16">                                    </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># Treat batch indices using vmap</span><span class="r16">          </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        shape </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">broadcast_shapes(</span><span class="r17">input</span><span class="r19">.</span><span class="r14">shape[:</span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">input</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r17">input</span><span class="r19">.</span><span class="r14">broadcast_to(shape </span><span class="r19">+</span><span class="r14"> </span><span class="r17">input</span><span class="r19">.</span><span class="r14">s</span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        index </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">broadcast_to(index, shape)</span><span class="r16">    </span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_rbf </span><span class="r19">=</span><span class="r14"> </span><span class="r19">32</span><span class="r16">                              </span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> species_embed </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                 </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species_embed </span><span class="r19">=</span><span class="r14"> nn</span><span class="r19">.</span><span class="r14">Embed(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_spec</span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># species_ind = index</span><span class="r16">                 </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species_ind </span><span class="r19">=</span><span class="r14"> species_embed(index)</span><span class="r16">    </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species_embed_mlp </span><span class="r19">=</span><span class="r14"> LazyInMLP(</span><span class="r16">        </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                [], out_dim</span><span class="r19">=</span><span class="r14">num_rbf, name</span><span class="r19">=</span><span class="r18">&#x27;species</span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species_embed </span><span class="r19">=</span><span class="r14"> species_embed_mlp(spec</span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            species_ind </span><span class="r19">=</span><span class="r14"> species_embed[index]</span><span class="r16">    </span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(input.shape, index.shape)</span><span class="r16">         </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> order </span><span class="r29">in</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation, </span><span class="r19">0</span><span class="r14">, </span><span class="r19">-1</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">symmetric_tensor_product_basis</span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                U </span><span class="r19">=</span><span class="r14"> reduced_symmetric_tensor_produ</span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">input</span><span class="r19">.</span><span class="r14">irreps, order, keep_ir</span><span class="r19">=</span><span class="r14">k</span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                U </span><span class="r19">=</span><span class="r14"> reduced_tensor_product_basis([</span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># U = U / order  # normalization TODO(</span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># NOTE(mario): The normalization const</span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># has been numerically checked to be c</span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># TODO(mario) implement norm_p</span><span class="r16">        </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># ((w3 x + w2) x + w1) x</span><span class="r16">              </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#  \-----------/</span><span class="r16">                      </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#       out</span><span class="r16">                           </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> (mul, ir_out), u </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(U</span><span class="r19">.</span><span class="r14">irreps, </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                name </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;w</span><span class="r25">{</span><span class="r14">order</span><span class="r25">}</span><span class="r18">_</span><span class="r25">{</span><span class="r14">ir_out</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">       </span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                W[name] </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">param(</span><span class="r16">             </span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    name,</span><span class="r16">                         </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r23"># nn.initializers.normal(stdde</span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    nn</span><span class="r19">.</span><span class="r14">initializers</span><span class="r19">.</span><span class="r14">normal(stddev</span><span class="r19">=</span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    (num_rbf, mul, </span><span class="r17">input</span><span class="r19">.</span><span class="r14">shape[</span><span class="r19">-2</span><span class="r14">]</span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># - This operation is parallel on the feat</span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># This operation is an efficient implement</span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># vmap(lambda w, x: FunctionalLinear(irrep</span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># up to x power self.correlation</span><span class="r16">          </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># assert input.ndim == 2  # [num_features,</span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># assert index.ndim == 0  # int</span><span class="r16">           </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r19">=</span><span class="r14"> </span><span class="r17">dict</span><span class="r14">()</span><span class="r16">                              </span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> order </span><span class="r29">in</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation, </span><span class="r19">0</span><span class="r14">, </span><span class="r19">-1</span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">off_diagonal:</span><span class="r16">                 </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                roll </span><span class="r19">=</span><span class="r14"> </span><span class="r13">lambda</span><span class="r14"> arr: jnp</span><span class="r19">.</span><span class="r14">roll(arr, A</span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x_ </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">vmap(roll)(</span><span class="r17">input</span><span class="r19">.</span><span class="r14">array)</span><span class="r16">  </span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x_ </span><span class="r19">=</span><span class="r14"> </span><span class="r17">input</span><span class="r19">.</span><span class="r14">array</span><span class="r16">                  </span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">symmetric_tensor_product_basis</span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                U </span><span class="r19">=</span><span class="r14"> reduced_symmetric_tensor_produ</span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">input</span><span class="r19">.</span><span class="r14">irreps, order, keep_ir</span><span class="r19">=</span><span class="r14">k</span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                U </span><span class="r19">=</span><span class="r14"> reduced_tensor_product_basis([</span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># U = U / order  # normalization TODO(</span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># NOTE(mario): The normalization const</span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># has been numerically checked to be c</span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># TODO(mario) implement norm_p</span><span class="r16">        </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># ((w3 x + w2) x + w1) x</span><span class="r16">              </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#  \-----------/</span><span class="r16">                      </span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#       out</span><span class="r16">                           </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> (mul, ir_out), u </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(U</span><span class="r19">.</span><span class="r14">irreps, </span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                u </span><span class="r19">=</span><span class="r14"> u</span><span class="r19">.</span><span class="r14">astype(x_</span><span class="r19">.</span><span class="r14">dtype)</span><span class="r16">            </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># u: ndarray [(irreps_x.dim)^order</span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># print(self)</span><span class="r16">                     </span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                name </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;w</span><span class="r25">{</span><span class="r14">order</span><span class="r25">}</span><span class="r18">_</span><span class="r25">{</span><span class="r14">ir_out</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">       </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                w </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;be,e...-&gt;b...&#x27;</span><span class="r14">, sp</span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># w = W[name][species]</span><span class="r16">            </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># [multiplicity, num_features]</span><span class="r16">    </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># w = w * (mul**-0.5) ** gradient_</span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> ir_out </span><span class="r29">not</span><span class="r14"> </span><span class="r29">in</span><span class="r14"> out:</span><span class="r16">             </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r23"># debug_structure(u=u, w=w, x=</span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    out[ir_out] </span><span class="r19">=</span><span class="r14"> (</span><span class="r16">               </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        </span><span class="r18">&#x27;special&#x27;</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">  269 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r18">&#x27;...jki,bkc,bcj</span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    )  </span><span class="r23"># [num_features, (irreps_x.</span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    out[ir_out] </span><span class="r19">+=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r16">    </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        </span><span class="r18">&#x27;...ki,bkc-&gt;bc...i&#x27;</span><span class="r14">, u, w</span><span class="r16"> </span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    )  </span><span class="r23"># [num_features, (irreps_x.</span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># ((w3 x + w2) x + w1) x</span><span class="r16">              </span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#  \----------------/</span><span class="r16">                 </span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#         out (in the normal case)</span><span class="r16">    </span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> ir_out </span><span class="r29">in</span><span class="r14"> out:</span><span class="r16">                    </span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(out[ir_out], </span><span class="r17">tuple</span><span class="r14">):</span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    out[ir_out] </span><span class="r19">=</span><span class="r14"> out[ir_out][</span><span class="r19">1</span><span class="r14">]</span><span class="r16">  </span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">continue</span><span class="r14">  </span><span class="r23"># already done (spec</span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">                out[ir_out] </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">einsum(</span><span class="r16">         </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r18">&#x27;bc...ji,bcj-&gt;bc...i&#x27;</span><span class="r14">, out[ir_</span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )  </span><span class="r23"># [num_features, (irreps_x.dim)</span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># ((w3 x + w2) x + w1) x</span><span class="r16">              </span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#  \-------------------/</span><span class="r16">              </span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23">#           out</span><span class="r16">                       </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># out[irrep_out] : [num_features, ir_out.d</span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        irreps_out </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">sorted</span><span class="r14">(out</span><span class="r19">.</span><span class="r14">keys()))</span><span class="r16"> </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># for k, v in out.items():</span><span class="r16">                </span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     debug_structure(**{str(k): v})</span><span class="r16">      </span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> E3IrrepsArray</span><span class="r19">.</span><span class="r14">from_list(</span><span class="r16">           </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            irreps_out,</span><span class="r16">                           </span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            [out[ir][</span><span class="r19">...</span><span class="r14">, </span><span class="r13">None</span><span class="r14">, :] </span><span class="r13">for</span><span class="r14"> (_, ir) </span><span class="r29">in</span><span class="r14"> </span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">input</span><span class="r19">.</span><span class="r14">shape[:</span><span class="r19">-1</span><span class="r14">],</span><span class="r16">                     </span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">EquivariantProductBasisBlock</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">    </span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    target_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">   </span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    off_diagonal: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                    </span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats: E3IrrepsArray,  </span><span class="r23"># [n_nodes, fe</span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_specie: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_nodes, ] i</span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        species_embed: Float[Array, </span><span class="r18">&#x27;num_species e</span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> E3IrrepsArray:</span><span class="r16">                           </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> node_feats</span><span class="r19">.</span><span class="r14">mul_to_axis()</span><span class="r19">.</span><span class="r14">remo</span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> SymmetricContraction(</span><span class="r16">        </span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            keep_irrep_out</span><span class="r19">=</span><span class="r14">{ir </span><span class="r13">for</span><span class="r14"> _, ir </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">t</span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            correlation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation,</span><span class="r16">         </span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_species</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16">         </span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            gradient_normalization</span><span class="r19">=</span><span class="r18">&#x27;element&#x27;</span><span class="r14">,  </span><span class="r23"># N</span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            symmetric_tensor_product_basis</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">sy</span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            off_diagonal</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">off_diagonal,</span><span class="r16">       </span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )(node_feats, node_specie, ctx</span><span class="r19">=</span><span class="r14">ctx, specie</span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> node_feats</span><span class="r19">.</span><span class="r14">axis_to_mul()</span><span class="r16">     </span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Linear(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">target_irreps, name</span><span class="r19">=</span><span class="r18">&#x27;pr</span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MessagePassingConvolution</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">       </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_num_neighbors: </span><span class="r17">float</span><span class="r16">                      </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    target_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell: </span><span class="r17">int</span><span class="r16">                                  </span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    activation: Callable</span><span class="r16">                          </span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    mix: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mix&#x27;</span><span class="r16">                              </span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        vectors: E3IrrepsArray,  </span><span class="r23"># [n_edges, 3]</span><span class="r16">   </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats: E3IrrepsArray,  </span><span class="r23"># [n_nodes, ir</span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        radial_embedding: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges</span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        senders: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges, ]</span><span class="r16">      </span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        receivers: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges, ]</span><span class="r16">    </span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> E3IrrepsArray:</span><span class="r16">                           </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;-&gt; n_nodes irreps&quot;&quot;&quot;</span><span class="r16">                   </span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> node_feats</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r16">               </span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        messages </span><span class="r19">=</span><span class="r14"> node_feats[senders]</span><span class="r16">            </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        messages </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">concatenate(</span><span class="r16">              </span>  
 <span class="r10">  355 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            [</span><span class="r16">                                     </span>  
 <span class="r10">  356 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                messages</span><span class="r19">.</span><span class="r14">filter(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">target_irreps</span>  
 <span class="r10">  357 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">                e3nn</span><span class="r19">.</span><span class="r14">tensor_product(</span><span class="r16">              </span>  
 <span class="r10">  358 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    messages,</span><span class="r16">                     </span>  
 <span class="r10">  359 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    e3nn</span><span class="r19">.</span><span class="r14">spherical_harmonics(</span><span class="r17">range</span>  
 <span class="r10">  360 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    filter_ir_out</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">target_irre</span>  
 <span class="r10">  361 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                ),</span><span class="r16">                                </span>  
 <span class="r10">  362 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># e3nn.tensor_product_with_spheric</span>  
 <span class="r10">  363 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23">#     messages, vectors, self.max_</span>  
 <span class="r10">  364 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># ).filter(self.target_irreps),</span><span class="r16">   </span>  
 <span class="r10">  365 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ]</span><span class="r16">                                     </span>  
 <span class="r10">  366 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r19">.</span><span class="r14">regroup()  </span><span class="r23"># [n_edges, irreps]</span><span class="r16">          </span>  
 <span class="r10">  367 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  368 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># one = E3IrrepsArray.ones(&quot;0e&quot;, edge_attr</span>  
 <span class="r10">  369 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># messages = e3nn.tensor_product(</span><span class="r16">         </span>  
 <span class="r10">  370 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     messages, e3nn.concatenate([one, edg</span>  
 <span class="r10">  371 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># ).filter(self.target_irreps)</span><span class="r16">            </span>  
 <span class="r10">  372 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  373 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># mix = LazyInMLP(</span><span class="r16">                        </span>  
 <span class="r10">  374 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     np.rint(np.linspace(radial_embedding</span>  
 <span class="r10">  375 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     .astype(int)</span><span class="r16">                        </span>  
 <span class="r10">  376 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     .tolist(),</span><span class="r16">                          </span>  
 <span class="r10">  377 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     out_dim=messages.irreps.num_irreps,</span><span class="r16"> </span>  
 <span class="r10">  378 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     inner_act=self.activation,</span><span class="r16">          </span>  
 <span class="r10">  379 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     dropout_rate=0.2,</span><span class="r16">                   </span>  
 <span class="r10">  380 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># )(radial_embedding, ctx)  # [n_edges, nu</span>  
 <span class="r10">  381 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  382 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mix </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;mix&#x27;</span><span class="r14">:</span><span class="r16">                     </span>  
 <span class="r10">  383 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial </span><span class="r19">=</span><span class="r14"> LazyInMLP(</span><span class="r16">                   </span>  
 <span class="r10">  384 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># np.rint(np.linspace(radial_embed</span>  
 <span class="r10">  385 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .astype(int)</span><span class="r16">                    </span>  
 <span class="r10">  386 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .tolist(),</span><span class="r16">                      </span>  
 <span class="r10">  387 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                [],</span><span class="r16">                               </span>  
 <span class="r10">  388 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                out_dim</span><span class="r19">=</span><span class="r14">messages</span><span class="r19">.</span><span class="r14">irreps</span><span class="r19">.</span><span class="r14">num_irreps</span>  
 <span class="r10">  389 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                inner_act</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span><span class="r16">        </span>  
 <span class="r10">  390 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                normalization</span><span class="r19">=</span><span class="r18">&#x27;none&#x27;</span><span class="r14">,</span><span class="r16">             </span>  
 <span class="r10">  391 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                name</span><span class="r19">=</span><span class="r18">&#x27;radial_mix&#x27;</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">  392 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )(radial_embedding, ctx)  </span><span class="r23"># [n_edges, </span>  
 <span class="r10">  393 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  394 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># debug_structure(messages=messages, m</span>  
 <span class="r10">  395 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># debug_stat(messages=messages.array, </span>  
 <span class="r10">  396 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial </span><span class="r19">=</span><span class="r14"> nn</span><span class="r19">.</span><span class="r14">LayerNorm()(radial</span><span class="r19">.</span><span class="r14">array)</span><span class="r16"> </span>  
 <span class="r10">  397 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            messages </span><span class="r19">=</span><span class="r14"> messages </span><span class="r19">*</span><span class="r14"> radial  </span><span class="r23"># [n_edg</span>  
 <span class="r10">  398 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  399 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># debug_structure(messages=messages)</span><span class="r16">  </span>  
 <span class="r10">  400 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  401 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            zeros </span><span class="r19">=</span><span class="r14"> E3IrrepsArray</span><span class="r19">.</span><span class="r14">zeros(messages</span><span class="r19">.</span><span class="r14">i</span>  
 <span class="r10">  402 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> zeros</span><span class="r19">.</span><span class="r14">at[receivers]</span><span class="r19">.</span><span class="r14">add(m</span>  
 <span class="r10">  403 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> node_feats </span><span class="r19">/</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">sqrt(</span><span class="r17">sel</span>  
 <span class="r10">  404 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mix </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;mlpa&#x27;</span><span class="r14">:</span><span class="r16">                  </span>  
 <span class="r10">  405 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial </span><span class="r19">=</span><span class="r14"> LazyInMLP(</span><span class="r16">                   </span>  
 <span class="r10">  406 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># np.rint(np.linspace(radial_embed</span>  
 <span class="r10">  407 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .astype(int)</span><span class="r16">                    </span>  
 <span class="r10">  408 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .tolist(),</span><span class="r16">                      </span>  
 <span class="r10">  409 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                [</span><span class="r19">32</span><span class="r14">],</span><span class="r16">                             </span>  
 <span class="r10">  410 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                out_dim</span><span class="r19">=64</span><span class="r14">,</span><span class="r16">                       </span>  
 <span class="r10">  411 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                inner_act</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span><span class="r16">        </span>  
 <span class="r10">  412 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                normalization</span><span class="r19">=</span><span class="r18">&#x27;none&#x27;</span><span class="r14">,</span><span class="r16">             </span>  
 <span class="r10">  413 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                name</span><span class="r19">=</span><span class="r18">&#x27;radial_msg&#x27;</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">  414 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )(radial_embedding</span><span class="r19">.</span><span class="r14">array, ctx)  </span><span class="r23"># [n_e</span>  
 <span class="r10">  415 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  416 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            x </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">concat(</span><span class="r16">                       </span>  
 <span class="r10">  417 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                [messages</span><span class="r19">.</span><span class="r14">filter(</span><span class="r18">&#x27;0e&#x27;</span><span class="r14">)</span><span class="r19">.</span><span class="r14">array, radi</span>  
 <span class="r10">  418 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )  </span><span class="r23"># [n_edges, num_scalars + 64]</span><span class="r16">      </span>  
 <span class="r10">  419 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  420 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            z </span><span class="r19">=</span><span class="r14"> LazyInMLP(</span><span class="r16">                        </span>  
 <span class="r10">  421 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># np.rint(np.linspace(x.shape[-1],</span>  
 <span class="r10">  422 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .astype(int)</span><span class="r16">                    </span>  
 <span class="r10">  423 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># .tolist(),</span><span class="r16">                      </span>  
 <span class="r10">  424 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                [],</span><span class="r16">                               </span>  
 <span class="r10">  425 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                out_dim</span><span class="r19">=</span><span class="r14">messages</span><span class="r19">.</span><span class="r14">irreps</span><span class="r19">.</span><span class="r14">num_irreps</span>  
 <span class="r10">  426 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                inner_act</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span><span class="r16">        </span>  
 <span class="r10">  427 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                normalization</span><span class="r19">=</span><span class="r18">&#x27;none&#x27;</span><span class="r14">,</span><span class="r16">             </span>  
 <span class="r10">  428 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                name</span><span class="r19">=</span><span class="r18">&#x27;msg_attention&#x27;</span><span class="r14">,</span><span class="r16">             </span>  
 <span class="r10">  429 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )(x, ctx)</span><span class="r16">                             </span>  
 <span class="r10">  430 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  431 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            a </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">exp(z)  </span><span class="r23"># [n_edges, num_irreps</span>  
 <span class="r10">  432 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  433 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            normalization </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">zeros((node_feats</span><span class="r19">.</span>  
 <span class="r10">  434 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            normalization </span><span class="r19">=</span><span class="r14"> normalization</span><span class="r19">.</span><span class="r14">at[recei</span>  
 <span class="r10">  435 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  436 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            att </span><span class="r19">=</span><span class="r14"> a </span><span class="r19">/</span><span class="r14"> (normalization[receivers] </span><span class="r19">+</span><span class="r14"> </span>  
 <span class="r10">  437 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  438 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># debug_stat(att=att, a=a, norm=normal</span>  
 <span class="r10">  439 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  440 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            zeros </span><span class="r19">=</span><span class="r14"> E3IrrepsArray</span><span class="r19">.</span><span class="r14">zeros(messages</span><span class="r19">.</span><span class="r14">i</span>  
 <span class="r10">  441 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> zeros</span><span class="r19">.</span><span class="r14">at[receivers]</span><span class="r19">.</span><span class="r14">add(m</span>  
 <span class="r10">  442 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  443 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> node_feats</span><span class="r16">                         </span>  
 <span class="r10">  444 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  445 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  446 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">InteractionBlock</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">                </span>  
 <span class="r10">  447 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    conv: MessagePassingConvolution</span><span class="r16">               </span>  
 <span class="r10">  448 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  449 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">  450 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  451 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  452 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        vectors: E3IrrepsArray,  </span><span class="r23"># [n_edges, 3]</span><span class="r16">   </span>  
 <span class="r10">  453 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats: E3IrrepsArray,  </span><span class="r23"># [n_nodes, ir</span>  
 <span class="r10">  454 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        radial_embedding: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges</span>  
 <span class="r10">  455 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        senders: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges, ]</span><span class="r16">      </span>  
 <span class="r10">  456 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        receivers: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges, ]</span><span class="r16">    </span>  
 <span class="r10">  457 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  458 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">tuple</span><span class="r14">[E3IrrepsArray, E3IrrepsArray]:</span><span class="r16">     </span>  
 <span class="r10">  459 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;-&gt; n_nodes irreps&quot;&quot;&quot;</span><span class="r16">                   </span>  
 <span class="r10">  460 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> node_feats</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r16">               </span>  
 <span class="r10">  461 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> vectors</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                  </span>  
 <span class="r10">  462 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> radial_embedding</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r16">         </span>  
 <span class="r10">  463 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  464 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> Linear(node_feats</span><span class="r19">.</span><span class="r14">irreps, nam</span>  
 <span class="r10">  465 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># debug_stat(up=node_feats.array)</span><span class="r16">         </span>  
 <span class="r10">  466 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> E3NormNorm()(node_feats)</span><span class="r16">     </span>  
 <span class="r10">  467 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  468 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">conv(vectors, node_feats</span>  
 <span class="r10">  469 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> E3NormNorm()(node_feats)</span><span class="r16">     </span>  
 <span class="r10">  470 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># debug_stat(conv=node_feats.array)</span><span class="r16">       </span>  
 <span class="r10">  471 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  472 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     3 </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> Linear(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">conv</span><span class="r19">.</span><span class="r14">target_irrep</span>  
 <span class="r10">  473 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> E3NormNorm()(node_feats)</span><span class="r16">     </span>  
 <span class="r10">  474 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># debug_stat(down=node_feats.array)</span><span class="r16">       </span>  
 <span class="r10">  475 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  476 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> node_feats</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r16">               </span>  
 <span class="r10">  477 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> node_feats  </span><span class="r23"># [n_nodes, target_irre</span>  
 <span class="r10">  478 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  479 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  480 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">try</span><span class="r14">:</span><span class="r16">                                              </span>  
 <span class="r10">  481 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">profile_nn_jax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> profile</span><span class="r16">            </span>  
 <span class="r10">  482 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">except</span><span class="r14"> </span><span class="r26">ImportError</span><span class="r14">:</span><span class="r16">                               </span>  
 <span class="r10">  483 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  484 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">profile</span><span class="r14">(_, x, __</span><span class="r19">=</span><span class="r13">None</span><span class="r14">):</span><span class="r16">                   </span>  
 <span class="r10">  485 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> x</span><span class="r16">                                  </span>  
 <span class="r10">  486 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  487 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  488 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MACELayer</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">                       </span>  
 <span class="r10">  489 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    first: </span><span class="r17">bool</span><span class="r16">                                   </span>  
 <span class="r10">  490 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    last: </span><span class="r17">bool</span><span class="r16">                                    </span>  
 <span class="r10">  491 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_features: </span><span class="r17">int</span><span class="r16">                             </span>  
 <span class="r10">  492 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    interaction_irreps: E3Irreps</span><span class="r16">                  </span>  
 <span class="r10">  493 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">  494 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    activation: Callable</span><span class="r16">                          </span>  
 <span class="r10">  495 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  496 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    epsilon: Optional[</span><span class="r17">float</span><span class="r14">]</span><span class="r16">                      </span>  
 <span class="r10">  497 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    name: Optional[</span><span class="r17">str</span><span class="r14">]</span><span class="r16">                           </span>  
 <span class="r10">  498 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># InteractionBlock:</span><span class="r16">                           </span>  
 <span class="r10">  499 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell: </span><span class="r17">int</span><span class="r16">                                  </span>  
 <span class="r10">  500 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_num_neighbors: </span><span class="r17">float</span><span class="r16">                      </span>  
 <span class="r10">  501 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># EquivariantProductBasisBlock:</span><span class="r16">               </span>  
 <span class="r10">  502 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  503 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis: </span><span class="r17">bool</span><span class="r16">          </span>  
 <span class="r10">  504 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    off_diagonal: </span><span class="r17">bool</span><span class="r16">                            </span>  
 <span class="r10">  505 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    soft_normalization: Optional[</span><span class="r17">float</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">  506 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># ReadoutBlock:</span><span class="r16">                               </span>  
 <span class="r10">  507 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_irreps: E3Irreps</span><span class="r16">                       </span>  
 <span class="r10">  508 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_mlp_irreps: E3Irreps</span><span class="r16">                  </span>  
 <span class="r10">  509 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    skip_connection_first_layer: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">     </span>  
 <span class="r10">  510 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  511 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@nn</span><span class="r19">.</span><span class="r14">compact</span><span class="r16">                                   </span>  
 <span class="r10">  512 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  513 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  514 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        vectors: E3IrrepsArray,  </span><span class="r23"># [n_edges, 3]</span><span class="r16">   </span>  
 <span class="r10">  515 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats: E3IrrepsArray,  </span><span class="r23"># [n_nodes, ir</span>  
 <span class="r10">  516 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_species: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_nodes] in</span>  
 <span class="r10">  517 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        radial_embedding: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges</span>  
 <span class="r10">  518 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        senders: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges]</span><span class="r16">        </span>  
 <span class="r10">  519 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        receivers: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges]</span><span class="r16">      </span>  
 <span class="r10">  520 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  521 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        species_embed: Float[Array, </span><span class="r18">&#x27;num_species n</span>  
 <span class="r10">  522 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_mask: Optional[jnp</span><span class="r19">.</span><span class="r14">ndarray] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,  </span>  
 <span class="r10">  523 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ):</span><span class="r16">                                            </span>  
 <span class="r10">  524 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;-&gt; (n_nodes output_irreps, n_nodes feat</span>  
 <span class="r10">  525 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> node_mask </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                     </span>  
 <span class="r10">  526 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_mask </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">ones(node_species</span><span class="r19">.</span><span class="r14">shap</span>  
 <span class="r10">  527 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  528 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        hidden_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irrep</span>  
 <span class="r10">  529 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        output_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irrep</span>  
 <span class="r10">  530 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        interaction_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">interac</span>  
 <span class="r10">  531 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        readout_mlp_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">readout</span>  
 <span class="r10">  532 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  533 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        sc </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                                 </span>  
 <span class="r10">  534 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># if not self.first or self.skip_connectio</span>  
 <span class="r10">  535 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     sc = Linear(</span><span class="r16">                        </span>  
 <span class="r10">  536 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         self.num_features * hidden_irrep</span>  
 <span class="r10">  537 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         num_indexed_weights=self.num_spe</span>  
 <span class="r10">  538 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         gradient_normalization=&#x27;path&#x27;,</span><span class="r16">  </span>  
 <span class="r10">  539 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         name=&#x27;skip_tp&#x27;,</span><span class="r16">                 </span>  
 <span class="r10">  540 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     )(node_species, node_feats)  # [n_no</span>  
 <span class="r10">  541 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     sc = E3NormNorm()(sc)</span><span class="r16">               </span>  
 <span class="r10">  542 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     sc = profile(f&#x27;{self.name}: self-con</span>  
 <span class="r10">  543 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  544 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> InteractionBlock(</span><span class="r16">            </span>  
 <span class="r10">  545 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            MessagePassingConvolution(</span><span class="r16">            </span>  
 <span class="r10">  546 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                target_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features </span><span class="r19">*</span><span class="r14"> </span>  
 <span class="r10">  547 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                avg_num_neighbors</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_num_nei</span>  
 <span class="r10">  548 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                max_ell</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_ell,</span><span class="r16">             </span>  
 <span class="r10">  549 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                activation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span><span class="r16">       </span>  
 <span class="r10">  550 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  551 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )(</span><span class="r16">                                        </span>  
 <span class="r10">  552 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            vectors</span><span class="r19">=</span><span class="r14">vectors,</span><span class="r16">                      </span>  
 <span class="r10">  553 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats</span><span class="r19">=</span><span class="r14">node_feats,</span><span class="r16">                </span>  
 <span class="r10">  554 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial_embedding</span><span class="r19">=</span><span class="r14">radial_embedding,</span><span class="r16">    </span>  
 <span class="r10">  555 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            receivers</span><span class="r19">=</span><span class="r14">receivers,</span><span class="r16">                  </span>  
 <span class="r10">  556 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            senders</span><span class="r19">=</span><span class="r14">senders,</span><span class="r16">                      </span>  
 <span class="r10">  557 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ctx</span><span class="r19">=</span><span class="r14">ctx,</span><span class="r16">                              </span>  
 <span class="r10">  558 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  559 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  560 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">epsilon </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">              </span>  
 <span class="r10">  561 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">*=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">epsilon</span><span class="r16">            </span>  
 <span class="r10">  562 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  563 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">/=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">sqrt(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_num_ne</span>  
 <span class="r10">  564 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  565 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> profile(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">name</span><span class="r25">}</span><span class="r18">: intera</span>  
 <span class="r10">  566 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  567 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># if self.first:</span><span class="r16">                          </span>  
 <span class="r10">  568 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     # Selector TensorProduct</span><span class="r16">            </span>  
 <span class="r10">  569 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     node_feats = Linear(</span><span class="r16">                </span>  
 <span class="r10">  570 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         self.num_features * interaction_</span>  
 <span class="r10">  571 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         num_indexed_weights=self.num_spe</span>  
 <span class="r10">  572 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         gradient_normalization=&#x27;path&#x27;,</span><span class="r16">  </span>  
 <span class="r10">  573 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#         name=&#x27;skip_tp_first&#x27;,</span><span class="r16">           </span>  
 <span class="r10">  574 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     )(node_species, node_feats)</span><span class="r16">         </span>  
 <span class="r10">  575 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23">#     node_feats = profile(f&#x27;{self.name}: </span>  
 <span class="r10">  576 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  577 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> EquivariantProductBasisBlock(</span>  
 <span class="r10">  578 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            target_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features </span><span class="r19">*</span><span class="r14"> hidd</span>  
 <span class="r10">  579 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            correlation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation,</span><span class="r16">         </span>  
 <span class="r10">  580 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_species</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16">         </span>  
 <span class="r10">  581 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            symmetric_tensor_product_basis</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">sy</span>  
 <span class="r10">  582 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            off_diagonal</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">off_diagonal,</span><span class="r16">       </span>  
 <span class="r10">  583 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )(node_feats</span><span class="r19">=</span><span class="r14">node_feats, node_specie</span><span class="r19">=</span><span class="r14">node_</span>  
 <span class="r10">  584 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  585 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> profile(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">name</span><span class="r25">}</span><span class="r18">: tensor</span>  
 <span class="r10">  586 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  587 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">soft_normalization </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">   </span>  
 <span class="r10">  588 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  589 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">def</span><span class="r14"> </span><span class="r24">phi</span><span class="r14">(n):</span><span class="r16">                           </span>  
 <span class="r10">  590 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                n </span><span class="r19">=</span><span class="r14"> n </span><span class="r19">/</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">soft_normalization</span><span class="r16">   </span>  
 <span class="r10">  591 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">return</span><span class="r14"> </span><span class="r19">1.0</span><span class="r14"> </span><span class="r19">/</span><span class="r14"> (</span><span class="r19">1.0</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> n </span><span class="r19">*</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">sus(n</span>  
 <span class="r10">  592 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  593 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">norm_activation(node</span>  
 <span class="r10">  594 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  595 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> profile(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">name</span><span class="r25">}</span><span class="r18">: so</span>  
 <span class="r10">  596 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  597 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> node_feats</span><span class="r16">               </span>  
 <span class="r10">  598 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  599 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> sc </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  600 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> node_feats </span><span class="r19">+</span><span class="r14"> sc  </span><span class="r23"># [n_nod</span>  
 <span class="r10">  601 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  602 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">last:</span><span class="r16">                         </span>  
 <span class="r10">  603 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_outputs </span><span class="r19">=</span><span class="r14"> LinearReadoutBlock(outp</span>  
 <span class="r10">  604 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:  </span><span class="r23"># Non linear readout for last layer</span>  
 <span class="r10">  605 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_outputs </span><span class="r19">=</span><span class="r14"> NonLinearReadoutBlock(</span><span class="r16"> </span>  
 <span class="r10">  606 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                readout_mlp_irreps,</span><span class="r16">               </span>  
 <span class="r10">  607 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                output_irreps,</span><span class="r16">                    </span>  
 <span class="r10">  608 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                activation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">activation,</span><span class="r16">       </span>  
 <span class="r10">  609 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )(node_feats)  </span><span class="r23"># [n_nodes, output_irre</span>  
 <span class="r10">  610 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  611 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_outputs </span><span class="r19">=</span><span class="r14"> profile(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">name</span><span class="r25">}</span><span class="r18">: outp</span>  
 <span class="r10">  612 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> node_outputs, node_feats</span><span class="r16">           </span>  
 <span class="r10">  613 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  614 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  615 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">safe_norm</span><span class="r14">(x: jnp</span><span class="r19">.</span><span class="r14">ndarray, axis: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">, ke</span>  
 <span class="r10">  616 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;nan-safe norm.&quot;&quot;&quot;</span><span class="r16">                          </span>  
 <span class="r10">  617 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    x2 </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">sum(x</span><span class="r19">**2</span><span class="r14">, axis</span><span class="r19">=</span><span class="r14">axis, keepdims</span><span class="r19">=</span><span class="r14">keepdim</span>  
 <span class="r10">  618 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">where(x2 </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0.0</span><span class="r14">, </span><span class="r19">0.0</span><span class="r14">, jnp</span><span class="r19">.</span><span class="r14">where(x2 </span>  
 <span class="r10">  619 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  620 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  621 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MACE</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">                            </span>  
 <span class="r10">  622 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_basis: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span><span class="r19">.</span><span class="r14">ndar</span>  
 <span class="r10">  623 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_envelope: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  624 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_irreps: E3Irreps  </span><span class="r23"># Irreps of the outpu</span>  
 <span class="r10">  625 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    r_max: </span><span class="r17">float</span><span class="r16">                                  </span>  
 <span class="r10">  626 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_r_min: </span><span class="r17">float</span><span class="r16">                              </span>  
 <span class="r10">  627 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_interactions: </span><span class="r17">int</span><span class="r14">  </span><span class="r23"># Number of interaction</span>  
 <span class="r10">  628 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps: E3Irreps  </span><span class="r23"># 256x0e or 128x0e + </span>  
 <span class="r10">  629 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_mlp_irreps: E3Irreps  </span><span class="r23"># Hidden irreps </span>  
 <span class="r10">  630 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_num_neighbors: </span><span class="r17">float</span><span class="r16">                      </span>  
 <span class="r10">  631 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  632 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_basis: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span><span class="r19">.</span><span class="r14">ndar</span>  
 <span class="r10">  633 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_envelope: Callable[[jnp</span><span class="r19">.</span><span class="r14">ndarray], jnp</span><span class="r19">.</span><span class="r14">n</span>  
 <span class="r10">  634 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of zero derivatives at small and larg</span>  
 <span class="r10">  635 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># If both are None, it uses a smooth C^inf env</span>  
 <span class="r10">  636 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">3</span><span class="r14">  </span><span class="r23"># Max spherical harmonic deg</span>  
 <span class="r10">  637 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    epsilon: Optional[</span><span class="r17">float</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">               </span>  
 <span class="r10">  638 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">3</span><span class="r14">  </span><span class="r23"># Correlation order at e</span>  
 <span class="r10">  639 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    gate: Callable </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">nn</span><span class="r19">.</span><span class="r14">silu  </span><span class="r23"># activation fun</span>  
 <span class="r10">  640 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    soft_normalization: Optional[</span><span class="r17">float</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">    </span>  
 <span class="r10">  641 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">   </span>  
 <span class="r10">  642 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    off_diagonal: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                    </span>  
 <span class="r10">  643 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    interaction_irreps: Union[</span><span class="r17">str</span><span class="r14">, E3Irreps] </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;o3</span>  
 <span class="r10">  644 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_embedding_type: </span><span class="r17">type</span><span class="r14">[nn</span><span class="r19">.</span><span class="r14">Module] </span><span class="r19">=</span><span class="r14"> LinearN</span>  
 <span class="r10">  645 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    share_species_embed: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">              </span>  
 <span class="r10">  646 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    skip_connection_first_layer: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">     </span>  
 <span class="r10">  647 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of features per node, default gcd of </span>  
 <span class="r10">  648 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_features: Optional[</span><span class="r17">int</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">            </span>  
 <span class="r10">  649 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  650 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    global_proj_templ: LazyInMLP </span><span class="r19">=</span><span class="r14"> LazyInMLP([])</span><span class="r16">  </span>  
 <span class="r10">  651 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  652 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">setup</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                              </span>  
 <span class="r10">  653 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">ou</span>  
 <span class="r10">  654 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hi</span>  
 <span class="r10">  655 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">readout_mlp_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">se</span>  
 <span class="r10">  656 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  657 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">             </span>  
 <span class="r10">  658 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features_calc </span><span class="r19">=</span><span class="r14"> functools</span><span class="r19">.</span><span class="r14">red</span>  
 <span class="r10">  659 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                math</span><span class="r19">.</span><span class="r14">gcd, (mul </span><span class="r13">for</span><span class="r14"> mul, _ </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span>  
 <span class="r10">  660 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  661 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  662 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features_calc </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_feat</span>  
 <span class="r10">  663 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  664 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r16">       </span>  
 <span class="r10">  665 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            [(mul </span><span class="r19">//</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features_calc, ir) </span><span class="r13">f</span>  
 <span class="r10">  666 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  667 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  668 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_irreps </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;o3_restrict</span>  
 <span class="r10">  669 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irrep</span>  
 <span class="r10">  670 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_irreps </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;o3_full&#x27;</span><span class="r14">:</span>  
 <span class="r10">  671 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irrep</span>  
 <span class="r10">  672 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  673 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_irreps_calc </span><span class="r19">=</span><span class="r14"> E3Irrep</span>  
 <span class="r10">  674 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  675 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># Embeddings</span><span class="r16">                              </span>  
 <span class="r10">  676 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_embedding </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_embedding_</span>  
 <span class="r10">  677 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features_ca</span>  
 <span class="r10">  678 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  679 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_embedding </span><span class="r19">=</span><span class="r14"> RadialEmbeddingBlo</span>  
 <span class="r10">  680 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            r_max</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">r_max,</span><span class="r16">                     </span>  
 <span class="r10">  681 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            avg_r_min</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_r_min,</span><span class="r16">             </span>  
 <span class="r10">  682 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            basis_functions</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_basis,</span><span class="r16">    </span>  
 <span class="r10">  683 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            envelope_function</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_envelope</span>  
 <span class="r10">  684 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  685 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  686 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        layers </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                               </span>  
 <span class="r10">  687 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> i </span><span class="r29">in</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_interactions):</span><span class="r16">    </span>  
 <span class="r10">  688 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            first </span><span class="r19">=</span><span class="r14"> i </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                        </span>  
 <span class="r10">  689 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            last </span><span class="r19">=</span><span class="r14"> i </span><span class="r19">==</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_interactions </span><span class="r19">-</span><span class="r14"> </span><span class="r19">1</span><span class="r16"> </span>  
 <span class="r10">  690 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            hidden_irreps </span><span class="r19">=</span><span class="r14"> (</span><span class="r16">                     </span>  
 <span class="r10">  691 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irreps_calc)</span><span class="r16"> </span>  
 <span class="r10">  692 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> last</span><span class="r16">                       </span>  
 <span class="r10">  693 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">else</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irreps_c</span>  
 <span class="r10">  694 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  695 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  696 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># to output just a vector, there needs</span>  
 <span class="r10">  697 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># sure why the above code filters the </span>  
 <span class="r10">  698 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            hidden_irreps </span><span class="r19">=</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_i</span>  
 <span class="r10">  699 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            layers</span><span class="r19">.</span><span class="r14">append(</span><span class="r16">                        </span>  
 <span class="r10">  700 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                MACELayer(</span><span class="r16">                        </span>  
 <span class="r10">  701 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    first</span><span class="r19">=</span><span class="r14">first,</span><span class="r16">                  </span>  
 <span class="r10">  702 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    last</span><span class="r19">=</span><span class="r14">last,</span><span class="r16">                    </span>  
 <span class="r10">  703 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    num_features</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features</span>  
 <span class="r10">  704 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    interaction_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">intera</span>  
 <span class="r10">  705 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    hidden_irreps</span><span class="r19">=</span><span class="r14">hidden_irreps,</span><span class="r16">  </span>  
 <span class="r10">  706 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    max_ell</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_ell,</span><span class="r16">         </span>  
 <span class="r10">  707 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    avg_num_neighbors</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_num</span>  
 <span class="r10">  708 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    activation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">gate,</span><span class="r16">         </span>  
 <span class="r10">  709 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    num_species</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16"> </span>  
 <span class="r10">  710 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    epsilon</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">epsilon,</span><span class="r16">         </span>  
 <span class="r10">  711 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    correlation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation,</span><span class="r16"> </span>  
 <span class="r10">  712 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    output_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irre</span>  
 <span class="r10">  713 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    readout_mlp_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">readou</span>  
 <span class="r10">  714 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    symmetric_tensor_product_basis</span>  
 <span class="r10">  715 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    off_diagonal</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">off_diagonal</span>  
 <span class="r10">  716 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    soft_normalization</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">soft_n</span>  
 <span class="r10">  717 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    skip_connection_first_layer</span><span class="r19">=</span><span class="r17">se</span>  
 <span class="r10">  718 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    name</span><span class="r19">=</span><span class="r18">f&#x27;layer_</span><span class="r25">{</span><span class="r14">i</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">,</span><span class="r16">            </span>  
 <span class="r10">  719 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  720 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  721 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  722 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">layers </span><span class="r19">=</span><span class="r14"> layers</span><span class="r16">                      </span>  
 <span class="r10">  723 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  724 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">global_proj_mlp </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">global_proj_te</span>  
 <span class="r10">  725 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  726 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  727 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  728 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        vectors: E3IrrepsArray,  </span><span class="r23"># [n_edges, 3]</span><span class="r16">   </span>  
 <span class="r10">  729 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_species: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_nodes] in</span>  
 <span class="r10">  730 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        senders: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges]</span><span class="r16">        </span>  
 <span class="r10">  731 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        receivers: jnp</span><span class="r19">.</span><span class="r14">ndarray,  </span><span class="r23"># [n_edges]</span><span class="r16">      </span>  
 <span class="r10">  732 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  733 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        extra_node_features: jnp</span><span class="r19">.</span><span class="r14">ndarray </span><span class="r19">|</span><span class="r14"> </span><span class="r13">None</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span>  
 <span class="r10">  734 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_mask: Optional[jnp</span><span class="r19">.</span><span class="r14">ndarray] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">,  </span>  
 <span class="r10">  735 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r19">-&gt;</span><span class="r14"> E3IrrepsArray:</span><span class="r16">                           </span>  
 <span class="r10">  736 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;</span><span class="r16">                                       </span>  
 <span class="r10">  737 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        global_features: latent vector to be incor</span>  
 <span class="r10">  738 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        -&gt; n_nodes num_interactions output_irreps</span><span class="r16"> </span>  
 <span class="r10">  739 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">        &quot;&quot;&quot;</span><span class="r16">                                       </span>  
 <span class="r10">  740 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> vectors</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">2</span><span class="r14"> </span><span class="r29">and</span><span class="r14"> vectors</span><span class="r19">.</span><span class="r14">shape</span>  
 <span class="r10">  741 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> node_species</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r16">             </span>  
 <span class="r10">  742 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> senders</span><span class="r19">.</span><span class="r14">ndim </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r14"> </span><span class="r29">and</span><span class="r14"> receivers</span><span class="r19">.</span><span class="r14">ndi</span>  
 <span class="r10">  743 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">assert</span><span class="r14"> vectors</span><span class="r19">.</span><span class="r14">shape[</span><span class="r19">0</span><span class="r14">] </span><span class="r19">==</span><span class="r14"> senders</span><span class="r19">.</span><span class="r14">shape[</span><span class="r19">0</span>  
 <span class="r10">  744 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  745 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> node_mask </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                     </span>  
 <span class="r10">  746 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_mask </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">ones(node_species</span><span class="r19">.</span><span class="r14">shap</span>  
 <span class="r10">  747 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  748 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># Embeddings</span><span class="r16">                              </span>  
 <span class="r10">  749 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        node_feats </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_embedding(node_spec</span>  
 <span class="r10">  750 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            vectors</span><span class="r19">.</span><span class="r14">dtype</span><span class="r16">                         </span>  
 <span class="r10">  751 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )  </span><span class="r23"># [n_nodes, feature * irreps]</span><span class="r16">          </span>  
 <span class="r10">  752 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  753 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> extra_node_features </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">       </span>  
 <span class="r10">  754 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feat_arr </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">global_proj_mlp(</span><span class="r16"> </span>  
 <span class="r10">  755 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                jnp</span><span class="r19">.</span><span class="r14">concat([node_feats</span><span class="r19">.</span><span class="r14">array, extr</span>  
 <span class="r10">  756 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  757 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_feats </span><span class="r19">=</span><span class="r14"> E3IrrepsArray(node_feats</span><span class="r19">.</span>  
 <span class="r10">  758 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  759 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(node_feats)</span><span class="r16">                       </span>  
 <span class="r10">  760 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  761 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> (</span><span class="r17">hasattr</span><span class="r14">(vectors, </span><span class="r18">&#x27;irreps&#x27;</span><span class="r14">) </span><span class="r29">and</span><span class="r14"> </span><span class="r17">has</span>  
 <span class="r10">  762 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            vectors </span><span class="r19">=</span><span class="r14"> E3IrrepsArray(</span><span class="r18">&#x27;1o&#x27;</span><span class="r14">, vectors)</span>  
 <span class="r10">  763 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  764 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        radial_embedding </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_embedding(s</span>  
 <span class="r10">  765 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># debug_structure(radial_embedding=radial_</span>  
 <span class="r10">  766 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  767 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># Interactions</span><span class="r16">                            </span>  
 <span class="r10">  768 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        outputs </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                              </span>  
 <span class="r10">  769 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> i </span><span class="r29">in</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_interactions):</span><span class="r16">    </span>  
 <span class="r10">  770 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_outputs, node_feats </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">layers</span>  
 <span class="r10">  771 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                vectors,</span><span class="r16">                          </span>  
 <span class="r10">  772 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                node_feats,</span><span class="r16">                       </span>  
 <span class="r10">  773 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                node_species,</span><span class="r16">                     </span>  
 <span class="r10">  774 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                radial_embedding,</span><span class="r16">                 </span>  
 <span class="r10">  775 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                senders,</span><span class="r16">                          </span>  
 <span class="r10">  776 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                receivers,</span><span class="r16">                        </span>  
 <span class="r10">  777 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                node_mask</span><span class="r19">=</span><span class="r14">node_mask,</span><span class="r16">              </span>  
 <span class="r10">  778 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                ctx</span><span class="r19">=</span><span class="r14">ctx,</span><span class="r16">                          </span>  
 <span class="r10">  779 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                species_embed</span><span class="r19">=</span><span class="r14">node_feats</span><span class="r19">.</span><span class="r14">array </span><span class="r13">if</span><span class="r14"> </span>  
 <span class="r10">  780 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  781 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            outputs </span><span class="r19">+=</span><span class="r14"> [node_outputs]  </span><span class="r23"># list of [</span>  
 <span class="r10">  782 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  783 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print([k.shape for k in outputs])</span><span class="r16">       </span>  
 <span class="r10">  784 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">stack(outputs, axis</span><span class="r19">=1</span><span class="r14">)  </span><span class="r23"># [n_n</span>  
 <span class="r10">  785 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  786 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  787 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">MaceModel</span><span class="r14">(nn</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">                       </span>  
 <span class="r10">  788 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Graph network that wraps MACE.&quot;&quot;&quot;</span><span class="r16">          </span>  
 <span class="r10">  789 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  790 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_species: </span><span class="r17">int</span><span class="r16">                              </span>  
 <span class="r10">  791 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_graph_irreps: </span><span class="r17">str</span><span class="r14">  </span><span class="r23"># output irreps, 1x0</span>  
 <span class="r10">  792 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_node_irreps: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r13">None</span><span class="r14">  </span><span class="r23"># output by-no</span>  
 <span class="r10">  793 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps: </span><span class="r17">str</span><span class="r14">  </span><span class="r23"># 256x0e or 128x0e + 128x1</span>  
 <span class="r10">  794 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_mlp_irreps: </span><span class="r17">str</span><span class="r14">  </span><span class="r23"># Hidden irreps of th</span>  
 <span class="r10">  795 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  796 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_interactions: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r14">  </span><span class="r23"># Number of interac</span>  
 <span class="r10">  797 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  798 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># How to combine the outputs of different inte</span>  
 <span class="r10">  799 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># &#x27;last&#x27; is special: it means the last block.</span><span class="r16"> </span>  
 <span class="r10">  800 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    interaction_reduction: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mean&#x27;</span><span class="r16">           </span>  
 <span class="r10">  801 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Node reduction.</span><span class="r16">                             </span>  
 <span class="r10">  802 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    node_reduction: SegmentReductionKind </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;mean&#x27;</span><span class="r16"> </span>  
 <span class="r10">  803 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  804 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_radial_embeds: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">10</span><span class="r16">                   </span>  
 <span class="r10">  805 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_r: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">7.0</span><span class="r16">                            </span>  
 <span class="r10">  806 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_r_min: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1.0</span><span class="r16">                        </span>  
 <span class="r10">  807 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_envelope_scale: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">              </span>  
 <span class="r10">  808 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    radial_envelope_intercept: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1.2</span><span class="r16">        </span>  
 <span class="r10">  809 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  810 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    avg_num_neighbors: </span><span class="r17">float</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">20.0</span><span class="r16">               </span>  
 <span class="r10">  811 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  812 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">3</span><span class="r14">  </span><span class="r23"># Max spherical harmonic deg</span>  
 <span class="r10">  813 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r14">  </span><span class="r23"># Correlation order at e</span>  
 <span class="r10">  814 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  815 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># If a float, soft norms values to stay in thi</span>  
 <span class="r10">  816 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    soft_normalization: Optional[</span><span class="r17">float</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">    </span>  
 <span class="r10">  817 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  818 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">   </span>  
 <span class="r10">  819 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    off_diagonal: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                    </span>  
 <span class="r10">  820 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    interaction_irreps: Union[</span><span class="r17">str</span><span class="r14">, E3Irreps] </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;o3</span>  
 <span class="r10">  821 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    skip_connection_first_layer: </span><span class="r17">bool</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">     </span>  
 <span class="r10">  822 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># Number of features per node, default gcd of </span>  
 <span class="r10">  823 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_features: Optional[</span><span class="r17">int</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">            </span>  
 <span class="r10">  824 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  825 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">setup</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                              </span>  
 <span class="r10">  826 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">bessel_basis</span><span class="r14">(length, max_length):</span><span class="r16">     </span>  
 <span class="r10">  827 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     7 </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">bessel(length, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_ra</span>  
 <span class="r10">  828 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  829 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">soft_envelope</span><span class="r14">(length, max_length):</span><span class="r16">    </span>  
 <span class="r10">  830 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     8 </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">soft_envelope(</span><span class="r16">            </span>  
 <span class="r10">  831 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                length,</span><span class="r16">                           </span>  
 <span class="r10">  832 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                max_length,</span><span class="r16">                       </span>  
 <span class="r10">  833 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                arg_multiplicator</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_enve</span>  
 <span class="r10">  834 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                value_at_origin</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">radial_envelo</span>  
 <span class="r10">  835 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  836 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  837 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mace </span><span class="r19">=</span><span class="r14"> MACE(</span><span class="r16">                         </span>  
 <span class="r10">  838 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            output_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_irreps,</span><span class="r16">     </span>  
 <span class="r10">  839 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            r_max</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_r,</span><span class="r16">                     </span>  
 <span class="r10">  840 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_interactions</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_interactions</span>  
 <span class="r10">  841 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            avg_r_min</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_r_min,</span><span class="r16">             </span>  
 <span class="r10">  842 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            hidden_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">hidden_irreps,</span><span class="r16">     </span>  
 <span class="r10">  843 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            readout_mlp_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">readout_mlp_ir</span>  
 <span class="r10">  844 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            avg_num_neighbors</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">avg_num_neighbo</span>  
 <span class="r10">  845 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_species</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16">         </span>  
 <span class="r10">  846 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_features</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_features,</span><span class="r16">       </span>  
 <span class="r10">  847 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            max_ell</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">max_ell,</span><span class="r16">                 </span>  
 <span class="r10">  848 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            epsilon</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                         </span>  
 <span class="r10">  849 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            correlation</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">correlation,</span><span class="r16">         </span>  
 <span class="r10">  850 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            gate</span><span class="r19">=</span><span class="r14">nn</span><span class="r19">.</span><span class="r14">tanh,</span><span class="r16">                         </span>  
 <span class="r10">  851 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            soft_normalization</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">soft_normaliza</span>  
 <span class="r10">  852 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            symmetric_tensor_product_basis</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">sy</span>  
 <span class="r10">  853 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            off_diagonal</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">off_diagonal,</span><span class="r16">       </span>  
 <span class="r10">  854 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            interaction_irreps</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_ir</span>  
 <span class="r10">  855 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_embedding_type</span><span class="r19">=</span><span class="r14">LinearNodeEmbeddin</span>  
 <span class="r10">  856 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            skip_connection_first_layer</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">skip_</span>  
 <span class="r10">  857 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial_basis</span><span class="r19">=</span><span class="r14">bessel_basis,</span><span class="r16">            </span>  
 <span class="r10">  858 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            radial_envelope</span><span class="r19">=</span><span class="r14">soft_envelope,</span><span class="r16">        </span>  
 <span class="r10">  859 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  860 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  861 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction_mods </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">              </span>  
 <span class="r10">  862 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            SegmentReduction(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction)</span><span class="r16"> </span>  
 <span class="r10">  863 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> _chunk </span><span class="r29">in</span><span class="r14"> E3Irreps(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_gra</span>  
 <span class="r10">  864 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ]</span><span class="r16">                                         </span>  
 <span class="r10">  865 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  866 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__call__</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  867 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  868 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        cg: CrystalGraphs,</span><span class="r16">                        </span>  
 <span class="r10">  869 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ctx: Context,</span><span class="r16">                             </span>  
 <span class="r10">  870 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        global_feats: Float[Array, </span><span class="r18">&#x27;graphs latent&#x27;</span>  
 <span class="r10">  871 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ):</span><span class="r16">                                            </span>  
 <span class="r10">  872 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        vecs </span><span class="r19">=</span><span class="r14"> edge_vecs(cg)</span><span class="r16">                      </span>  
 <span class="r10">  873 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  874 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> global_feats </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                  </span>  
 <span class="r10">  875 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            extra_node_feats </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">               </span>  
 <span class="r10">  876 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  877 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            extra_node_feats </span><span class="r19">=</span><span class="r14"> global_feats[cg</span><span class="r19">.</span><span class="r14">nod</span>  
 <span class="r10">  878 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  879 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># shape [n_nodes, n_interactions, output_i</span>  
 <span class="r10">  880 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mace(</span><span class="r16">                          </span>  
 <span class="r10">  881 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            vecs,</span><span class="r16">                                 </span>  
 <span class="r10">  882 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cg</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">species,</span><span class="r16">                     </span>  
 <span class="r10">  883 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cg</span><span class="r19">.</span><span class="r14">senders,</span><span class="r16">                           </span>  
 <span class="r10">  884 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            cg</span><span class="r19">.</span><span class="r14">receivers,</span><span class="r16">                         </span>  
 <span class="r10">  885 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ctx</span><span class="r19">=</span><span class="r14">ctx,</span><span class="r16">                              </span>  
 <span class="r10">  886 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            extra_node_features</span><span class="r19">=</span><span class="r14">extra_node_feats,</span><span class="r16"> </span>  
 <span class="r10">  887 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  888 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  889 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">collect_chunk</span><span class="r14">(x, i):</span><span class="r16">                  </span>  
 <span class="r10">  890 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            filtered_outs </span><span class="r19">=</span><span class="r14"> x</span><span class="r16">                     </span>  
 <span class="r10">  891 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">interaction_reduction </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;last</span>  
 <span class="r10">  892 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                filtered_outs </span><span class="r19">=</span><span class="r14"> filtered_outs[:, </span><span class="r19">-</span>  
 <span class="r10">  893 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  894 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                filtered_outs </span><span class="r19">=</span><span class="r14"> EinsOp(</span><span class="r16">           </span>  
 <span class="r10">  895 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r18">&#x27;nodes blocks mul outs -&gt; node</span>  
 <span class="r10">  896 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )(filtered_outs)</span><span class="r16">                  </span>  
 <span class="r10">  897 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  898 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> i </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction_mods):</span><span class="r16"> </span>  
 <span class="r10">  899 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># part of the global outputs</span><span class="r16">      </span>  
 <span class="r10">  900 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction_mods[i]</span>  
 <span class="r10">  901 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    filtered_outs, cg</span><span class="r19">.</span><span class="r14">nodes</span><span class="r19">.</span><span class="r14">graph_</span>  
 <span class="r10">  902 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  903 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  904 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r23"># global output</span><span class="r16">                   </span>  
 <span class="r10">  905 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">return</span><span class="r14"> filtered_outs</span><span class="r16">              </span>  
 <span class="r10">  906 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  907 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        chunks </span><span class="r19">=</span><span class="r14"> [collect_chunk(chunk, i) </span><span class="r13">for</span><span class="r14"> i, c</span>  
 <span class="r10">  908 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  909 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out_ir </span><span class="r19">=</span><span class="r14"> out</span><span class="r19">.</span><span class="r14">irreps</span><span class="r16">                       </span>  
 <span class="r10">  910 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  911 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_graph_irreps </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">      </span>  
 <span class="r10">  912 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_arr </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                      </span>  
 <span class="r10">  913 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  914 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            graph_arr </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">IrrepsArray</span><span class="r19">.</span><span class="r14">from_list</span>  
 <span class="r10">  915 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_graph_irreps,</span><span class="r16">         </span>  
 <span class="r10">  916 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                chunks[: </span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction_m</span>  
 <span class="r10">  917 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                leading_shape</span><span class="r19">=</span><span class="r14">(cg</span><span class="r19">.</span><span class="r14">n_total_graphs,)</span>  
 <span class="r10">  918 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  919 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  920 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_node_irreps </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">       </span>  
 <span class="r10">  921 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_arr </span><span class="r19">=</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                       </span>  
 <span class="r10">  922 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  923 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            node_arr </span><span class="r19">=</span><span class="r14"> e3nn</span><span class="r19">.</span><span class="r14">IrrepsArray</span><span class="r19">.</span><span class="r14">from_list(</span>  
 <span class="r10">  924 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_node_irreps,</span><span class="r16">          </span>  
 <span class="r10">  925 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                chunks[</span><span class="r17">len</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">node_reduction_mod</span>  
 <span class="r10">  926 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                leading_shape</span><span class="r19">=</span><span class="r14">(cg</span><span class="r19">.</span><span class="r14">n_total_nodes,),</span>  
 <span class="r10">  927 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  928 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  929 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> out_ir</span><span class="r19">.</span><span class="r14">is_scalar() </span><span class="r29">and</span><span class="r14"> out_ir</span><span class="r19">.</span><span class="r14">num_irrep</span>  
 <span class="r10">  930 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># special case for regression</span><span class="r16">         </span>  
 <span class="r10">  931 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> graph_arr</span><span class="r19">.</span><span class="r14">array</span><span class="r16">                </span>  
 <span class="r10">  932 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  933 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> graph_arr, node_arr</span><span class="r16">            </span>  
 <span class="r10">  934 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  935 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  936 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">output_irreps</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">str</span><span class="r14">:</span><span class="r16">               </span>  
 <span class="r10">  937 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_node_irreps </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">       </span>  
 <span class="r10">  938 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_graph_irreps</span><span class="r16">       </span>  
 <span class="r10">  939 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_graph_irreps </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">    </span>  
 <span class="r10">  940 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_node_irreps</span><span class="r16">        </span>  
 <span class="r10">  941 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  942 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">output_graph_irreps</span><span class="r25">}</span><span class="r18"> + </span>  
 <span class="r10">  943 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  944 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  945 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">if</span><span class="r14"> </span><span class="r30">__name__</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;__main__&#x27;</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  946 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig</span><span class="r16">             </span>  
 <span class="r10">  947 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                               </span>  
 <span class="r10">  948 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.dataset</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> load_file, dataloader</span><span class="r16"> </span>  
 <span class="r10">  949 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">eins</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> EinsOp</span><span class="r16">                       </span>  
 <span class="r10">  950 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  951 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config </span><span class="r19">=</span><span class="r14"> pyrallis</span><span class="r19">.</span><span class="r14">parse(config_class</span><span class="r19">=</span><span class="r14">MainConfi</span>  
 <span class="r10">  952 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config</span><span class="r19">.</span><span class="r14">cli</span><span class="r19">.</span><span class="r14">set_up_logging()</span><span class="r16">                   </span>  
 <span class="r10">  953 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  954 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    symmetric_tensor_product_basis </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r14">  </span><span class="r23"># symme</span>  
 <span class="r10">  955 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_ell </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                                   </span>  
 <span class="r10">  956 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    num_interactions </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r16">                          </span>  
 <span class="r10">  957 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    hidden_irreps </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;256x0e + 256x1o&#x27;</span><span class="r16">             </span>  
 <span class="r10">  958 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># hidden_irreps = &#x27;16x0e + 16x1o&#x27;</span><span class="r16">             </span>  
 <span class="r10">  959 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    correlation </span><span class="r19">=</span><span class="r14"> </span><span class="r19">2</span><span class="r14">  </span><span class="r23"># 4 is better but 5x slower</span><span class="r16">  </span>  
 <span class="r10">  960 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    readout_mlp_irreps </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;128x0e + 16x1o&#x27;</span><span class="r16">         </span>  
 <span class="r10">  961 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_irreps </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;1x0e&#x27;</span><span class="r16">                        </span>  
 <span class="r10">  962 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  963 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    mace </span><span class="r19">=</span><span class="r14"> MaceModel(</span><span class="r16">                             </span>  
 <span class="r10">  964 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        output_irreps</span><span class="r19">=</span><span class="r14">output_irreps,</span><span class="r16">              </span>  
 <span class="r10">  965 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_interactions</span><span class="r19">=</span><span class="r14">num_interactions,</span><span class="r16">        </span>  
 <span class="r10">  966 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        hidden_irreps</span><span class="r19">=</span><span class="r14">hidden_irreps,</span><span class="r16">              </span>  
 <span class="r10">  967 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        readout_mlp_irreps</span><span class="r19">=</span><span class="r14">readout_mlp_irreps,</span><span class="r16">    </span>  
 <span class="r10">  968 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        num_species</span><span class="r19">=</span><span class="r14">config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">num_species,</span><span class="r16">      </span>  
 <span class="r10">  969 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        max_ell</span><span class="r19">=</span><span class="r14">max_ell,</span><span class="r16">                          </span>  
 <span class="r10">  970 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        correlation</span><span class="r19">=</span><span class="r14">correlation,</span><span class="r16">                  </span>  
 <span class="r10">  971 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    )</span><span class="r16">                                             </span>  
 <span class="r10">  972 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  973 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    cg </span><span class="r19">=</span><span class="r14"> load_file(config, </span><span class="r19">20</span><span class="r14">)</span><span class="r16">                    </span>  
 <span class="r10">  974 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  975 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    key </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">key(</span><span class="r19">12345</span><span class="r14">)</span><span class="r16">                   </span>  
 <span class="r10">  976 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ctx </span><span class="r19">=</span><span class="r14"> Context(training</span><span class="r19">=</span><span class="r13">True</span><span class="r14">)</span><span class="r16">                  </span>  
 <span class="r10">  977 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  978 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># with jax.check_tracer_leaks(True):</span><span class="r16">          </span>  
 <span class="r10">  979 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># flax_summary(mace, cg=cg, ctx=ctx)</span><span class="r16">          </span>  
 <span class="r10">  980 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  981 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">debug_nans(</span><span class="r13">False</span><span class="r14">):</span><span class="r16">                   </span>  
 <span class="r10">  982 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">log_compiles(</span><span class="r13">False</span><span class="r14">):</span><span class="r16">             </span>  
 <span class="r10">  983 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            contributions, params </span><span class="r19">=</span><span class="r14"> mace</span><span class="r19">.</span><span class="r14">init_with</span>  
 <span class="r10">  984 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  985 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_structure(contributions)</span><span class="r16">              </span>  
 <span class="r10">  986 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_stat(contributions)</span><span class="r16">                   </span>  
 <span class="r10">  987 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_stat(params)</span><span class="r16">                          </span>  
 <span class="r10">  988 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  989 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># steps_per_epoch, dl = dataloader(config, spl</span>  
 <span class="r10">  990 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  991 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@jax</span><span class="r19">.</span><span class="r14">jit</span><span class="r16">                                      </span>  
 <span class="r10">  992 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">loss</span><span class="r14">(params, batch):</span><span class="r16">                      </span>  
 <span class="r10">  993 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        cg </span><span class="r19">=</span><span class="r14"> batch</span><span class="r16">                                </span>  
 <span class="r10">  994 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        preds </span><span class="r19">=</span><span class="r14"> mace</span><span class="r19">.</span><span class="r14">apply(params, cg</span><span class="r19">=</span><span class="r14">cg, ctx</span><span class="r19">=</span><span class="r14">Cont</span>  
 <span class="r10">  995 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">loss</span><span class="r19">.</span><span class="r14">regression_loss(</span><span class="r16"> </span>  
 <span class="r10">  996 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            preds, batch</span><span class="r19">.</span><span class="r14">graph_data</span><span class="r19">.</span><span class="r14">e_form</span><span class="r19">.</span><span class="r14">reshape</span>  
 <span class="r10">  997 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  998 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  999 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    res </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">value_and_grad(loss)(params, cg)</span><span class="r16">    </span>  
 <span class="r10"> 1000 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    debug_stat(res)</span><span class="r16">                               </span>  
 <span class="r10"> 1001 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_structure(res)</span><span class="r16">                        </span>  
 <span class="r10"> 1002 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># jax.block_until_ready(res)</span><span class="r16">                  </span>  
 <span class="r10"> 1003 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10"> 1004 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># from ctypes import cdll</span><span class="r16">                     </span>  
 <span class="r10"> 1005 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># libcudart = cdll.LoadLibrary(&#x27;libcudart.so&#x27;)</span>  
 <span class="r10"> 1006 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10"> 1007 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># libcudart.cudaProfilerStart()</span><span class="r16">               </span>  
 <span class="r10"> 1008 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># for i in range(1):</span><span class="r16">                          </span>  
 <span class="r10"> 1009 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     batch = next(dl)</span><span class="r16">                        </span>  
 <span class="r10"> 1010 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     res = jax.value_and_grad(loss)(params, b</span>  
 <span class="r10"> 1011 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23">#     jax.block_until_ready(res)</span><span class="r16">              </span>  
 <span class="r10"> 1012 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># libcudart.cudaProfilerStop()</span><span class="r16">                </span>  
 <span class="r10"> 1013 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10"> 1014 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_stat(value=res[0], grad=res[1])</span><span class="r16">       </span>  
 <span class="r10"> 1015 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10"> 1016 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_structure(batch=batch, module=model, o</span>  
 <span class="r10"> 1017 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># debug_stat(batch=batch, module=model, out=ou</span>  
 <span class="r10"> 1018 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># flax_summary(mace, vecs, cg.nodes.species, c</span>  
 <span class="r10"> 1019 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    67:    14 MB</span>                                                                                                                 
<span class="r21">                      /home/nmiklaucic/cdv/cdv/metadata.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                       </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/metadata.py               </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;Script to parse metadata information, attached </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">representation.&quot;&quot;&quot;</span><span class="r16">                                </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">equinox</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">eqx</span><span class="r16">                             </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  98%  </span>│<span class="r1">   20M </span>│<span class="r1">▁▁             </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                               </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                                   </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">jaxtyping</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Array, Float, UInt8</span><span class="r16">         </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pymatgen.core</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Structure</span><span class="r16">               </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pymatgen.symmetry.analyzer</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> SpacegroupA</span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.progress</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> track</span><span class="r16">                   </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.prompt</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Confirm</span><span class="r16">                   </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Metadata</span><span class="r14">(eqx</span><span class="r19">.</span><span class="r14">Module):</span><span class="r16">                       </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    e_form: Float[Array, </span><span class="r18">&#x27;n_b b&#x27;</span><span class="r14">]</span><span class="r16">                 </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    lat_abc_angles: Float[Array, </span><span class="r18">&#x27;n_b b 6&#x27;</span><span class="r14">]</span><span class="r16">       </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    space_groups: UInt8[Array, </span><span class="r18">&#x27;n_b b&#x27;</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@classmethod</span><span class="r16">                                  </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">new_empty</span><span class="r14">(</span><span class="r17">cls</span><span class="r14">, n_batches: </span><span class="r17">int</span><span class="r14">, batch_size:</span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Metadata(jnp</span><span class="r19">.</span><span class="r14">empty((n_batches, batc</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">space_group_int</span><span class="r14">(struct: Structure) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">int</span><span class="r14">:</span><span class="r16">    </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ana </span><span class="r19">=</span><span class="r14"> SpacegroupAnalyzer(struct, symprec</span><span class="r19">=0.3</span><span class="r14">, </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> ana</span><span class="r19">.</span><span class="r14">get_space_group_number()</span><span class="r16">           </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">if</span><span class="r14"> </span><span class="r30">__name__</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;__main__&#x27;</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig</span><span class="r16">             </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> Confirm</span><span class="r19">.</span><span class="r14">ask(</span><span class="r18">&#x27;Regenerate metadata files?</span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(</span><span class="r18">&#x27;Aborted&#x27;</span><span class="r14">)</span><span class="r16">               </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config </span><span class="r19">=</span><span class="r14"> pyrallis</span><span class="r19">.</span><span class="r14">argparsing</span><span class="r19">.</span><span class="r14">parse(MainConfig,</span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># matbench perov dataset</span><span class="r16">                      </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    df </span><span class="r19">=</span><span class="r14"> pd</span><span class="r19">.</span><span class="r14">read_json(config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">raw_data_folder </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    df[</span><span class="r18">&#x27;struct&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> [Structure</span><span class="r19">.</span><span class="r14">from_dict(s) </span><span class="r13">for</span><span class="r14"> s </span><span class="r29">i</span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    n_data </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(df</span><span class="r19">.</span><span class="r14">index)</span><span class="r16">                        </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    bs </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">data_batch_size</span><span class="r16">              </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    n_batches </span><span class="r19">=</span><span class="r14"> n_data </span><span class="r19">//</span><span class="r14"> bs</span><span class="r16">                      </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data </span><span class="r19">=</span><span class="r14"> {</span><span class="r16">                                      </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r18">&#x27;e_form&#x27;</span><span class="r14">: jnp</span><span class="r19">.</span><span class="r14">array(df[</span><span class="r18">&#x27;e_form&#x27;</span><span class="r14">], dtype</span><span class="r19">=</span><span class="r14">jn</span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r18">&#x27;lat_abc_angles&#x27;</span><span class="r14">: [],</span><span class="r16">                     </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r18">&#x27;space_groups&#x27;</span><span class="r14">: []</span><span class="r16">                        </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    }</span><span class="r16">                                             </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> batch_i </span><span class="r29">in</span><span class="r14"> track(</span><span class="r17">range</span><span class="r14">(</span><span class="r19">0</span><span class="r14">, n_data, bs), des</span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        batch: </span><span class="r17">list</span><span class="r14">[Structure] </span><span class="r19">=</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(df</span><span class="r19">.</span><span class="r14">iloc[batc</span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        data[</span><span class="r18">&#x27;lat_abc_angles&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">append([struct</span><span class="r19">.</span><span class="r14">latt</span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        data[</span><span class="r18">&#x27;space_groups&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">append([space_group_i</span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data[</span><span class="r18">&#x27;lat_abc_angles&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">array(data[</span><span class="r18">&#x27;lat_a</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data[</span><span class="r18">&#x27;space_groups&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">array(data[</span><span class="r18">&#x27;space_g</span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    metadata </span><span class="r19">=</span><span class="r14"> Metadata(</span><span class="r19">**</span><span class="r14">data)</span><span class="r16">                   </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(</span><span class="r18">&#x27;Space groups:&#x27;</span><span class="r14">, jnp</span><span class="r19">.</span><span class="r14">unique(metadata</span><span class="r19">.</span><span class="r14">spa</span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    eqx</span><span class="r19">.</span><span class="r14">tree_serialise_leaves(config</span><span class="r19">.</span><span class="r14">data</span><span class="r19">.</span><span class="r14">data_fol</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(</span><span class="r18">&#x27;Done!&#x27;</span><span class="r14">)</span><span class="r16">                                </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)     6:    20 MB</span>                                                                                                                 
<span class="r21">                   /home/nmiklaucic/cdv/cdv/training_runner.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                   </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/training_runner.py        </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;Training state runner interface.&quot;&quot;&quot;</span><span class="r16">            </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MainConfig</span><span class="r16">                 </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.dashboard</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Dashboard</span><span class="r16">               </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.training_state</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> TrainingRun</span><span class="r16">        </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">run_using_dashboard</span><span class="r14">(config: MainConfig):</span><span class="r16">      </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    run </span><span class="r19">=</span><span class="r14"> TrainingRun(config)</span><span class="r16">                     </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    app </span><span class="r19">=</span><span class="r14"> Dashboard(run, config</span><span class="r19">=</span><span class="r14">config)</span><span class="r16">           </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  16%  </span>│<span class="r1">  198M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁  75% </span>│<span class="r12">    85 </span>│<span class="r14">    app</span><span class="r19">.</span><span class="r14">run()</span><span class="r16">                                     </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> run</span><span class="r16">                                    </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">run_using_progress</span><span class="r14">(config: MainConfig):</span><span class="r16">       </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">import</span><span class="r14"> </span><span class="r15">rich.progress</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">prog</span><span class="r16">                  </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    run </span><span class="r19">=</span><span class="r14"> TrainingRun(config)</span><span class="r16">                     </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    update_every </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                              </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> prog</span><span class="r19">.</span><span class="r14">Progress(</span><span class="r16">                           </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">TextColumn(</span><span class="r18">&#x27;[progress.description]</span><span class="r25">{ta</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">BarColumn(</span><span class="r19">80</span><span class="r14">, </span><span class="r18">&#x27;light_pink3&#x27;</span><span class="r14">, </span><span class="r18">&#x27;deep_sk</span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">MofNCompleteColumn(),</span><span class="r16">                </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">TimeElapsedColumn(),</span><span class="r16">                 </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">TimeRemainingColumn(),</span><span class="r16">               </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        prog</span><span class="r19">.</span><span class="r14">SpinnerColumn(),</span><span class="r16">                     </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        refresh_per_second</span><span class="r19">=3</span><span class="r14">,</span><span class="r16">                     </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        disable</span><span class="r19">=</span><span class="r29">not</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">cli</span><span class="r19">.</span><span class="r14">show_progress,</span><span class="r16">     </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ) </span><span class="r13">as</span><span class="r14"> progress:</span><span class="r16">                                </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        task </span><span class="r19">=</span><span class="r14"> progress</span><span class="r19">.</span><span class="r14">add_task(</span><span class="r16">                 </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r18">&#x27;[bold] [deep_pink3] Training [/deep_p</span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            total</span><span class="r19">=</span><span class="r14">run</span><span class="r19">.</span><span class="r14">num_steps </span><span class="r19">//</span><span class="r14"> update_every,</span><span class="r16">  </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> run_state </span><span class="r29">in</span><span class="r14"> run</span><span class="r19">.</span><span class="r14">step_until_done():</span><span class="r16">   </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> run_state</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">%</span><span class="r14"> update_every </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                progress</span><span class="r19">.</span><span class="r14">advance(task)</span><span class="r16">            </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> run_state</span><span class="r19">.</span><span class="r14">should_log:</span><span class="r16">              </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                status </span><span class="r19">=</span><span class="r14"> []</span><span class="r16">                       </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> run_state</span><span class="r19">.</span><span class="r14">metrics_hist</span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">if</span><span class="r14"> k</span><span class="r19">.</span><span class="r14">endswith(</span><span class="r18">&#x27;loss&#x27;</span><span class="r14">):</span><span class="r16">        </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        status</span><span class="r19">.</span><span class="r14">append(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">k</span><span class="r25">}</span><span class="r18">=</span><span class="r25">{</span><span class="r14">v[</span><span class="r19">-1</span><span class="r14">]</span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                progress</span><span class="r19">.</span><span class="r14">update(task, description</span><span class="r19">=</span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(</span><span class="r18">&#x27;Saved to:&#x27;</span><span class="r14">)</span><span class="r16">                            </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(run</span><span class="r19">.</span><span class="r14">finish()</span><span class="r19">.</span><span class="r14">absolute())</span><span class="r16">                </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> run</span><span class="r16">                                    </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)    11:   198 MB</span>                                                                                                                 
<span class="r21">                   /home/nmiklaucic/cdv/cdv/training_state.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                    </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/training_state.py         </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">dataclasses</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> field</span><span class="r16">                     </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">ft</span><span class="r16">                            </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">random</span><span class="r16">                                     </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">re</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> T</span><span class="r16">                                  </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">time</span><span class="r16">                                       </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">collections</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> defaultdict</span><span class="r16">               </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">datetime</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> datetime, timedelta</span><span class="r16">          </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">os</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> PathLike</span><span class="r16">                           </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pathlib</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Path</span><span class="r16">                          </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">shutil</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> copytree</span><span class="r16">                       </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Any, Mapping, Optional, Sequenc</span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">chex</span><span class="r16">                                       </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">optax</span><span class="r16">                                      </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">orbax.checkpoint</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">ocp</span><span class="r16">                    </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                               </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pyrallis</span><span class="r16">                                   </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">clu</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> metrics </span><span class="r13">as</span><span class="r14"> cmetrics</span><span class="r16">               </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> struct</span><span class="r16">                           </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> linen </span><span class="r13">as</span><span class="r14"> nn</span><span class="r16">                      </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax.training</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> train_state</span><span class="r16">             </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.checkpointing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> best_ckpt</span><span class="r16">           </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.config</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> LossConfig, MainConfig</span><span class="r16">     </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.dataset</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> CrystalGraphs, dataloader</span><span class="r16"> </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.layers</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Context</span><span class="r16">                    </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.utils</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> debug_structure, item_if_arr</span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">cdv.vae</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> prop_loss</span><span class="r16">                     </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@struct</span><span class="r19">.</span><span class="r14">dataclass</span><span class="r16">                                 </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Metrics</span><span class="r14">:</span><span class="r16">                                    </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    totals: </span><span class="r17">dict</span><span class="r14">[</span><span class="r17">str</span><span class="r14">, Any] </span><span class="r19">=</span><span class="r14"> field(default_factory</span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    counts: </span><span class="r17">dict</span><span class="r14">[</span><span class="r17">str</span><span class="r14">, Any] </span><span class="r19">=</span><span class="r14"> field(default_factory</span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">update</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">                   </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        totals </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">totals</span><span class="r19">.</span><span class="r14">copy()</span><span class="r16">               </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        counts </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">counts</span><span class="r19">.</span><span class="r14">copy()</span><span class="r16">               </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> kwargs</span><span class="r19">.</span><span class="r14">items():</span><span class="r16">               </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            totals[k] </span><span class="r19">=</span><span class="r14"> totals</span><span class="r19">.</span><span class="r14">get(k, </span><span class="r19">0</span><span class="r14">) </span><span class="r19">+</span><span class="r14"> v</span><span class="r16">      </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            counts[k] </span><span class="r19">=</span><span class="r14"> counts</span><span class="r19">.</span><span class="r14">get(k, </span><span class="r19">0</span><span class="r14">) </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r16">      </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Metrics(totals, counts)</span><span class="r16">            </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">items</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                              </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> {k: item_if_arr(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">totals[k] </span><span class="r19">/</span><span class="r14"> </span><span class="r17">se</span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">TrainState</span><span class="r14">(train_state</span><span class="r19">.</span><span class="r14">TrainState):</span><span class="r16">         </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    metrics: Metrics</span><span class="r16">                              </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    last_grad_norm: </span><span class="r17">float</span><span class="r16">                         </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">replicate_params</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, devices: </span><span class="r17">set</span><span class="r14">[jax</span><span class="r19">.</span><span class="r14">De</span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">device_put_replicated(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">para</span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">create_train_state</span><span class="r14">(module: nn</span><span class="r19">.</span><span class="r14">Module, optimize</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    b1 </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">tree_map(</span><span class="r13">lambda</span><span class="r14"> x: x[</span><span class="r19">0</span><span class="r14">], batch)</span><span class="r16">      </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    loss, params </span><span class="r19">=</span><span class="r14"> module</span><span class="r19">.</span><span class="r14">init_with_output(rng, b1</span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    tx </span><span class="r19">=</span><span class="r14"> optimizer</span><span class="r16">                                </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> TrainState</span><span class="r19">.</span><span class="r14">create(</span><span class="r16">                     </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        apply_fn</span><span class="r19">=</span><span class="r14">module</span><span class="r19">.</span><span class="r14">apply,</span><span class="r16">                    </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        params</span><span class="r19">=</span><span class="r14">params,</span><span class="r16">                            </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tx</span><span class="r19">=</span><span class="r14">tx,</span><span class="r16">                                    </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        metrics</span><span class="r19">=</span><span class="r14">Metrics(),</span><span class="r16">                        </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        last_grad_norm</span><span class="r19">=0</span><span class="r14">,</span><span class="r16">                         </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    )</span><span class="r16">                                             </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">@struct</span><span class="r19">.</span><span class="r14">dataclass</span><span class="r16">                                 </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Checkpoint</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    state: TrainState</span><span class="r16">                             </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    seed: </span><span class="r17">int</span><span class="r16">                                     </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    metrics_history: Mapping[</span><span class="r17">str</span><span class="r14">, Sequence[</span><span class="r17">float</span><span class="r14">]]</span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    curr_epoch: </span><span class="r17">float</span><span class="r16">                             </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">TrainingRun</span><span class="r14">:</span><span class="r16">                                </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, config: MainConfig):</span><span class="r16">       </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">seed </span><span class="r19">=</span><span class="r14"> random</span><span class="r19">.</span><span class="r14">randint(</span><span class="r19">100</span><span class="r14">, </span><span class="r19">1000</span><span class="r14">)</span><span class="r16">     </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng </span><span class="r19">=</span><span class="r14"> {</span><span class="r18">&#x27;params&#x27;</span><span class="r14">: jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">key(</span><span class="r17">self</span><span class="r19">.</span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;diled&#x27;</span><span class="r14">:</span><span class="r16">                </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng[</span><span class="r18">&#x27;params&#x27;</span><span class="r14">], </span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng[</span><span class="r18">&#x27;noise&#x27;</span><span class="r14">],</span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng[</span><span class="r18">&#x27;params&#x27;</span><span class="r14">], </span><span class="r19">3</span><span class="r16">             </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">print</span><span class="r14">(</span><span class="r18">f&#x27;Seed: </span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">seed</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">)</span><span class="r16">               </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config </span><span class="r19">=</span><span class="r14"> config</span><span class="r16">                      </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history </span><span class="r19">=</span><span class="r14"> defaultdict(</span><span class="r17">list</span><span class="r14">)</span><span class="r16">  </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_epochs </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">num_epochs</span><span class="r16">       </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps_in_epoch, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dl </span><span class="r19">=</span><span class="r14"> dataloader(</span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps_in_test_epoch, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_dl </span><span class="r19">=</span><span class="r14"> d</span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps_in_epoch </span><span class="r19">*</span><span class="r14"> </span><span class="r17">sel</span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps </span><span class="r19">=</span><span class="r14"> </span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps)</span><span class="r16">        </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                        </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">start_time </span><span class="r19">=</span><span class="r14"> time</span><span class="r19">.</span><span class="r14">monotonic()</span><span class="r16">        </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">scheduler </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">lr_sche</span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            num_epochs</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_epochs, steps_in_e</span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">optimizer </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">optimiz</span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">model </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">make_model()</span><span class="r16">            </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics </span><span class="r19">=</span><span class="r14"> Metrics()</span><span class="r16">                  </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        opts </span><span class="r19">=</span><span class="r14"> ocp</span><span class="r19">.</span><span class="r14">CheckpointManagerOptions(</span><span class="r16">      </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            save_interval_steps</span><span class="r19">=1</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            best_fn</span><span class="r19">=</span><span class="r13">lambda</span><span class="r14"> metrics: metrics[</span><span class="r18">&#x27;te_lo</span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            best_mode</span><span class="r19">=</span><span class="r18">&#x27;min&#x27;</span><span class="r14">,</span><span class="r16">                      </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            max_to_keep</span><span class="r19">=4</span><span class="r14">,</span><span class="r16">                        </span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            enable_async_checkpointing</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">     </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            keep_time_interval</span><span class="r19">=</span><span class="r14">timedelta(minutes</span><span class="r19">=3</span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  15%  </span>│<span class="r1"> 1.12G </span>│<span class="r1">▁▁   8%        </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mngr </span><span class="r19">=</span><span class="r14"> ocp</span><span class="r19">.</span><span class="r14">CheckpointManager(</span><span class="r16">        </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            ocp</span><span class="r19">.</span><span class="r14">test_utils</span><span class="r19">.</span><span class="r14">create_empty(</span><span class="r18">&#x27;/tmp/jax_</span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            options</span><span class="r19">=</span><span class="r14">opts,</span><span class="r16">                         </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_loss </span><span class="r19">=</span><span class="r14"> </span><span class="r19">1000</span><span class="r16">                     </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@staticmethod</span><span class="r16">                                 </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@ft</span><span class="r19">.</span><span class="r14">partial(jax</span><span class="r19">.</span><span class="r14">jit, static_argnames</span><span class="r19">=</span><span class="r14">(</span><span class="r18">&#x27;task&#x27;</span><span class="r14">, </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@chex</span><span class="r19">.</span><span class="r14">assert_max_traces(</span><span class="r19">5</span><span class="r14">)</span><span class="r16">                    </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">compute_metrics</span><span class="r14">(</span><span class="r16">                          </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">*</span><span class="r14">,</span><span class="r16">                                        </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        task: </span><span class="r17">str</span><span class="r14">,</span><span class="r16">                                </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        config: LossConfig,</span><span class="r16">                       </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        state: TrainState,</span><span class="r16">                        </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        batch: CrystalGraphs,</span><span class="r16">                     </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        preds,</span><span class="r16">                                    </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        rng</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                                 </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        devices</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                             </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ):</span><span class="r16">                                            </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;e_form&#x27;</span><span class="r14">:</span><span class="r16">                      </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            preds </span><span class="r19">=</span><span class="r14"> preds</span><span class="r16">                         </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            e_form </span><span class="r19">=</span><span class="r14"> batch</span><span class="r19">.</span><span class="r14">e_form[</span><span class="r19">...</span><span class="r14">, </span><span class="r13">None</span><span class="r14">]</span><span class="r16">      </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            mask </span><span class="r19">=</span><span class="r14"> batch</span><span class="r19">.</span><span class="r14">padding_mask[</span><span class="r19">...</span><span class="r14">, </span><span class="r13">None</span><span class="r14">]</span><span class="r16">  </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            loss </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">regression_loss(preds, e</span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            mae </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">abs(preds </span><span class="r19">-</span><span class="r14"> e_form)</span><span class="r19">.</span><span class="r14">mean(whe</span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            rmse </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">sqrt(optax</span><span class="r19">.</span><span class="r14">losses</span><span class="r19">.</span><span class="r14">squared_e</span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            metric_updates </span><span class="r19">=</span><span class="r14"> </span><span class="r17">dict</span><span class="r14">(mae</span><span class="r19">=</span><span class="r14">mae, loss</span><span class="r19">=</span><span class="r14">lo</span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;diled&#x27;</span><span class="r14"> </span><span class="r29">or</span><span class="r14"> task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;vae&#x27;</span><span class="r14">:</span><span class="r16">    </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            losses </span><span class="r19">=</span><span class="r14"> {k: jnp</span><span class="r19">.</span><span class="r14">mean(v) </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> p</span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            losses[</span><span class="r18">&#x27;grad_norm&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">last_grad_</span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            metric_updates </span><span class="r19">=</span><span class="r14"> </span><span class="r17">dict</span><span class="r14">(</span><span class="r19">**</span><span class="r14">losses)</span><span class="r16">       </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            msg </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;Unknown task </span><span class="r25">{</span><span class="r14">task</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">          </span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r14">(msg)</span><span class="r16">                 </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        state </span><span class="r19">=</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">replace(metrics</span><span class="r19">=</span><span class="r14">state</span><span class="r19">.</span><span class="r14">metric</span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> state</span><span class="r16">                              </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@staticmethod</span><span class="r16">                                 </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@ft</span><span class="r19">.</span><span class="r14">partial(jax</span><span class="r19">.</span><span class="r14">jit, static_argnames</span><span class="r19">=</span><span class="r14">(</span><span class="r18">&#x27;task&#x27;</span><span class="r14">, </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@chex</span><span class="r19">.</span><span class="r14">assert_max_traces(</span><span class="r19">5</span><span class="r14">)</span><span class="r16">                    </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">train_step</span><span class="r14">(</span><span class="r16">                               </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        task: </span><span class="r17">str</span><span class="r14">, config: LossConfig, state: Trai</span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ):</span><span class="r16">                                            </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Train for a single step.&quot;&quot;&quot;</span><span class="r16">            </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        rngs </span><span class="r19">=</span><span class="r14"> {k: v </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> rng</span><span class="r19">.</span><span class="r14">items()} </span><span class="r13">if</span><span class="r14"> </span><span class="r17">i</span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        rng </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">fold_in(rngs[</span><span class="r18">&#x27;params&#x27;</span><span class="r14">], s</span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">def</span><span class="r14"> </span><span class="r24">loss_fn</span><span class="r14">(params, batch):</span><span class="r16">               </span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            preds </span><span class="r19">=</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">apply_fn(params, batch, </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;e_form&#x27;</span><span class="r14">:</span><span class="r16">                  </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                loss </span><span class="r19">=</span><span class="r14"> config</span><span class="r19">.</span><span class="r14">regression_loss(pred</span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">return</span><span class="r14"> loss, preds</span><span class="r16">                </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">return</span><span class="r14"> preds[</span><span class="r18">&#x27;loss&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">mean(axis</span><span class="r19">=-1</span><span class="r14">)</span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        grad_fn </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">pmap(jax</span><span class="r19">.</span><span class="r14">grad(loss_fn, has_a</span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        grads, preds </span><span class="r19">=</span><span class="r14"> grad_fn(state</span><span class="r19">.</span><span class="r14">params, batch</span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        debug_structure(grads</span><span class="r19">=</span><span class="r14">grads, preds</span><span class="r19">=</span><span class="r14">preds)</span><span class="r16"> </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        grads </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">tree_map(</span><span class="r13">lambda</span><span class="r14"> x: x</span><span class="r19">.</span><span class="r14">mean(axis</span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        grad_norm </span><span class="r19">=</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">global_norm(grads)</span><span class="r16">      </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        state </span><span class="r19">=</span><span class="r14"> state</span><span class="r19">.</span><span class="r14">apply_gradients(grads</span><span class="r19">=</span><span class="r14">grads,</span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> state, preds</span><span class="r16">                       </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">make_model</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                         </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;diled&#x27;</span><span class="r14">:</span><span class="r16">           </span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">build_diled()</span><span class="r16">      </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;e_form&#x27;</span><span class="r14">:</span><span class="r16">        </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">build_regressor()</span><span class="r16">  </span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">task </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;vae&#x27;</span><span class="r14">:</span><span class="r16">           </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">build_vae()</span><span class="r16">        </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">ValueError</span><span class="r16">                      </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">next_step</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                          </span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">step(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r14">, </span><span class="r17">next</span><span class="r14">(</span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">eval_state</span><span class="r14">(</span><span class="r17">self</span><span class="r14">) </span><span class="r19">-&gt;</span><span class="r14"> TrainState:</span><span class="r16">           </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">schedule_free:</span><span class="r16">       </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            params </span><span class="r19">=</span><span class="r14"> optax</span><span class="r19">.</span><span class="r14">contrib</span><span class="r19">.</span><span class="r14">schedule_free_e</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">opt_state, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">p</span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">replace(params</span><span class="r19">=</span><span class="r14">param</span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r16">                     </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">step</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, step: </span><span class="r17">int</span><span class="r14">, batch: CrystalGraphs</span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">=</span><span class="r14"> step</span><span class="r16">                     </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> step </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># initialize model</span><span class="r16">                    </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state </span><span class="r19">=</span><span class="r14"> create_train_state(</span><span class="r16">      </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                module</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">model,</span><span class="r16">                </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                optimizer</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">optimizer,</span><span class="r16">         </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                rng</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng,</span><span class="r16">                     </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                batch</span><span class="r19">=</span><span class="r14">batch,</span><span class="r16">                      </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">restart_from </span><span class="r29">is</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r13">Non</span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">replace(</span><span class="r16">  </span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    params</span><span class="r19">=</span><span class="r14">best_ckpt(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">r</span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">elif</span><span class="r14"> step </span><span class="r19">&gt;=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">num_steps:</span><span class="r16">              </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r13">None</span><span class="r16">                           </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        kwargs </span><span class="r19">=</span><span class="r14"> </span><span class="r17">dict</span><span class="r14">(</span><span class="r16">                            </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            task</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">task,</span><span class="r16">                </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            config</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">loss,</span><span class="r16">        </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            batch</span><span class="r19">=</span><span class="r14">batch,</span><span class="r16">                          </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            rng</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">rng,</span><span class="r16">                         </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            devices</span><span class="r19">=</span><span class="r17">tuple</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">device</span><span class="r19">.</span><span class="r14">devic</span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">   8%  </span>│<span class="r1">   40M </span>│<span class="r1">               </span>│<span class="r12">     4 </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state, preds </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">train_step(state</span><span class="r19">=</span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">compute_metrics(preds</span><span class="r19">=</span><span class="r14">pr</span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">should_log </span><span class="r29">or</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">should_ckpt:  </span><span class="r23">#</span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> metric, value </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">metric</span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> metric </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;grad_norm&#x27;</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;grad_nor</span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">continue</span><span class="r16">                      </span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">f&#x27;tr_</span><span class="r25">{</span><span class="r14">metric</span><span class="r25">}</span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">should_ckpt:</span><span class="r16">          </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">if</span><span class="r14"> </span><span class="r18">f&#x27;te_</span><span class="r25">{</span><span class="r14">metric</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14"> </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metr</span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">f&#x27;te_</span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">f</span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        )</span><span class="r16">                         </span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                         </span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">f&#x27;te_</span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state</span><span class="r19">.</span><span class="r14">replace(</span><span class="r16">      </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                metrics</span><span class="r19">=</span><span class="r14">Metrics()</span><span class="r16">                 </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )  </span><span class="r23"># reset train_metrics for next trai</span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;lr&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">append(</span><span class="r17">self</span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;step&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">append(</span><span class="r17">se</span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;epoch&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">append(</span><span class="r17">s</span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;rel_mins&#x27;</span><span class="r14">]</span><span class="r19">.</span><span class="r14">appen</span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;epoch&#x27;</span><span class="r14">], </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;throughput&#x27;</span><span class="r14">]</span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">*</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">b</span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                prev, curr </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                min_delta </span><span class="r19">=</span><span class="r14"> curr </span><span class="r19">-</span><span class="r14"> prev</span><span class="r16">           </span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                prev, curr </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                size </span><span class="r19">=</span><span class="r14"> (curr </span><span class="r19">-</span><span class="r14"> prev) </span><span class="r19">*</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">&#x27;throughput&#x27;</span><span class="r14">]</span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(self.metrics_history)</span><span class="r16">             </span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">should_ckpt:</span><span class="r16">                      </span>  
 <span class="r10">  269 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># Compute metrics on the test set afte</span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">eval_state</span><span class="r19">.</span><span class="r14">repl</span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> _i, test_batch </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(</span><span class="r17">range</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">s</span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  25%  </span>│<span class="r1">   10M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁   3% </span>│<span class="r12">    16 </span>│<span class="r14">                test_preds </span><span class="r19">=</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">pmap(</span><span class="r16">            </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">lambda</span><span class="r14"> p, b: </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state</span><span class="r19">.</span><span class="r14">a</span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                        p, b, ctx</span><span class="r19">=</span><span class="r14">Context(training</span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    ),</span><span class="r16">                            </span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    in_axes</span><span class="r19">=</span><span class="r14">(</span><span class="r13">None</span><span class="r14">, </span><span class="r19">0</span><span class="r14">),</span><span class="r16">            </span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state</span><span class="r19">.</span><span class="r14">params, test_bat</span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">compute_met</span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    task</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">task,</span><span class="r16">        </span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    config</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">train</span><span class="r19">.</span><span class="r14">loss,</span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    state</span><span class="r19">=</span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state,</span><span class="r16">        </span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    batch</span><span class="r19">=</span><span class="r14">test_batch,</span><span class="r16">             </span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    preds</span><span class="r19">=</span><span class="r14">test_preds,</span><span class="r16">             </span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                )</span><span class="r16">                                 </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> metric, value </span><span class="r29">in</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_state</span><span class="r19">.</span><span class="r14">m</span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> metric </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;grad_norm&#x27;</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r13">continue</span><span class="r16">                      </span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history[</span><span class="r18">f&#x27;te_</span><span class="r25">{</span><span class="r14">metric</span><span class="r25">}</span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">metric</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14"> </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;loss&#x27;</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_loss </span><span class="r19">=</span><span class="r14"> value</span><span class="r16">        </span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  11%  </span>│<span class="r1">   20M </span>│<span class="r1">▁▁             </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mngr</span><span class="r19">.</span><span class="r14">save(</span><span class="r16">                       </span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step,</span><span class="r16">                   </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                args</span><span class="r19">=</span><span class="r14">ocp</span><span class="r19">.</span><span class="r14">args</span><span class="r19">.</span><span class="r14">StandardSave(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">ck</span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                metrics</span><span class="r19">=</span><span class="r14">{</span><span class="r18">&#x27;te_loss&#x27;</span><span class="r14">: </span><span class="r17">self</span><span class="r19">.</span><span class="r14">test_loss</span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            )</span><span class="r16">                                     </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mngr</span><span class="r19">.</span><span class="r14">wait_until_finished()</span><span class="r16">       </span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r16">                               </span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">step_until_done</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                    </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> step, batch </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dl</span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">yield</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">step(step, batch)</span><span class="r16">          </span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">run_to_completion</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                  </span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> step, batch </span><span class="r29">in</span><span class="r14"> </span><span class="r17">zip</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">dl</span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">step(step, batch)</span><span class="r16">                </span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">should_log</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                         </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> (</span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r14">) </span><span class="r19">%</span><span class="r14"> (</span><span class="r17">self</span><span class="r19">.</span><span class="r14">steps_</span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">should_ckpt</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                        </span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> (</span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r14">) </span><span class="r19">%</span><span class="r14"> (</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r22">@property</span><span class="r16">                                     </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">lr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                                 </span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">scheduler(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">curr_step)</span><span class="r19">.</span><span class="r14">item</span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">ckpt</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                               </span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Checkpoint PyTree.&quot;&quot;&quot;</span><span class="r16">                  </span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> Checkpoint(</span><span class="r16">                        </span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17">self</span><span class="r19">.</span><span class="r14">state, </span><span class="r17">self</span><span class="r19">.</span><span class="r14">seed, </span><span class="r17">dict</span><span class="r14">(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">metri</span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">save_final</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, out_dir: </span><span class="r17">str</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> PathLike):</span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Save final model to directory.&quot;&quot;&quot;</span><span class="r16">      </span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">mngr</span><span class="r19">.</span><span class="r14">wait_until_finished()</span><span class="r16">           </span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        copytree(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">mngr</span><span class="r19">.</span><span class="r14">directory, Path(out_dir</span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">finish</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                             </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        now </span><span class="r19">=</span><span class="r14"> datetime</span><span class="r19">.</span><span class="r14">now()</span><span class="r16">                      </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">log</span><span class="r19">.</span><span class="r14">exp_name </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">      </span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            exp_name </span><span class="r19">=</span><span class="r14"> now</span><span class="r19">.</span><span class="r14">strftime(</span><span class="r18">&#x27;%m-</span><span class="r25">%d</span><span class="r18">-%H&#x27;</span><span class="r14">)</span><span class="r16">   </span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            exp_name </span><span class="r19">=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">config</span><span class="r19">.</span><span class="r14">log</span><span class="r19">.</span><span class="r14">exp_name</span><span class="r16">   </span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        folder </span><span class="r19">=</span><span class="r14"> Path(</span><span class="r18">&#x27;logs/&#x27;</span><span class="r14">) </span><span class="r19">/</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">exp_name</span><span class="r25">}</span><span class="r18">_</span><span class="r25">{</span><span class="r17">sel</span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        folder</span><span class="r19">.</span><span class="r14">mkdir(exist_ok</span><span class="r19">=</span><span class="r13">True</span><span class="r14">)</span><span class="r16">               </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pd</span><span class="r19">.</span><span class="r14">DataFrame(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">metrics_history)</span><span class="r19">.</span><span class="r14">to_feat</span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(folder </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;time_stopped.txt&#x27;</span><span class="r14">, </span><span class="r18">&#x27;w&#x27;</span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            f</span><span class="r19">.</span><span class="r14">write(now</span><span class="r19">.</span><span class="r14">isoformat())</span><span class="r16">              </span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(folder </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;config.toml&#x27;</span><span class="r14">, </span><span class="r18">&#x27;w&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            pyrallis</span><span class="r19">.</span><span class="r14">cfgparsing</span><span class="r19">.</span><span class="r14">dump(</span><span class="r17">self</span><span class="r19">.</span><span class="r14">config, </span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">save_final(folder </span><span class="r19">/</span><span class="r14"> </span><span class="r18">&#x27;final_ckpt&#x27;</span><span class="r14">)</span><span class="r16">    </span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> folder</span><span class="r16">                             </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)   114:  1142 MB</span>                                                                                                                 
<span class="r1">(2)   228:    40 MB</span>                                                                                                                 
<span class="r1">(3)   293:    20 MB</span>                                                                                                                 
<span class="r1">(4)   272:    10 MB</span>                                                                                                                 
<span class="r21">                        /home/nmiklaucic/cdv/cdv/utils.py: % of time =   0.00% (0.000ms) out of 7m:49.131s.                        </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/nmiklaucic/cdv/cdv/utils.py                  </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">&quot;&quot;&quot;Utilities.&quot;&quot;&quot;</span><span class="r16">                                  </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">inspect</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> signature</span><span class="r16">                     </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">io</span><span class="r16">                                         </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">re</span><span class="r16">                                         </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">abc</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> ABCMeta</span><span class="r16">                           </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">dataclasses</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> asdict, is_dataclass</span><span class="r16">      </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> partial</span><span class="r16">                     </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">math</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> isfinite</span><span class="r16">                         </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">os</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> PathLike</span><span class="r16">                           </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pathlib</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Path</span><span class="r16">                          </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">types</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> MappingProxyType</span><span class="r16">                </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Any, Callable</span><span class="r16">                  </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">e3nn_jax</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> IrrepsArray</span><span class="r16">                  </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">flax.linen</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">nn</span><span class="r16">                           </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">humanize</span><span class="r16">                                   </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax</span><span class="r16">                                        </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">jax.numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">jnp</span><span class="r16">                           </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                                </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">rich</span><span class="r16">                                       </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">flax.serialization</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> msgpack_restore, ms</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">jaxtyping</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> jaxtyped</span><span class="r16">                    </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  97%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">pymatgen.core</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Element</span><span class="r16">                 </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.style</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Style</span><span class="r16">                      </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.text</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Text</span><span class="r16">                        </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.tree</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Tree</span><span class="r16">                        </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r23"># checker = typechecker(conf=BeartypeConf(is_color</span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">tcheck </span><span class="r19">=</span><span class="r14"> partial(jaxtyped, typechecker</span><span class="r19">=</span><span class="r13">None</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r23"># TODO make this dataset-specific</span><span class="r16">                 </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">ELEM_VALS </span><span class="r19">=</span><span class="r14"> (</span><span class="r16">                                     </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;K Rb Ba Na Sr Li Ca La Tb Yb Ce Pr Nd Sm Dy Y</span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27; In Ga Fe Co Cu Si Ni Ag Sn Hg Ge Bi B Sb Te </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">)</span><span class="r19">.</span><span class="r14">split(</span><span class="r18">&#x27; &#x27;</span><span class="r14">)</span><span class="r16">                                      </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">INFERNA </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">                                       </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#e6ab00&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#eb9900&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#ec8800&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#e97800&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#e46a25&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#db5e40&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#cf5352&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#c14b60&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#b5416e&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#a5387c&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#93318a&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#7f2c95&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#67289e&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#4d25a3&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#2f23a3&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#00229c&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">]</span><span class="r16">                                                 </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.console</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Console</span><span class="r16">                  </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.highlighter</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> RegexHighlighter</span><span class="r16">     </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">rich.theme</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Theme</span><span class="r16">                      </span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">format_scalar</span><span class="r14">(scalar: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r17">float</span><span class="r14">, chars</span><span class="r19">=6</span><span class="r14">) </span><span class="r19">-&gt;</span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Formats the scalar using no more than the g</span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> scalar </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r19">0</span><span class="r14">:</span><span class="r16">                                </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;-&#x27;</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> format_scalar(</span><span class="r17">abs</span><span class="r14">(scalar), ch</span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(scalar, </span><span class="r17">int</span><span class="r14">):</span><span class="r16">                   </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">str</span><span class="r14">(scalar)) </span><span class="r19">-</span><span class="r14"> chars </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r19">3</span><span class="r14">:</span><span class="r16">          </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># egregiously longer, use scientific n</span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            used </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">scalar</span><span class="r25">:</span><span class="r18">.0E</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">)</span><span class="r16">           </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            remaining </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(chars </span><span class="r19">-</span><span class="r14"> used, </span><span class="r19">0</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;{:.dE}&#x27;</span><span class="r19">.</span><span class="r14">replace(</span><span class="r18">&#x27;d&#x27;</span><span class="r14">, </span><span class="r17">str</span><span class="r14">(remai</span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">str</span><span class="r14">(scalar)</span><span class="r16">                    </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> scalar </span><span class="r19">==</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(scalar):</span><span class="r16">                 </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> format_scalar(</span><span class="r17">int</span><span class="r14">(scalar), char</span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        decimal </span><span class="r19">=</span><span class="r14"> </span><span class="r17">str</span><span class="r14">(scalar)</span><span class="r16">                     </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> decimal</span><span class="r19">.</span><span class="r14">startswith(</span><span class="r18">&#x27;0.&#x27;</span><span class="r14">):</span><span class="r16">              </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            frac </span><span class="r19">=</span><span class="r14"> decimal</span><span class="r19">.</span><span class="r14">removeprefix(</span><span class="r18">&#x27;0.&#x27;</span><span class="r14">)</span><span class="r16">     </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            wasted </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(frac</span><span class="r19">.</span><span class="r14">lstrip(</span><span class="r18">&#x27;0&#x27;</span><span class="r14">)) </span><span class="r19">-</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(d</span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            wasted </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(decimal</span><span class="r19">.</span><span class="r14">replace(</span><span class="r18">&#x27;.&#x27;</span><span class="r14">, </span><span class="r18">&#x27;&#x27;</span><span class="r14">)</span><span class="r19">.</span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        suffix </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">scalar</span><span class="r25">:</span><span class="r18">.0e</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">[</span><span class="r19">1</span><span class="r14">:]</span><span class="r16">              </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> wasted </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(suffix):</span><span class="r16">                  </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            used </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">scalar</span><span class="r25">:</span><span class="r18">.0E</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">)</span><span class="r16">           </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            remaining </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(chars </span><span class="r19">-</span><span class="r14"> used, </span><span class="r19">0</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;{:.dE}&#x27;</span><span class="r19">.</span><span class="r14">replace(</span><span class="r18">&#x27;d&#x27;</span><span class="r14">, </span><span class="r17">str</span><span class="r14">(remai</span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            remaining </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(chars </span><span class="r19">-</span><span class="r14"> </span><span class="r19">2</span><span class="r14">, </span><span class="r19">0</span><span class="r14">)</span><span class="r16">         </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;{:.df}&#x27;</span><span class="r19">.</span><span class="r14">replace(</span><span class="r18">&#x27;d&#x27;</span><span class="r14">, </span><span class="r17">str</span><span class="r14">(remai</span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">item_if_arr</span><span class="r14">(x: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r17">float</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> jax</span><span class="r19">.</span><span class="r14">Array) </span><span class="r19">-&gt;</span><span class="r14"> </span><span class="r17">flo</span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(x, (</span><span class="r17">int</span><span class="r14">, </span><span class="r17">float</span><span class="r14">)):</span><span class="r16">               </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> x</span><span class="r16">                                  </span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> x</span><span class="r19">.</span><span class="r14">item()</span><span class="r16">                           </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">load_pytree</span><span class="r14">(file: PathLike):</span><span class="r16">                  </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Loads a MsgPack serialized PyTree.&quot;&quot;&quot;</span><span class="r16">      </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(Path(file), </span><span class="r18">&#x27;rb&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> infile:</span><span class="r16">        </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> msgpack_restore(infile</span><span class="r19">.</span><span class="r14">read())</span><span class="r16">     </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">save_pytree</span><span class="r14">(obj, file: PathLike):</span><span class="r16">             </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Saves a MsgPack serialized PyTree.&quot;&quot;&quot;</span><span class="r16">      </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> </span><span class="r17">open</span><span class="r14">(Path(file), </span><span class="r18">&#x27;wb&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> out:</span><span class="r16">           </span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out</span><span class="r19">.</span><span class="r14">write(msgpack_serialize(obj))</span><span class="r16">         </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">TreeVisitor</span><span class="r14">:</span><span class="r16">                                </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                           </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">pass</span><span class="r16">                                      </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">jax_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: jax</span><span class="r19">.</span><span class="r14">Array):</span><span class="r16">            </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">NotImplementedError</span><span class="r14">()</span><span class="r16">               </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">scalar</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, x: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r17">float</span><span class="r14">):</span><span class="r16">             </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">NotImplementedError</span><span class="r14">()</span><span class="r16">               </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">np_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: np</span><span class="r19">.</span><span class="r14">ndarray):</span><span class="r16">            </span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">raise</span><span class="r14"> </span><span class="r26">NotImplementedError</span><span class="r14">()</span><span class="r16">               </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">StatsVisitor</span><span class="r14">(TreeVisitor):</span><span class="r16">                  </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, sample_size: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">=</span><span class="r14"> </span><span class="r19">10_000</span><span class="r14">) </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r24">__init__</span><span class="r14">()</span><span class="r16">                        </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">self</span><span class="r19">.</span><span class="r14">sample_size </span><span class="r19">=</span><span class="r14"> sample_size</span><span class="r16">            </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">jax_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: jax</span><span class="r19">.</span><span class="r14">Array):</span><span class="r16">            </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        flat </span><span class="r19">=</span><span class="r14"> arr</span><span class="r19">.</span><span class="r14">flatten()</span><span class="r16">                      </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        size </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(flat)</span><span class="r16">                          </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> size </span><span class="r19">&lt;=</span><span class="r14"> </span><span class="r19">5</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r17">str</span><span class="r14">(jnp</span><span class="r19">.</span><span class="r14">round(flat, </span><span class="r19">4</span><span class="r14">))</span><span class="r16">        </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        lo </span><span class="r19">=</span><span class="r14"> arr</span><span class="r19">.</span><span class="r14">min()</span><span class="r19">.</span><span class="r14">item()</span><span class="r16">                     </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        hi </span><span class="r19">=</span><span class="r14"> arr</span><span class="r19">.</span><span class="r14">max()</span><span class="r19">.</span><span class="r14">item()</span><span class="r16">                     </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> size </span><span class="r19">&lt;=</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">sample_size:</span><span class="r16">              </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sampling </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                      </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> flat</span><span class="r19">.</span><span class="r14">dtype </span><span class="r19">==</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">bfloat16:</span><span class="r16">        </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">array(flat</span><span class="r19">.</span><span class="r14">astype(jnp</span><span class="r19">.</span><span class="r14">float</span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">array(flat)</span><span class="r16">                </span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sampling </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                       </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r23"># n^2 + 1 tends to have fewer factors:</span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            inds </span><span class="r19">=</span><span class="r14"> jnp</span><span class="r19">.</span><span class="r14">arange(np</span><span class="r19">.</span><span class="r14">floor(np</span><span class="r19">.</span><span class="r14">sqrt(siz</span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            x </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">array(flat[inds])</span><span class="r16">              </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        summary </span><span class="r19">=</span><span class="r14"> </span><span class="r18">&#x27;&#x27;</span><span class="r16">                              </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> x</span><span class="r19">.</span><span class="r14">dtype</span><span class="r19">.</span><span class="r14">kind </span><span class="r19">==</span><span class="r14"> </span><span class="r18">&#x27;f&#x27;</span><span class="r14">:</span><span class="r16">                   </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            mu </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">nanmean(x)</span><span class="r16">                    </span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            sd </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">nanstd(x)</span><span class="r16">                     </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            fmt </span><span class="r19">=</span><span class="r14"> </span><span class="r13">lambda</span><span class="r14"> s: </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">s</span><span class="r25">:</span><span class="r18">&gt;8.3g</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">          </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> (</span><span class="r17">abs</span><span class="r14">(mu) </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r19">1000</span><span class="r14"> </span><span class="r29">or</span><span class="r14"> sd </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r19">1000</span><span class="r14">) </span><span class="r29">or</span><span class="r14"> (</span><span class="r19">1</span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                factor </span><span class="r19">=</span><span class="r14"> </span><span class="r17">round</span><span class="r14">(np</span><span class="r19">.</span><span class="r14">log10(</span><span class="r17">max</span><span class="r14">(</span><span class="r17">abs</span><span class="r14">(mu</span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                x </span><span class="r19">=</span><span class="r14"> x </span><span class="r19">/</span><span class="r14"> </span><span class="r19">10**</span><span class="r14">factor</span><span class="r16">                </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                lo </span><span class="r19">=</span><span class="r14"> lo </span><span class="r19">/</span><span class="r14"> </span><span class="r19">10**</span><span class="r14">factor</span><span class="r16">              </span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                hi </span><span class="r19">=</span><span class="r14"> hi </span><span class="r19">/</span><span class="r14"> </span><span class="r19">10**</span><span class="r14">factor</span><span class="r16">              </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                summary </span><span class="r19">+=</span><span class="r14"> </span><span class="r18">f&#x27; E</span><span class="r25">{</span><span class="r14">factor</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">          </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                factor </span><span class="r19">=</span><span class="r14"> </span><span class="r19">0</span><span class="r16">                        </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            summary </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">fmt(mu</span><span class="r27"> </span><span class="r19">/</span><span class="r27"> </span><span class="r19">10</span><span class="r27"> </span><span class="r19">**</span><span class="r27"> </span><span class="r14">factor)</span><span class="r25">}</span><span class="r18"> ±</span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            zeros </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">mean(x </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r14">)</span><span class="r16">               </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> zeros </span><span class="r19">&gt;</span><span class="r14"> </span><span class="r19">0.2</span><span class="r14">:</span><span class="r16">                       </span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                summary </span><span class="r19">+=</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">zeros</span><span class="r25">:</span><span class="r18">.0%</span><span class="r25">}</span><span class="r18"> 0, &#x27;</span><span class="r16">     </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> (hi </span><span class="r19">-</span><span class="r14"> lo) </span><span class="r19">&lt;</span><span class="r14"> </span><span class="r19">0.2</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> size:</span><span class="r16">            </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                n_uniq </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(</span><span class="r17">set</span><span class="r14">(x))</span><span class="r16">              </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> n_uniq </span><span class="r19">&lt;=</span><span class="r14"> </span><span class="r19">5</span><span class="r14">:</span><span class="r16">                   </span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    summary </span><span class="r19">+=</span><span class="r14"> </span><span class="r18">f&#x27;uniq: </span><span class="r25">{</span><span class="r17">set</span><span class="r14">(x)</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">  </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                    summary </span><span class="r19">+=</span><span class="r14"> </span><span class="r18">f&#x27;uniq: </span><span class="r25">{</span><span class="r14">n_uniq</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">  </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            fmt </span><span class="r19">=</span><span class="r14"> </span><span class="r13">lambda</span><span class="r14"> s: </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">s</span><span class="r25">:</span><span class="r18">n</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">              </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        q25, q50, q75 </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">quantile(x, [</span><span class="r19">0.25</span><span class="r14">, </span><span class="r19">0.5</span><span class="r14">,</span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        quarts </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;(</span><span class="r25">{</span><span class="r14">fmt(lo)</span><span class="r25">}</span><span class="r18"> </span><span class="r25">{</span><span class="r14">fmt(q25)</span><span class="r25">}</span><span class="r18"> </span><span class="r25">{</span><span class="r14">fmt(q50)</span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r19">=</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">quarts</span><span class="r25">:</span><span class="r18">&gt;50</span><span class="r25">}</span><span class="r18"> </span><span class="r25">{</span><span class="r14">summary</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">           </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r19">+=</span><span class="r14"> </span><span class="r18">&#x27;~&#x27;</span><span class="r14"> </span><span class="r13">if</span><span class="r14"> sampling </span><span class="r13">else</span><span class="r14"> </span><span class="r18">&#x27;&#x27;</span><span class="r16">            </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                </span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">scalar</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, x: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r17">float</span><span class="r14">):</span><span class="r16">             </span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> format_scalar(x, </span><span class="r19">4</span><span class="r14">)</span><span class="r16">                </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">np_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: np</span><span class="r19">.</span><span class="r14">ndarray):</span><span class="r16">            </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;(np)&#x27;</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> </span><span class="r17">self</span><span class="r19">.</span><span class="r14">jax_arr(jnp</span><span class="r19">.</span><span class="r14">array(arr</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">StructureVisitor</span><span class="r14">(TreeVisitor):</span><span class="r16">              </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">__init__</span><span class="r14">(</span><span class="r17">self</span><span class="r14">):</span><span class="r16">                           </span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">super</span><span class="r14">()</span><span class="r19">.</span><span class="r24">__init__</span><span class="r14">()</span><span class="r16">                        </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">jax_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: jax</span><span class="r19">.</span><span class="r14">Array):</span><span class="r16">            </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        kind </span><span class="r19">=</span><span class="r14"> arr</span><span class="r19">.</span><span class="r14">dtype</span><span class="r19">.</span><span class="r14">name</span><span class="r16">                     </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        kind </span><span class="r19">=</span><span class="r14"> kind</span><span class="r19">.</span><span class="r14">replace(</span><span class="r18">&#x27;float&#x27;</span><span class="r14">, </span><span class="r18">&#x27;f&#x27;</span><span class="r14">)</span><span class="r19">.</span><span class="r14">replace(</span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">kind</span><span class="r25">}{</span><span class="r17">list</span><span class="r14">(arr</span><span class="r19">.</span><span class="r14">shape)</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16">         </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">scalar</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, x: </span><span class="r17">int</span><span class="r14"> </span><span class="r19">|</span><span class="r14"> </span><span class="r17">float</span><span class="r14">):</span><span class="r16">             </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">x</span><span class="r19">.</span><span class="r30">__class__</span><span class="r19">.</span><span class="r30">__name__</span><span class="r25">}</span><span class="r18">=&#x27;</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> </span><span class="r17">str</span><span class="r14">(x)</span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">np_arr</span><span class="r14">(</span><span class="r17">self</span><span class="r14">, arr: np</span><span class="r19">.</span><span class="r14">ndarray):</span><span class="r16">            </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  16%  </span>│<span class="r1">   30M </span>│<span class="r1">▁▁▁            </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;(np)</span><span class="r25">{</span><span class="r17">self</span><span class="r19">.</span><span class="r14">jax_arr(jnp</span><span class="r19">.</span><span class="r14">array(arr))</span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">COLORS </span><span class="r19">=</span><span class="r14"> [</span><span class="r16">                                        </span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#00a0ec&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#00bc70&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#ff7300&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#387200&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#aa2e00&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#7555d3&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#d83990&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#deca00&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#00f0ff&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#8ac7ff&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#ff7dc6&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">&#x27;#e960ff&#x27;</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">]</span><span class="r16">                                                 </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">KWARGS </span><span class="r19">=</span><span class="r14"> [</span><span class="r17">dict</span><span class="r14">(color</span><span class="r19">=</span><span class="r14">color) </span><span class="r13">for</span><span class="r14"> color </span><span class="r29">in</span><span class="r14"> COLORS]</span><span class="r16">  </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">KWARGS[</span><span class="r19">0</span><span class="r14">][</span><span class="r18">&#x27;bold&#x27;</span><span class="r14">] </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                          </span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">STYLES </span><span class="r19">=</span><span class="r14"> [Style(</span><span class="r19">**</span><span class="r14">kwargs) </span><span class="r13">for</span><span class="r14"> kwargs </span><span class="r29">in</span><span class="r14"> KWARGS]</span><span class="r16">   </span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">tree_from_dict</span><span class="r14">(base: Tree, obj, depth</span><span class="r19">=0</span><span class="r14">, colla</span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    style </span><span class="r19">=</span><span class="r14"> STYLES[depth </span><span class="r19">%</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(STYLES)]</span><span class="r16">           </span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, </span><span class="r17">dict</span><span class="r14">):</span><span class="r16">                     </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(obj) </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r14">:</span><span class="r16">                         </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            k, v </span><span class="r19">=</span><span class="r14"> </span><span class="r17">next</span><span class="r14">(</span><span class="r17">iter</span><span class="r14">(obj</span><span class="r19">.</span><span class="r14">items()))</span><span class="r16">        </span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            base</span><span class="r19">.</span><span class="r14">label </span><span class="r19">=</span><span class="r14"> base</span><span class="r19">.</span><span class="r14">label </span><span class="r19">+</span><span class="r14"> </span><span class="r18">&#x27; &gt;&gt;&gt; &#x27;</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> k</span><span class="r16"> </span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            tree_from_dict(base, v, depth)</span><span class="r16">        </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> obj</span><span class="r19">.</span><span class="r14">items():</span><span class="r16">              </span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                child </span><span class="r19">=</span><span class="r14"> base</span><span class="r19">.</span><span class="r14">add(k, style</span><span class="r19">=</span><span class="r14">style)</span><span class="r16">  </span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                tree_from_dict(child, v, depth </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        base</span><span class="r19">.</span><span class="r14">add(obj, style</span><span class="r19">=</span><span class="r14">style)</span><span class="r16">                </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">tree_traverse</span><span class="r14">(visitor: TreeVisitor, obj, max_d</span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, jax</span><span class="r19">.</span><span class="r14">Array):</span><span class="r16">                </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> visitor</span><span class="r19">.</span><span class="r14">jax_arr(obj)</span><span class="r16">               </span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, np</span><span class="r19">.</span><span class="r14">ndarray):</span><span class="r16">             </span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> visitor</span><span class="r19">.</span><span class="r14">np_arr(obj)</span><span class="r16">                </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, IrrepsArray):</span><span class="r16">            </span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;Irreps(</span><span class="r25">{</span><span class="r14">obj</span><span class="r19">.</span><span class="r14">irreps</span><span class="r25">}</span><span class="r18">)[</span><span class="r25">{</span><span class="r14">visitor</span><span class="r19">.</span><span class="r14">jax</span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, (</span><span class="r17">list</span><span class="r14">, </span><span class="r17">tuple</span><span class="r14">)):</span><span class="r16">          </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> max_depth </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;[...]&#x27;</span><span class="r16">                        </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> collapse_single </span><span class="r29">and</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(obj) </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r14">:</span><span class="r16"> </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                new_depth </span><span class="r19">=</span><span class="r14"> max_depth</span><span class="r16">             </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                new_depth </span><span class="r19">=</span><span class="r14"> max_depth </span><span class="r19">-</span><span class="r14"> </span><span class="r19">1</span><span class="r16">         </span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> {</span><span class="r17">str</span><span class="r14">(i): tree_traverse(visitor,</span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, (</span><span class="r17">float</span><span class="r14">, </span><span class="r17">int</span><span class="r14">)):</span><span class="r16">           </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> visitor</span><span class="r19">.</span><span class="r14">scalar(obj)</span><span class="r16">                </span>  
 <span class="r10">  269 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(obj, </span><span class="r17">dict</span><span class="r14">):</span><span class="r16">                   </span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> max_depth </span><span class="r19">==</span><span class="r14"> </span><span class="r19">0</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;{...}&#x27;</span><span class="r16">                        </span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                     </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> collapse_single </span><span class="r29">and</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(obj) </span><span class="r19">==</span><span class="r14"> </span><span class="r19">1</span><span class="r14">:</span><span class="r16"> </span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                new_depth </span><span class="r19">=</span><span class="r14"> max_depth</span><span class="r16">             </span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                 </span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                new_depth </span><span class="r19">=</span><span class="r14"> max_depth </span><span class="r19">-</span><span class="r14"> </span><span class="r19">1</span><span class="r16">         </span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            excluded </span><span class="r19">=</span><span class="r14"> ((</span><span class="r18">&#x27;parent&#x27;</span><span class="r14">, </span><span class="r13">None</span><span class="r14">), (</span><span class="r18">&#x27;name&#x27;</span><span class="r14">,</span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">return</span><span class="r14"> {</span><span class="r16">                              </span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                k: tree_traverse(visitor, v, new_d</span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> obj</span><span class="r19">.</span><span class="r14">items()</span><span class="r16">           </span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r13">if</span><span class="r14"> (k, v) </span><span class="r29">not</span><span class="r14"> </span><span class="r29">in</span><span class="r14"> excluded</span><span class="r16">         </span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            }</span><span class="r16">                                     </span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> is_dataclass(obj):</span><span class="r16">                       </span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r23"># print(type(obj), obj)</span><span class="r16">                   </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> {obj</span><span class="r19">.</span><span class="r30">__class__</span><span class="r19">.</span><span class="r30">__name__</span><span class="r14">: tree_trave</span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">elif</span><span class="r14"> obj </span><span class="r29">is</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                             </span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27;None&#x27;</span><span class="r16">                             </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">else</span><span class="r14">:</span><span class="r16">                                         </span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        name </span><span class="r19">=</span><span class="r14"> </span><span class="r17">getattr</span><span class="r14">(obj, </span><span class="r18">&#x27;__name__&#x27;</span><span class="r14">, </span><span class="r18">&#x27;|&#x27;</span><span class="r14">)</span><span class="r16">      </span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">obj</span><span class="r19">.</span><span class="r30">__class__</span><span class="r19">.</span><span class="r30">__name__</span><span class="r25">}</span><span class="r18">=</span><span class="r25">{</span><span class="r14">name</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r16"> </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">show_obj</span><span class="r14">(obj):</span><span class="r16">                                </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># print_json(data=obj)</span><span class="r16">                        </span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> k, v </span><span class="r29">in</span><span class="r14"> obj</span><span class="r19">.</span><span class="r14">items():</span><span class="r16">                      </span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tree </span><span class="r19">=</span><span class="r14"> Tree(label</span><span class="r19">=</span><span class="r14">k, style</span><span class="r19">=</span><span class="r14">STYLES[</span><span class="r19">0</span><span class="r14">])</span><span class="r16">     </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        tree_from_dict(tree, v)</span><span class="r16">                   </span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  17%  </span>│<span class="r1">   20M </span>│<span class="r1">▁▁             </span>│<span class="r12">     1 </span>│<span class="r14">        rich</span><span class="r19">.</span><span class="r14">print(tree)</span><span class="r16">                          </span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">_debug_structure</span><span class="r14">(tree_depth</span><span class="r19">=5</span><span class="r14">, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">     </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Prints out the structure of the inputs.&quot;&quot;&quot;</span><span class="r16"> </span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    show_obj({</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">k</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">: tree_traverse(StructureVisit</span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">_debug_stat</span><span class="r14">(tree_depth</span><span class="r19">=5</span><span class="r14">, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">          </span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Prints out a reduction of the inputs. Is al</span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    show_obj({</span><span class="r18">f&#x27;</span><span class="r25">{</span><span class="r14">k</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">: tree_traverse(StatsVisitor()</span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">debug_structure</span><span class="r14">(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">             </span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Prints out the structure of the inputs. Ret</span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    new_kwargs </span><span class="r19">=</span><span class="r14"> {</span><span class="r18">f&#x27;arg</span><span class="r25">{</span><span class="r14">i</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">: arg </span><span class="r13">for</span><span class="r14"> i, arg </span><span class="r29">in</span><span class="r14"> </span><span class="r17">enu</span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    new_kwargs</span><span class="r19">.</span><span class="r14">update(</span><span class="r19">**</span><span class="r14">kwargs)</span><span class="r16">                   </span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    jax</span><span class="r19">.</span><span class="r14">debug</span><span class="r19">.</span><span class="r14">callback(_debug_structure, </span><span class="r19">**</span><span class="r14">new_kwa</span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(new_kwargs</span><span class="r19">.</span><span class="r14">values())[</span><span class="r19">0</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">debug_stat</span><span class="r14">(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs):</span><span class="r16">                  </span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">    </span><span class="r28">&quot;&quot;&quot;Prints out a reduction of the inputs. Is al</span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    new_kwargs </span><span class="r19">=</span><span class="r14"> {</span><span class="r18">f&#x27;arg</span><span class="r25">{</span><span class="r14">i</span><span class="r25">}</span><span class="r18">&#x27;</span><span class="r14">: arg </span><span class="r13">for</span><span class="r14"> i, arg </span><span class="r29">in</span><span class="r14"> </span><span class="r17">enu</span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    new_kwargs</span><span class="r19">.</span><span class="r14">update(</span><span class="r19">**</span><span class="r14">kwargs)</span><span class="r16">                   </span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    jax</span><span class="r19">.</span><span class="r14">debug</span><span class="r19">.</span><span class="r14">callback(_debug_stat, </span><span class="r19">**</span><span class="r14">new_kwargs)</span><span class="r16"> </span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r17">list</span><span class="r14">(new_kwargs</span><span class="r19">.</span><span class="r14">values())[</span><span class="r19">0</span><span class="r14">]</span><span class="r16">           </span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">flax_summary</span><span class="r14">(</span><span class="r16">                                 </span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    mod: nn</span><span class="r19">.</span><span class="r14">Module,</span><span class="r16">                               </span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    rngs</span><span class="r19">=</span><span class="r14">{},</span><span class="r16">                                      </span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19">*</span><span class="r14">args,</span><span class="r16">                                        </span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    compute_flops</span><span class="r19">=</span><span class="r13">True</span><span class="r14">,</span><span class="r16">                           </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    compute_vjp_flops</span><span class="r19">=</span><span class="r13">True</span><span class="r14">,</span><span class="r16">                       </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    console_kwargs</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                          </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    table_kwargs</span><span class="r19">=</span><span class="r14">MappingProxyType({</span><span class="r18">&#x27;safe_box&#x27;</span><span class="r14">: </span><span class="r13">Fal</span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    column_kwargs</span><span class="r19">=</span><span class="r14">MappingProxyType({</span><span class="r18">&#x27;justify&#x27;</span><span class="r14">: </span><span class="r18">&#x27;ri</span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    show_repeated</span><span class="r19">=</span><span class="r13">False</span><span class="r14">,</span><span class="r16">                          </span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    depth</span><span class="r19">=</span><span class="r13">None</span><span class="r14">,</span><span class="r16">                                   </span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    colorize</span><span class="r19">=</span><span class="r13">True</span><span class="r14">,</span><span class="r16">                                </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19">**</span><span class="r14">kwargs,</span><span class="r16">                                     </span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">):</span><span class="r16">                                                </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r19">=</span><span class="r14"> mod</span><span class="r19">.</span><span class="r14">tabulate(</span><span class="r16">                           </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17">dict</span><span class="r14">(params</span><span class="r19">=</span><span class="r14">jax</span><span class="r19">.</span><span class="r14">random</span><span class="r19">.</span><span class="r14">key(</span><span class="r19">0</span><span class="r14">), </span><span class="r19">**</span><span class="r14">rngs),</span><span class="r16">   </span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">*</span><span class="r14">args,</span><span class="r16">                                    </span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        compute_flops</span><span class="r19">=</span><span class="r14">compute_flops,</span><span class="r16">              </span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        compute_vjp_flops</span><span class="r19">=</span><span class="r14">compute_vjp_flops,</span><span class="r16">      </span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        console_kwargs</span><span class="r19">=</span><span class="r14">console_kwargs,</span><span class="r16">            </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        table_kwargs</span><span class="r19">=</span><span class="r14">table_kwargs,</span><span class="r16">                </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        column_kwargs</span><span class="r19">=</span><span class="r14">column_kwargs,</span><span class="r16">              </span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        show_repeated</span><span class="r19">=</span><span class="r14">show_repeated,</span><span class="r16">              </span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        depth</span><span class="r19">=</span><span class="r14">depth,</span><span class="r16">                              </span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19">**</span><span class="r14">kwargs,</span><span class="r16">                                 </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    )</span><span class="r16">                                             </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  355 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># hack to control numbers so they&#x27;re formatted</span>  
 <span class="r10">  356 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r23"># 12580739072 flops is not very helpful</span><span class="r16">       </span>  
 <span class="r10">  357 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  358 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_color_i </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(INFERNA) </span><span class="r19">-</span><span class="r14"> </span><span class="r19">1</span><span class="r16">                </span>  
 <span class="r10">  359 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  360 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    nums </span><span class="r19">=</span><span class="r14"> re</span><span class="r19">.</span><span class="r14">findall(</span><span class="r18">r&#x27;\d&#x27;</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> </span><span class="r19">4</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> </span><span class="r18">&#x27;+&#x27;</span><span class="r14">, out)</span><span class="r16">       </span>  
 <span class="r10">  361 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    color_max </span><span class="r19">=</span><span class="r14"> </span><span class="r17">max</span><span class="r14">(</span><span class="r17">len</span><span class="r14">(n) </span><span class="r13">for</span><span class="r14"> n </span><span class="r29">in</span><span class="r14"> nums) </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r16">     </span>  
 <span class="r10">  362 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  363 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">_colorize</span><span class="r14">(m: re</span><span class="r19">.</span><span class="r14">Match):</span><span class="r16">                   </span>  
 <span class="r10">  364 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        s </span><span class="r19">=</span><span class="r14"> m</span><span class="r19">.</span><span class="r14">group(</span><span class="r19">0</span><span class="r14">)</span><span class="r16">                            </span>  
 <span class="r10">  365 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  366 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        n </span><span class="r19">=</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(s</span><span class="r19">.</span><span class="r14">strip())</span><span class="r16">                        </span>  
 <span class="r10">  367 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        e </span><span class="r19">=</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">log10(np</span><span class="r19">.</span><span class="r14">abs(n) </span><span class="r19">+</span><span class="r14"> </span><span class="r19">1</span><span class="r14">)</span><span class="r16">               </span>  
 <span class="r10">  368 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  369 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        color_i </span><span class="r19">=</span><span class="r14"> </span><span class="r17">int</span><span class="r14">(</span><span class="r17">round</span><span class="r14">(max_color_i </span><span class="r19">*</span><span class="r14"> np</span><span class="r19">.</span><span class="r14">clip(</span>  
 <span class="r10">  370 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  371 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        color </span><span class="r19">=</span><span class="r14"> INFERNA[color_i]</span><span class="r16">                  </span>  
 <span class="r10">  372 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        t </span><span class="r19">=</span><span class="r14"> Text(s</span><span class="r19">.</span><span class="r14">strip(), style</span><span class="r19">=</span><span class="r14">Style(color</span><span class="r19">=</span><span class="r14">colo</span>  
 <span class="r10">  373 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        f </span><span class="r19">=</span><span class="r14"> io</span><span class="r19">.</span><span class="r14">StringIO()</span><span class="r16">                         </span>  
 <span class="r10">  374 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        console </span><span class="r19">=</span><span class="r14"> rich</span><span class="r19">.</span><span class="r14">console</span><span class="r19">.</span><span class="r14">Console(</span><span class="r16">           </span>  
 <span class="r10">  375 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            file</span><span class="r19">=</span><span class="r14">f, color_system</span><span class="r19">=</span><span class="r14">rich</span><span class="r19">.</span><span class="r14">console</span><span class="r19">.</span><span class="r14">Cons</span>  
 <span class="r10">  376 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r16">                                         </span>  
 <span class="r10">  377 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        console</span><span class="r19">.</span><span class="r14">print(t, end</span><span class="r19">=</span><span class="r18">&#x27;&#x27;</span><span class="r14">)</span><span class="r16">                  </span>  
 <span class="r10">  378 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> f</span><span class="r19">.</span><span class="r14">getvalue()</span><span class="r16">                       </span>  
 <span class="r10">  379 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  380 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">def</span><span class="r14"> </span><span class="r24">human_units</span><span class="r14">(m: re</span><span class="r19">.</span><span class="r14">Match):</span><span class="r16">                 </span>  
 <span class="r10">  381 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">        </span><span class="r28">&quot;&quot;&quot;Format using units, preserving the leng</span>  
 <span class="r10">  382 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        human </span><span class="r19">=</span><span class="r14"> humanize</span><span class="r19">.</span><span class="r14">metric(</span><span class="r17">int</span><span class="r14">(m</span><span class="r19">.</span><span class="r14">group(</span><span class="r19">0</span><span class="r14">)))</span><span class="r19">.</span><span class="r14">r</span>  
 <span class="r10">  383 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        pad_num </span><span class="r19">=</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(m</span><span class="r19">.</span><span class="r14">group(</span><span class="r19">0</span><span class="r14">)) </span><span class="r19">-</span><span class="r14"> </span><span class="r17">len</span><span class="r14">(human)</span><span class="r16">    </span>  
 <span class="r10">  384 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r18">&#x27; &#x27;</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> pad_num </span><span class="r19">+</span><span class="r14"> human</span><span class="r16">              </span>  
 <span class="r10">  385 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  386 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> colorize:</span><span class="r16">                                  </span>  
 <span class="r10">  387 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r19">=</span><span class="r14"> re</span><span class="r19">.</span><span class="r14">sub(</span><span class="r18">r&#x27;\d&#x27;</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> </span><span class="r19">4</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> </span><span class="r18">&#x27;+&#x27;</span><span class="r14">, _colorize, o</span>  
 <span class="r10">  388 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r19">=</span><span class="r14"> re</span><span class="r19">.</span><span class="r14">sub(</span><span class="r18">r&#x27;\d&#x27;</span><span class="r14"> </span><span class="r19">*</span><span class="r14"> </span><span class="r19">6</span><span class="r14"> </span><span class="r19">+</span><span class="r14"> </span><span class="r18">&#x27;+&#x27;</span><span class="r14">, human_units, out</span>  
 <span class="r10">  389 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  390 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17">print</span><span class="r14">(out)</span><span class="r16">                                    </span>  
 <span class="r10">  391 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                    </span>  
 <span class="r10">  392 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  393 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  394 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">callable_name</span><span class="r14">(any_callable: Callable[</span><span class="r19">...</span><span class="r14">, Any]</span>  
 <span class="r10">  395 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">isinstance</span><span class="r14">(any_callable, partial):</span><span class="r16">         </span>  
 <span class="r10">  396 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> any_callable</span><span class="r19">.</span><span class="r14">func</span><span class="r19">.</span><span class="r30">__qualname__</span><span class="r16">     </span>  
 <span class="r10">  397 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  398 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">try</span><span class="r14">:</span><span class="r16">                                          </span>  
 <span class="r10">  399 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> any_callable</span><span class="r19">.</span><span class="r30">__qualname__</span><span class="r16">          </span>  
 <span class="r10">  400 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">except</span><span class="r14"> </span><span class="r26">AttributeError</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  401 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">str</span><span class="r14">(any_callable)</span><span class="r16">                  </span>  
 <span class="r10">  402 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  403 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  404 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r24">intercept_stat</span><span class="r14">(next_fun, args, kwargs, context</span>  
 <span class="r10">  405 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    sig </span><span class="r19">=</span><span class="r14"> signature(next_fun)</span><span class="r16">                     </span>  
 <span class="r10">  406 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    bound </span><span class="r19">=</span><span class="r14"> sig</span><span class="r19">.</span><span class="r14">bind(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs)</span><span class="r16">             </span>  
 <span class="r10">  407 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    has_printed </span><span class="r19">=</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                           </span>  
 <span class="r10">  408 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> name, val </span><span class="r29">in</span><span class="r14"> bound</span><span class="r19">.</span><span class="r14">arguments</span><span class="r19">.</span><span class="r14">items():</span><span class="r16">     </span>  
 <span class="r10">  409 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">if</span><span class="r14"> </span><span class="r17">hasattr</span><span class="r14">(val, </span><span class="r18">&#x27;shape&#x27;</span><span class="r14">):</span><span class="r16">                 </span>  
 <span class="r10">  410 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> </span><span class="r29">not</span><span class="r14"> has_printed:</span><span class="r16">                   </span>  
 <span class="r10">  411 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">print</span><span class="r14">()</span><span class="r16">                           </span>  
 <span class="r10">  412 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">print</span><span class="r14">(context</span><span class="r19">.</span><span class="r14">module</span><span class="r19">.</span><span class="r14">name)</span><span class="r16">        </span>  
 <span class="r10">  413 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17">print</span><span class="r14">(callable_name(next_fun))</span><span class="r16">    </span>  
 <span class="r10">  414 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                has_printed </span><span class="r19">=</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                </span>  
 <span class="r10">  415 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            debug_stat(</span><span class="r19">**</span><span class="r14">{name: val})</span><span class="r16">             </span>  
 <span class="r10">  416 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  417 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r19">=</span><span class="r14"> next_fun(</span><span class="r19">*</span><span class="r14">args, </span><span class="r19">**</span><span class="r14">kwargs)</span><span class="r16">               </span>  
 <span class="r10">  418 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r17">hasattr</span><span class="r14">(out, </span><span class="r18">&#x27;shape&#x27;</span><span class="r14">):</span><span class="r16">                     </span>  
 <span class="r10">  419 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        debug_stat(</span><span class="r19">**</span><span class="r14">{callable_name(next_fun) </span><span class="r19">+</span><span class="r14"> </span><span class="r18">&#x27; </span>  
 <span class="r10">  420 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">  421 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                    </span>  
 <span class="r10">  422 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)   211:    30 MB</span>                                                                                                                 
<span class="r1">(2)   299:    20 MB</span>                                                                                                                 
<span class="r1">(3)    24:    10 MB</span>                                                                                                                 
generated by the <a class="r31" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</code></pre>
</body>
</html>
